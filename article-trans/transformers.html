<!DOCTYPE html>

<html class="transition" data-theme="light" data-theme-setting="system" lang="zh-CN">
<head><link href="https://giscus.app/default.css" id="giscus-css" rel="stylesheet"/><style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:20px;margin:11px auto 0;width:20px}#back-to-top.hidden{bottom:-56px;opacity:0}</style> <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/> <meta charset="utf-8"/> <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/> <meta content="IE=edge" http-equiv="X-UA-Compatible"/> <title>æ‚¨éœ€è¦äº†è§£çš„æ‰€æœ‰ Transformer æ•°å­¦çŸ¥è¯† | å¦‚ä½•æ‰©å±•æ‚¨çš„æ¨¡å‹</title> <meta content=" " name="author"/> <meta content="æœ¬æ–‡å°†å¿«é€Ÿå›é¡¾ Transformer æ¶æ„ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•è®¡ç®— FLOPsã€å­—èŠ‚æ•°ä»¥åŠå…¶ä»–æ„Ÿå…´è¶£çš„é‡ã€‚" name="description"/> <meta content="scaling, jax, llms, transformers, tpus, google, deepmind, parallelism, pallas" name="keywords"/> <link href="https://jax-ml.github.io/scaling-book/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04" rel="stylesheet"/> <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" rel="stylesheet"/> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5" rel="stylesheet"/> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772" rel="stylesheet"/> <link defer="" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap" rel="stylesheet" type="text/css"/> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/jekyll-pygments-themes-vs.css?4ee1a2facd1a8a76347f4bd43a740500" id="highlight_theme_light" media="" rel="stylesheet"/> <link href="https://jax-ml.github.io/scaling-book/assets/img/favicon.png?fddbd8c2ec231ba2060e67c85de32a55" rel="shortcut icon"/> <link href="https://jax-ml.github.io/scaling-book/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e" rel="stylesheet"/> <link href="transformers.html" rel="canonical"/> <style id="distill-prerendered-styles" type="text/css">/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

html {
  font-size: 14px;
	line-height: 1.6em;
  /* font-family: "Libre Franklin", "Helvetica Neue", sans-serif; */
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  /*, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";*/
  text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
}

@media(min-width: 768px) {
  html {
    font-size: 16px;
  }
}

body {
  margin: 0;
}

a {
  color: #004276;
}

figure {
  margin: 0;
}

table {
	border-collapse: collapse;
	border-spacing: 0;
}

table th {
	text-align: left;
}

table thead {
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

table thead th {
  padding-bottom: 0.5em;
}

table tbody :first-child td {
  padding-top: 0.5em;
}

pre {
  overflow: auto;
  max-width: 100%;
}

p {
  margin-top: 0;
  margin-bottom: 1em;
}

sup, sub {
  vertical-align: baseline;
  position: relative;
  top: -0.4em;
  line-height: 1em;
}

sub {
  top: 0.4em;
}

.kicker,
.marker {
  font-size: 15px;
  font-weight: 600;
  color: rgba(0, 0, 0, 0.5);
}


/* Headline */

@media(min-width: 1024px) {
  d-title h1 span {
    display: block;
  }
}

/* Figure */

figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

figcaption+figure {

}

figure img {
  width: 100%;
}

figure svg text,
figure svg tspan {
}

figcaption,
.figcaption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

@media(min-width: 1024px) {
figcaption,
.figcaption {
    font-size: 13px;
  }
}

figure.external img {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

figcaption a {
  color: rgba(0, 0, 0, 0.6);
}

figcaption b,
figcaption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

@supports not (display: grid) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    display: block;
    padding: 8px;
  }
}

.base-grid,
distill-header,
d-title,
d-abstract,
d-article,
d-appendix,
distill-appendix,
d-byline,
d-footnote-list,
d-citation-list,
distill-footer {
  display: grid;
  justify-items: stretch;
  grid-template-columns: [screen-start] 8px [page-start kicker-start text-start gutter-start middle-start] 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr [text-end page-end gutter-end kicker-end middle-end] 8px [screen-end];
  grid-column-gap: 8px;
}

.grid {
  display: grid;
  grid-column-gap: 8px;
}

@media(min-width: 768px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start middle-start text-start] 45px 45px 45px 45px 45px 45px 45px 45px [ kicker-end text-end gutter-start] 45px [middle-end] 45px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }
}

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 50px [middle-start] 50px [text-start kicker-end] 50px 50px 50px 50px 50px 50px 50px 50px [text-end gutter-start] 50px [middle-end] 50px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}




.base-grid {
  grid-column: screen;
}

/* .l-body,
d-article > *  {
  grid-column: text;
}

.l-page,
d-title > *,
d-figure {
  grid-column: page;
} */

.l-gutter {
  grid-column: gutter;
}

.l-text,
.l-body {
  grid-column: text;
}

.l-page {
  grid-column: page;
}

.l-body-outset {
  grid-column: middle;
}

.l-page-outset {
  grid-column: page;
}

.l-screen {
  grid-column: screen;
}

.l-screen-inset {
  grid-column: screen;
  padding-left: 16px;
  padding-left: 16px;
}


/* Aside */

d-article aside {
  grid-column: gutter;
  font-size: 12px;
  line-height: 1.6em;
  color: rgba(0, 0, 0, 0.6)
}

@media(min-width: 768px) {
  aside {
    grid-column: gutter;
  }

  .side {
    grid-column: gutter;
  }
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

d-title {
  padding: 2rem 0 1.5rem;
  contain: layout style;
  overflow-x: hidden;
}

@media(min-width: 768px) {
  d-title {
    padding: 4rem 0 1.5rem;
  }
}

d-title h1 {
  grid-column: text;
  font-size: 40px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

@media(min-width: 768px) {
  d-title h1 {
    font-size: 50px;
  }
}

d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  grid-column: text;
}

d-title .status {
  margin-top: 0px;
  font-size: 12px;
  color: #009688;
  opacity: 0.8;
  grid-column: kicker;
}

d-title .status span {
  line-height: 1;
  display: inline-block;
  padding: 6px 0;
  border-bottom: 1px solid #80cbc4;
  font-size: 11px;
  text-transform: uppercase;
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

d-byline {
  contain: style;
  overflow: hidden;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  font-size: 0.8rem;
  line-height: 1.8em;
  padding: 1.5rem 0;
  min-height: 1.8em;
}


d-byline .byline {
  grid-template-columns: 1fr 1fr;
  grid-column: text;
}

@media(min-width: 768px) {
  d-byline .byline {
    grid-template-columns: 1fr 1fr 1fr 1fr;
  }
}

d-byline .authors-affiliations {
  grid-column-end: span 3;
  grid-template-columns: 1fr 1fr 1fr;
  margin-bottom: 1em;
}

@media(min-width: 768px) {
  d-byline .authors-affiliations {
    margin-bottom: 0;
  }
}

d-byline h3 {
  font-size: 0.6rem;
  font-weight: 400;
  color: rgba(0, 0, 0, 0.5);
  margin: 0;
  text-transform: uppercase;
}

d-byline p {
  margin: 0;
}

d-byline a,
d-article d-byline a {
  color: rgba(0, 0, 0, 0.8);
  text-decoration: none;
  border-bottom: none;
}

d-article d-byline a:hover {
  text-decoration: underline;
  border-bottom: none;
}

d-byline p.author {
  font-weight: 500;
}

d-byline .affiliations {

}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

d-article {
  contain: layout style;
 border-top: 1px solid rgba(0, 0, 0, 0.1);
  padding-top: 2rem;
  color: rgba(0, 0, 0, 0.8);
}

d-article > * {
  grid-column: text;
}

@media(min-width: 768px) {
  d-article {
    font-size: 16px;
  }
}

@media(min-width: 1024px) {
  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
}


/* H2 */


d-article .marker {
  text-decoration: none;
  border: none;
  counter-reset: section;
  grid-column: kicker;
  line-height: 1.7em;
}

d-article .marker:hover {
  border: none;
}

d-article .marker span {
  padding: 0 3px 4px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  position: relative;
  top: 4px;
}

d-article .marker:hover span {
  color: rgba(0, 0, 0, 0.7);
  border-bottom: 1px solid rgba(0, 0, 0, 0.7);
}

d-article h2 {
  font-weight: 600;
  font-size: 24px;
  line-height: 1.25em;
  margin: 2rem 0 1.5rem 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding-bottom: 1rem;
}

@media(min-width: 1024px) {
  d-article h2 {
    font-size: 36px;
  }
}

/* H3 */

d-article h3 {
  font-weight: 700;
  font-size: 18px;
  line-height: 1.4em;
  margin-bottom: 1em;
  margin-top: 2em;
}

@media(min-width: 1024px) {
  d-article h3 {
    font-size: 20px;
  }
}

/* H4 */

d-article h4 {
  font-weight: 600;
  text-transform: uppercase;
  font-size: 14px;
  line-height: 1.4em;
}

d-article a {
  color: inherit;
}

d-article p,
d-article ul,
d-article ol,
d-article blockquote {
  margin-top: 0;
  margin-bottom: 1em;
  margin-left: 0;
  margin-right: 0;
}

d-article blockquote {
  border-left: 2px solid rgba(0, 0, 0, 0.2);
  padding-left: 2em;
  font-style: italic;
  color: rgba(0, 0, 0, 0.6);
}

d-article a {
  border-bottom: 1px solid var(--global-underline-color);
  text-decoration: none;
}

d-article a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.8);
}

d-article .link {
  text-decoration: underline;
  cursor: pointer;
}

d-article ul,
d-article ol {
  padding-left: 24px;
}

d-article li {
  margin-bottom: 1em;
  margin-left: 0;
  padding-left: 0;
}

d-article li:last-child {
  margin-bottom: 0;
}

d-article pre {
  font-size: 14px;
  margin-bottom: 20px;
}

d-article hr {
  grid-column: screen;
  width: 100%;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  margin-top: 60px;
  margin-bottom: 60px;
}

d-article section {
  margin-top: 60px;
  margin-bottom: 60px;
}

d-article span.equation-mimic {
  font-family: georgia;
  font-size: 115%;
  font-style: italic;
}

d-article > d-code,
d-article section > d-code  {
  display: block;
}

d-article > d-math[block],
d-article section > d-math[block]  {
  display: block;
}

@media (max-width: 768px) {
  d-article > d-code,
  d-article section > d-code,
  d-article > d-math[block],
  d-article section > d-math[block] {
      overflow-x: scroll;
      -ms-overflow-style: none;  // IE 10+
      overflow: -moz-scrollbars-none;  // Firefox
  }

  d-article > d-code::-webkit-scrollbar,
  d-article section > d-code::-webkit-scrollbar,
  d-article > d-math[block]::-webkit-scrollbar,
  d-article section > d-math[block]::-webkit-scrollbar {
    display: none;  // Safari and Chrome
  }
}

d-article .citation {
  color: #668;
  cursor: pointer;
}

d-include {
  width: auto;
  display: block;
}

d-figure {
  contain: layout style;
}

/* KaTeX */

.katex, .katex-prerendered {
  contain: style;
  display: inline-block;
}

/* Tables */

d-article table {
  border-collapse: collapse;
  margin-bottom: 1.5rem;
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
}

d-article table th {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
}

d-article table td {
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

d-article table tr:last-of-type td {
  border-bottom: none;
}

d-article table th,
d-article table td {
  font-size: 15px;
  padding: 2px 8px;
}

d-article table tbody :first-child td {
  padding-top: 2px;
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

span.katex-display {
  text-align: left;
  padding: 8px 0 8px 0;
  margin: 0.5em 0 0.5em 1em;
}

span.katex {
  -webkit-font-smoothing: antialiased;
;
  font-size: 1.18em;
}

/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

@media print {

  @page {
    size: 8in 11in;
    @bottom-right {
      content: counter(page) " of " counter(pages);
    }
  }

  html {
    /* no general margins -- CSS Grid takes care of those */
  }

  p, code {
    page-break-inside: avoid;
  }

  h2, h3 {
    page-break-after: avoid;
  }

  d-header {
    visibility: hidden;
  }

  d-footer {
    display: none!important;
  }

}
</style><script src="https://jax-ml.github.io/scaling-book/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" id="highlight_theme_dark" media="none" rel="stylesheet"/> <script>
    initTheme();
  </script> <script src="https://jax-ml.github.io/scaling-book/assets/js/distillpub/template.v2.js"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/distillpub/transforms.v2.js"></script> <style type="text/css">{{page._styles}}</style> <style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">.medium-zoom-overlay{position:fixed;top:0;right:0;bottom:0;left:0;opacity:0;transition:opacity .3s;will-change:opacity}.medium-zoom--opened .medium-zoom-overlay{cursor:pointer;cursor:zoom-out;opacity:1}.medium-zoom-image{cursor:pointer;cursor:zoom-in;transition:transform .3s cubic-bezier(.2,0,.2,1)!important}.medium-zoom-image--hidden{visibility:hidden}.medium-zoom-image--opened{position:relative;cursor:pointer;cursor:zoom-out;will-change:transform}</style><style type="text/css">.CtxtMenu_InfoClose {  top:.2em; right:.2em;}
.CtxtMenu_InfoContent {  overflow:auto; text-align:left; font-size:80%;  padding:.4em .6em; border:1px inset; margin:1em 0px;  max-height:20em; max-width:30em; background-color:#EEEEEE;  white-space:normal;}
.CtxtMenu_Info.CtxtMenu_MousePost {outline:none;}
.CtxtMenu_Info {  position:fixed; left:50%; width:auto; text-align:center;  border:3px outset; padding:1em 2em; background-color:#DDDDDD;  color:black;  cursor:default; font-family:message-box; font-size:120%;  font-style:normal; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 15px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius:15px;               /* Safari and Chrome */  -moz-border-radius:15px;                  /* Firefox */  -khtml-border-radius:15px;                /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */  filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color="gray", Positive="true"); /* IE */}
</style><style type="text/css">.CtxtMenu_MenuClose {  position:absolute;  cursor:pointer;  display:inline-block;  border:2px solid #AAA;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  font-family: "Courier New", Courier;  font-size:24px;  color:#F0F0F0}
.CtxtMenu_MenuClose span {  display:block; background-color:#AAA; border:1.5px solid;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  line-height:0;  padding:8px 0 6px     /* may need to be browser-specific */}
.CtxtMenu_MenuClose:hover {  color:white!important;  border:2px solid #CCC!important}
.CtxtMenu_MenuClose:hover span {  background-color:#CCC!important}
.CtxtMenu_MenuClose:hover:focus {  outline:none}
</style><style type="text/css">.CtxtMenu_Menu {  position:absolute;  background-color:white;  color:black;  width:auto; padding:5px 0px;  border:1px solid #CCCCCC; margin:0; cursor:default;  font: menu; text-align:left; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 5px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius: 5px;             /* Safari and Chrome */  -moz-border-radius: 5px;                /* Firefox */  -khtml-border-radius: 5px;              /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */}
.CtxtMenu_MenuItem {  padding: 1px 2em;  background:transparent;}
.CtxtMenu_MenuArrow {  position:absolute; right:.5em; padding-top:.25em; color:#666666;  font-family: null; font-size: .75em}
.CtxtMenu_MenuActive .CtxtMenu_MenuArrow {color:white}
.CtxtMenu_MenuArrow.CtxtMenu_RTL {left:.5em; right:auto}
.CtxtMenu_MenuCheck {  position:absolute; left:.7em;  font-family: null}
.CtxtMenu_MenuCheck.CtxtMenu_RTL { right:.7em; left:auto }
.CtxtMenu_MenuRadioCheck {  position:absolute; left: .7em;}
.CtxtMenu_MenuRadioCheck.CtxtMenu_RTL {  right: .7em; left:auto}
.CtxtMenu_MenuInputBox {  padding-left: 1em; right:.5em; color:#666666;  font-family: null;}
.CtxtMenu_MenuInputBox.CtxtMenu_RTL {  left: .1em;}
.CtxtMenu_MenuComboBox {  left:.1em; padding-bottom:.5em;}
.CtxtMenu_MenuSlider {  left: .1em;}
.CtxtMenu_SliderValue {  position:absolute; right:.1em; padding-top:.25em; color:#333333;  font-size: .75em}
.CtxtMenu_SliderBar {  outline: none; background: #d3d3d3}
.CtxtMenu_MenuLabel {  padding: 1px 2em 3px 1.33em;  font-style:italic}
.CtxtMenu_MenuRule {  border-top: 1px solid #DDDDDD;  margin: 4px 3px;}
.CtxtMenu_MenuDisabled {  color:GrayText}
.CtxtMenu_MenuActive {  background-color: #606872;  color: white;}
.CtxtMenu_MenuDisabled:focus {  background-color: #E8E8E8}
.CtxtMenu_MenuLabel:focus {  background-color: #E8E8E8}
.CtxtMenu_ContextMenu:focus {  outline:none}
.CtxtMenu_ContextMenu .CtxtMenu_MenuItem:focus {  outline:none}
.CtxtMenu_SelectionMenu {  position:relative; float:left;  border-bottom: none; -webkit-box-shadow:none; -webkit-border-radius:0px; }
.CtxtMenu_SelectionItem {  padding-right: 1em;}
.CtxtMenu_Selection {  right: 40%; width:50%; }
.CtxtMenu_SelectionBox {  padding: 0em; max-height:20em; max-width: none;  background-color:#FFFFFF;}
.CtxtMenu_SelectionDivider {  clear: both; border-top: 2px solid #000000;}
.CtxtMenu_Menu .CtxtMenu_MenuClose {  top:-10px; left:-10px}
</style><script charset="UTF-8" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/input/tex/extensions/color.js"></script><link crossorigin="anonymous" href="https://distill.pub/third-party/katex/katex.min.css" rel="stylesheet"/><script async="" src="https://distill.pub/third-party/katex/katex.min.js"></script></head>
<body> <d-front-matter> <script async="" type="text/json">
      {
            "title": "ä½ éœ€è¦çŸ¥é“çš„æ‰€æœ‰Transformeræ•°å­¦çŸ¥è¯†",
            "description": "åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†å¿«é€Ÿå›é¡¾Transformeræ¶æ„ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•è®¡ç®—FLOPsã€å­—èŠ‚æ•°å’Œå…¶ä»–æ„Ÿå…´è¶£çš„é‡ã€‚",
            "published": "February 04, 2025",
            "authors": [

              {
                "author": "Jacob Austin",
                "authorURL": "https://www.jacobaustin.org/",
                "affiliations": [
                  {
                    "name": "Google DeepMind",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Sholto Douglas",
                "authorURL": "https://x.com/_sholtodouglas",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Roy Frostig",
                "authorURL": "https://cs.stanford.edu/~rfrostig/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Anselm Levskaya",
                "authorURL": "https://anselmlevskaya.com/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Charlie Chen",
                "authorURL": "https://x.com/charliexychen",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Sharad Vikram",
                "authorURL": "https://sharadvikram.com/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Federico Lebron",
                "authorURL": "https://fedelebron.com/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Peter Choy",
                "authorURL": "https://x.com/pchoy95",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Vinay Ramasesh",
                "authorURL": "https://x.com/vinayramasesh",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Albert Webson",
                "authorURL": "https://representation.ai/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Reiner Pope<sup>*</sup>",
                "authorURL": "https://x.com/reinerpope",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              }

            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <script>
    function goToTop() {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    }

    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function() {scrollFunction()};

    function scrollFunction() {
      // Get the button:
      let mybutton = document.getElementById("top-button");

      if (document.body.scrollTop > 40 || document.documentElement.scrollTop > 40) {
        mybutton.style.display = "block";
      } else {
        mybutton.style.display = "none";
      }
  }
  </script> <nav class="navbar navbar-light navbar-expand-sm fixed-top" id="navbar" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="scaling-book.html"> å¦‚ä½•æ‰©å±•ä½ çš„æ¨¡å‹ </a> <button aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler collapsed ml-auto" data-target="#navbarNav" data-toggle="collapse" type="button"> <span class="sr-only">åˆ‡æ¢å¯¼èˆª</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="left-button section-button"><a href="sharding.html"><svg viewbox="-78.5 0 512 512"><path d="M257 64L291 98 128 262 291 426 257 460 61 262 257 64Z"></path></svg></a></div> <div class="right-button section-button"><a href="training.html"><svg viewbox="-78.5 0 512 512"><path d="M98 460L64 426 227 262 64 98 98 64 294 262 98 460Z"></path></svg></a></div> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item"> <a class="nav-link" href="scaling-book.html"> </a> </li> <li class="nav-item nav-hidden"><a class="nav-link" id="top-button" onclick="goToTop()" style="display: none;">è¿”å›é¡¶éƒ¨</a></li> <li class="nav-item nav-hidden"><p class="nav-link"></p></li> <li class="nav-item nav-hidden"><a class="nav-link" href="sharding.html">ä¸Šä¸€éƒ¨åˆ†</a></li> <li class="nav-item nav-hidden"><a class="nav-link" href="training.html">ä¸‹ä¸€éƒ¨åˆ†</a></li> <li class="nav-item nav-hidden"><p class="nav-link"></p></li> <li class="nav-item dropdown"> <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="navbarDropdown" role="button">ç« èŠ‚ </a> <div aria-labelledby="navbarDropdown" class="dropdown-menu dropdown-menu-right"> <a class="dropdown-item" href="https://jax-ml.github.io/scaling-book/index">ç¬¬0éƒ¨åˆ†ï¼šå¼•è¨€</a> <a class="dropdown-item" href="roofline.html">ç¬¬1éƒ¨åˆ†ï¼šå±‹é¡¶çº¿æ¨¡å‹ç®€ä»‹</a> <a class="dropdown-item" href="tpus.html">ç¬¬2éƒ¨åˆ†ï¼šå…³äºTPUçš„ä¸€åˆ‡</a> <a class="dropdown-item" href="sharding.html">ç¬¬3éƒ¨åˆ†ï¼šåˆ†ç‰‡çŸ©é˜µä¹˜æ³•</a> <a class="dropdown-item" href="transformers.html">ç¬¬4éƒ¨åˆ†ï¼šTransformer</a> <a class="dropdown-item" href="training.html">ç¬¬5éƒ¨åˆ†ï¼šè®­ç»ƒ</a> <a class="dropdown-item" href="applied-training.html">ç¬¬6éƒ¨åˆ†ï¼šè®­ç»ƒLLaMA</a> <a class="dropdown-item" href="inference.html">ç¬¬7éƒ¨åˆ†ï¼šæ¨ç†</a> <a class="dropdown-item" href="applied-inference.html">ç¬¬8éƒ¨åˆ†ï¼šæœåŠ¡LLaMA</a> <a class="dropdown-item" href="profiling.html">ç¬¬9éƒ¨åˆ†ï¼šæ€§èƒ½åˆ†æ</a> <a class="dropdown-item" href="jax-stuff.html">ç¬¬10éƒ¨åˆ†ï¼šå…³äºJAXçš„ä¸€åˆ‡</a> <a class="dropdown-item" href="conclusion.html">ç¬¬11éƒ¨åˆ†ï¼šç»“è®º</a> <a class="dropdown-item" href="gpus.html">ç¬¬12éƒ¨åˆ†ï¼šGPU</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"><div class="translation-info base-grid" style="margin-bottom: 20px;">
<div style="grid-column: text;
                       display: flex;
                       align-items: center;
                       justify-content: space-between;
                       padding: 16px 0;
                       border-bottom: 1px solid var(--global-text-color-light, rgba(0,0,0,0.15));
                       font-size: 16px;
                       line-height: 1.5;
                       color: var(--global-text-color, currentColor);">
<div style="display: flex;
                           flex-direction: column;
                           gap: 8px;">
<div>
<span style="font-weight: 600; color: var(--global-text-color, currentColor);">ğŸ”— è‹±æ–‡åŸæ–‡ï¼š</span>
<a href="https://jax-ml.github.io/scaling-book/transformers/" onmouseout="this.style.textDecoration='none'" onmouseover="this.style.textDecoration='underline'" rel="noopener noreferrer" style="color: var(--global-theme-color, #004276);
                                  text-decoration: none;
                                  margin-left: 4px;" target="_blank">
                           https://jax-ml.github.io/scaling-book/transformers/
                        </a>
</div>
<div>
<span style="font-weight: 600; color: var(--global-text-color, currentColor);">âœï¸ ç¿»è¯‘ï¼š</span>
<a href="https://github.com/skindhu/Build-A-Large-Language-Model-CN" target="_blank" style="margin-left: 4px; color: var(--global-theme-color, #004276); text-decoration: none;">åŒ—æçš„æ ‘</a>
</div>
</div>
<div style="flex-shrink: 0;
                           display: flex;
                           flex-direction: column;
                           align-items: center;
                           gap: 6px;
                           margin-left: 20px;">
<img alt="å¾®ä¿¡äºŒç»´ç " loading="lazy" src="https://wechat-account-1251781786.cos.ap-guangzhou.myqcloud.com/wechat_account.jpeg" style="width: 80px;
                                height: 80px;
                                border-radius: 6px;
                                opacity: 0.9;"/>
<span style="font-size: 12px;
                                 color: var(--global-text-color-light, currentColor);
                                 opacity: 0.8;
                                 text-align: center;">
                        å¾®ä¿¡å…¬ä¼—å·
                    </span>
</div>
</div>
</div> <d-title> <h1>ä½ éœ€è¦çŸ¥é“çš„æ‰€æœ‰Transformeræ•°å­¦çŸ¥è¯†</h1> <p>ã€Šå¦‚ä½•æ‰©å±•ä½ çš„æ¨¡å‹ã€‹ç¬¬4éƒ¨åˆ† (<a href="sharding.html">ç¬¬3éƒ¨åˆ†ï¼šåˆ†ç‰‡</a> | <a href="training.html">ç¬¬5éƒ¨åˆ†ï¼šè®­ç»ƒ</a>)</p> <p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†å¿«é€Ÿå›é¡¾Transformeræ¶æ„ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•è®¡ç®—FLOPsã€å­—èŠ‚æ•°å’Œå…¶ä»–æ„Ÿå…´è¶£çš„é‡ã€‚</p> </d-title> <d-byline>
<div class="byline grid">
<div class="authors-affiliations grid">
<h3 style="grid-column: 1; grid-row: 1;">ä½œè€…</h3>
<h3></h3>
<h3>å•ä½</h3>
<p class="author" style="grid-column: 1; grid-row: 2;">
<a class="name" href="https://www.jacobaustin.org/">Jacob Austin</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 2;">
<span class="affiliation">Google DeepMind</span>
</p>
<p class="author" style="grid-column: 1; grid-row: 3;">
<a class="name" href="https://x.com/_sholtodouglas">Sholto Douglas</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 3;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 4;">
<a class="name" href="https://cs.stanford.edu/~rfrostig/">Roy Frostig</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 4;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 5;">
<a class="name" href="https://anselmlevskaya.com/">Anselm Levskaya</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 5;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 6;">
<a class="name" href="https://x.com/charliexychen">Charlie Chen</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 6;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 7;">
<a class="name" href="https://sharadvikram.com/">Sharad Vikram</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 7;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 2;">
<a class="name" href="https://fedelebron.com/">Federico Lebron</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 2;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 3;">
<a class="name" href="https://x.com/pchoy95">Peter Choy</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 3;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 4;">
<a class="name" href="https://x.com/vinayramasesh">Vinay Ramasesh</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 4;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 5;">
<a class="name" href="https://representation.ai/">Albert Webson</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 5;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 6;">
<a class="name" href="https://x.com/reinerpope">Reiner Pope<sup>*</sup></a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 6;">
<span class="affiliation"></span>
</p>
</div>
<div>
<h3>å‘å¸ƒæ—¥æœŸ</h3>
<p>2025å¹´2æœˆ4æ—¥</p>
</div>
</div>
</d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>ç›®å½•</h3> <div> <a href="#counting-dots">ç‚¹ç§¯è®¡ç®—</a> </div> <div> <a href="#"></a> </div> <ul> <li> <a href="#forward-and-reverse-flops">å‰å‘å’Œåå‘FLOPs</a> </li> </ul> <div> <a href="#transformer-accounting">Transformerè®¡ç®—åˆ†æ</a> </div> <div> <a href="#global-flops-and-params-calculation">å…¨å±€FLOPså’Œå‚æ•°è®¡ç®—</a> </div> <div> <a href="#miscellaneous-math">å…¶ä»–æ•°å­¦çŸ¥è¯†</a> </div> <div> <a href="#"></a> </div> <ul> <li> <a href="#sparsity-and-mixture-of-experts">ç¨€ç–æ€§ä¸ä¸“å®¶æ··åˆæ¨¡å‹</a> </li> <li> <a href="#gradient-checkpointing">æ¢¯åº¦æ£€æŸ¥ç‚¹</a> </li> <li> <a href="#key-value-kv-caching">é”®å€¼ï¼ˆKVï¼‰ç¼“å­˜</a> </li> </ul> <div> <a href="#what-should-you-take-away-from-this-section">æœ¬èŠ‚è¦ç‚¹æ€»ç»“</a> </div> <div> <a href="#a-few-problems-to-work">å‡ ä¸ªç»ƒä¹ é¢˜</a> </div> <div> <a href="#appendix">é™„å½•</a> </div> <div> <a href="#"></a> </div> <ul> <li> <a href="#appendix-a-how-does-flash-attention-work">é™„å½•Aï¼šFlash Attentionæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</a> </li> </ul> </nav> </d-contents> <h2 id="counting-dots">ç‚¹ç§¯è®¡ç®—</h2> <p>è®©æˆ‘ä»¬ä»å‘é‡\(x\)ã€\(y\)å’ŒçŸ©é˜µ\(A\)ã€\(B\)å¼€å§‹ï¼Œå®ƒä»¬çš„å½¢çŠ¶å¦‚ä¸‹ï¼š</p><span> \[\def \red#1{\textcolor{red}{#1}} \def \green#1{\textcolor{green}{#1}} \def \blue#1{\textcolor{blue}{#1}} \def \purple#1{\textcolor{purple}{#1}} \def \orange#1{\textcolor{orange}{#1}} \def \gray#1{\textcolor{gray}{#1}} \begin{array}{cc} \textrm{æ•°ç»„} &amp; \textrm{å½¢çŠ¶} \\ \hline x &amp; \textrm{[P]} \\ y &amp; \textrm{[P]} \\ A &amp; \textrm{[N P]} \\ B &amp; \textrm{[P M]} \\ \hline \end {array}\] </span><ul> <li>\(x \cdot y\)çš„ç‚¹ç§¯éœ€è¦\(P\)æ¬¡<em>åŠ æ³•</em>å’Œ<em>ä¹˜æ³•</em>ï¼Œæ€»å…±\(2P\)æ¬¡æµ®ç‚¹è¿ç®—ã€‚</li> <li>çŸ©é˜µå‘é‡ç§¯\(Ax\)æ²¿\(A\)çš„è¡Œè¿›è¡Œ\(N\)æ¬¡ç‚¹ç§¯ï¼Œå…±\(2NP\) FLOPsã€‚</li> <li>çŸ©é˜µ-çŸ©é˜µç§¯\(AB\)å¯¹\(B\)çš„\(M\)åˆ—ä¸­çš„æ¯ä¸€åˆ—è¿›è¡Œä¸€æ¬¡çŸ©é˜µå‘é‡ç§¯ï¼Œæ€»å…±\(2NPM\) FLOPsã€‚</li> <li>é€šå¸¸ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸¤ä¸ªæ›´é«˜ç»´çš„æ•°ç»„\(C\)å’Œ\(D\)ï¼Œå…¶ä¸­ä¸€äº›ç»´åº¦æ˜¯<span style="color:red">æ”¶ç¼©ï¼ˆCONTRACTINGï¼‰</span>ç»´åº¦ï¼Œä¸€äº›æ˜¯<span style="color:blue">æ‰¹å¤„ç†ï¼ˆBATCHINGï¼‰</span>ç»´åº¦ã€‚ï¼ˆä¾‹å¦‚ \(C[\blue{GH}IJ\red{KL}], D[\blue{GH}MN\red{KL}]\)ï¼‰ï¼Œé‚£ä¹ˆè¿™æ¬¡æ”¶ç¼©çš„FLOPsæˆæœ¬æ˜¯æ‰€æœ‰\(C\)å’Œ\(D\)ç»´åº¦ä¹˜ç§¯çš„ä¸¤å€ï¼Œå…¶ä¸­æ‰¹å¤„ç†å’Œæ”¶ç¼©ç»´åº¦åªè®¡ç®—ä¸€æ¬¡ï¼Œï¼ˆä¾‹å¦‚ \(2\blue{GH}IJMN\red{KL}\)ï¼‰ã€‚è¯·æ³¨æ„ï¼Œä¸€ä¸ªç»´åº¦åªæœ‰åœ¨ä¸¤ä¸ªä¹˜æ•°ä¸­éƒ½å‡ºç°æ—¶æ‰æ˜¯æ‰¹å¤„ç†ç»´åº¦ã€‚ï¼ˆå¦è¯·æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰æ”¶ç¼©ç»´åº¦ï¼Œè¿™åªæ˜¯ä¸€ä¸ªé€å…ƒç´ ä¹˜ç§¯ï¼Œåˆ™2çš„å› å­ä¸é€‚ç”¨ã€‚ï¼‰</li> </ul><span> \[\begin{array}{ccc} \textrm{æ“ä½œ} &amp; \textrm{FLOPs} &amp; \textrm{æ•°æ®} \\ \hline x \cdot y &amp; 2P &amp; 2P \\ A x &amp; 2NP &amp; NP + P \\ AB &amp; 2NPM &amp; NP + PM \\ [c_0,...,c_N] \cdot [d_0,...,d_N] &amp; 2 \prod c_i \times \prod_{\substack{d_j \notin \blue{BATCH} \\ d_j \notin \red{CONTRACT}}} d_j &amp; \prod c_i + \prod d_j \\ \hline \end {array}\] </span><p>è¯·æ³¨æ„ï¼Œå¯¹äºçŸ©é˜µ-çŸ©é˜µä¹˜æ³•ï¼Œ<em>è®¡ç®—é‡</em>ä»¥ç«‹æ–¹çº§ï¼ˆ\(O(N^3)\)ï¼‰å¢é•¿ï¼Œè€Œæ•°æ®ä¼ è¾“ä»…ä»¥å¹³æ–¹çº§ï¼ˆ\(O(N^2)\)ï¼‰å¢é•¿â€”â€”è¿™æ„å‘³ç€éšç€æˆ‘ä»¬æ‰©å¤§çŸ©é˜µä¹˜æ³•çš„è§„æ¨¡ï¼Œè¾¾åˆ°è®¡ç®—é¥±å’Œçš„æé™å˜å¾—<em>æ›´å®¹æ˜“</em>ã€‚è¿™æ˜¯æä¸å¯»å¸¸çš„ï¼Œå¹¶ä¸”åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨ä»¥çŸ©é˜µä¹˜æ³•ä¸ºä¸»çš„æ¶æ„â€”â€”å®ƒä»¬æ˜“äºæ‰©å±•ï¼</p> <figure> <picture> <source class="responsive-img-srcset" sizes="95vw" srcset="https://jax-ml.github.io/scaling-book/assets/img/matmul-flops-480.webp 480w, https://jax-ml.github.io/scaling-book/assets/img/matmul-flops-800.webp 800w, https://jax-ml.github.io/scaling-book/assets/img/matmul-flops-1400.webp 1400w" type="image/webp"/> <img class="img-fluid" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" src="https://jax-ml.github.io/scaling-book/assets/img/matmul-flops.gif" width="100%"/> </picture> </figure> <h3 id="forward-and-reverse-flops">å‰å‘å’Œåå‘FLOPs</h3> <p>åœ¨è®­ç»ƒæœŸé—´ï¼Œæˆ‘ä»¬å¹¶ä¸ç‰¹åˆ«å…³å¿ƒç»™å®šçŸ©é˜µä¹˜æ³•çš„ç»“æœï¼›æˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ˜¯å®ƒçš„å¯¼æ•°ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åœ¨åå‘ä¼ æ’­æœŸé—´ä¼šè¿›è¡Œæ›´å¤šçš„FLOPsã€‚</p> <p>å¦‚æœæˆ‘ä»¬å‡è®¾<strong>B</strong>åªæ˜¯ä¸€ä¸ªæ›´å¤§ç½‘ç»œä¸­çš„ä¸€ä¸ªçŸ©é˜µï¼Œè€Œ<strong>A</strong>æ˜¯æˆ‘ä»¬çš„è¾“å…¥æ¿€æ´»ï¼Œå…¶ä¸­<strong>C = A B</strong>ï¼Œåˆ™æŸå¤±<strong>L</strong>ç›¸å¯¹äº<strong>B</strong>çš„å¯¼æ•°ç”±é“¾å¼æ³•åˆ™ç»™å‡ºï¼š</p><span> \[\frac{\partial L}{\partial B} = \frac{\partial L}{\partial C}\frac{\partial C}{\partial B} = A^T \left(\frac{\partial L}{\partial C}\right)\] </span><p>è¿™æ˜¯ä¸€ä¸ªå¤–ç§¯ï¼Œéœ€è¦<d-math>2NPM</d-math> FLOPsæ¥è®¡ç®—ï¼ˆå› ä¸ºå®ƒåœ¨\(N\)ç»´åº¦ä¸Šæ”¶ç¼©ï¼‰ã€‚åŒæ ·ï¼ŒæŸå¤±ç›¸å¯¹äº<strong>A</strong>çš„å¯¼æ•°ä¸º</p><span> \[\frac{\partial L}{\partial A} = \frac{\partial L}{\partial C}\frac{\partial C}{\partial A} = \left(\frac{\partial L}{\partial C}\right) B^T\] </span><p>åŒæ ·æ˜¯<d-math>2NPM</d-math> FLOPsï¼Œå› ä¸º<strong>dL/dC</strong>æ˜¯ä¸€ä¸ªå¤§å°ä¸º\[N, M\]çš„ï¼ˆä½™ï¼‰å‘é‡ã€‚è™½ç„¶è¿™ä¸ªé‡ä¸æ˜¯ç›¸å¯¹äºå‚æ•°çš„å¯¼æ•°ï¼Œä½†å®ƒè¢«ç”¨æ¥è®¡ç®—ç½‘ç»œå‰å‡ å±‚çš„å¯¼æ•°ï¼ˆä¾‹å¦‚ï¼Œå°±åƒdL/dCè¢«ç”¨æ¥è®¡ç®—ä¸Šé¢çš„dL/dBä¸€æ ·ï¼‰ã€‚</p> <p>å°†è¿™äº›åŠ èµ·æ¥ï¼Œæˆ‘ä»¬çœ‹åˆ°<strong>åœ¨è®­ç»ƒæœŸé—´ï¼Œæˆ‘ä»¬æ€»å…±æœ‰6NPM FLOPs</strong>ï¼Œè€Œåœ¨æ¨ç†æœŸé—´æ˜¯2NPMï¼šå‰å‘ä¼ æ’­2NPMï¼Œåå‘ä¼ æ’­4NPMã€‚ç”±äºPMæ˜¯çŸ©é˜µä¸­çš„å‚æ•°æ•°é‡ï¼Œè¿™æ˜¯è‘—åçš„\(6 * \text{å‚æ•°æ•°é‡} * \text{tokenæ•°é‡}\)è¿‘ä¼¼Transformerè®­ç»ƒæœŸé—´FLOPsçš„æœ€ç®€å•å½¢å¼ï¼šæ¯ä¸ªtokenéœ€è¦\(6 * \text{å‚æ•°æ•°é‡}\) FLOPsã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢å±•ç¤ºä¸€ä¸ªæ›´æ­£ç¡®çš„æ¨å¯¼ã€‚</p> <h2 id="transformer-accounting">Transformerè®¡ç®—åˆ†æ</h2> <p>Transformeræ˜¯æœªæ¥ã€‚å—¯ï¼Œè‡³å°‘å®ƒä»¬æ˜¯ç°åœ¨ã€‚ä¹Ÿè®¸å‡ å¹´å‰ï¼Œå®ƒä»¬æ˜¯ä¼—å¤šæ¶æ„ä¹‹ä¸€ã€‚ä½†ä»Šå¤©ï¼Œå‡ ä¹å€¼å¾—äº†è§£è¯¥æ¶æ„çš„æ¯ä¸€ä¸ªç»†èŠ‚ã€‚æˆ‘ä»¬ä¸ä¼šé‡æ–°ä»‹ç»è¯¥æ¶æ„ï¼Œä½†<a href="https://jalammar.github.io/illustrated-transformer/" rel="external nofollow noopener" target="_blank">è¿™ç¯‡åšå®¢</a>å’Œ<a href="https://arxiv.org/abs/1706.03762" rel="external nofollow noopener" target="_blank">åŸå§‹Transformerè®ºæ–‡</a>å¯èƒ½ä¼šæ˜¯å¾ˆæœ‰å¸®åŠ©çš„å‚è€ƒèµ„æ–™ã€‚</p> <p>ä»¥ä¸‹æ˜¯Transformerè§£ç å™¨æ¶æ„çš„åŸºæœ¬ç¤ºæ„å›¾ï¼š</p> <figure> <picture> <source class="responsive-img-srcset" sizes="95vw" srcset="https://jax-ml.github.io/scaling-book/assets/img/transformer-diagram-480.webp 480w, https://jax-ml.github.io/scaling-book/assets/img/transformer-diagram-800.webp 800w, https://jax-ml.github.io/scaling-book/assets/img/transformer-diagram-1400.webp 1400w" type="image/webp"/> <img class="img-fluid" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" src="https://jax-ml.github.io/scaling-book/assets/img/transformer-diagram.png" width="100%"/> </picture> <figcaption class="caption"><b>å›¾ï¼š</b>è¯¥å›¾å±•ç¤ºäº†ä¸€ä¸ªæ ‡å‡†Transformerçš„ä¸€å±‚ï¼Œæ•°æ®æµä»ä¸Šåˆ°ä¸‹ã€‚æˆ‘ä»¬ä½¿ç”¨å•å­—æ¯çº¦å®šæ¥æè¿°Transformerä¸­æ•°ç»„çš„å½¢çŠ¶å’Œå¸ƒå±€ï¼Œå†æ¬¡ç”¨çº¢è‰²è¡¨ç¤ºæ”¶ç¼©ç»´åº¦ï¼Œç”¨è“è‰²è¡¨ç¤ºæ‰¹å¤„ç†ç»´åº¦ã€‚åœ¨ç»™å®šçš„æ“ä½œä¸­ï¼Œå·¦ä¸Šè§’æ˜¯è¾“å…¥å½¢çŠ¶ï¼Œå³ä¸Šè§’æ˜¯å‚æ•°å½¢çŠ¶ï¼Œä¸‹æ–¹æ˜¯ç»“æœå½¢çŠ¶ï¼Œä¾‹å¦‚ï¼ŒBTDæ˜¯é—¨æ§einsumçš„è¾“å…¥å½¢çŠ¶ï¼ŒDFæ˜¯æƒé‡å½¢çŠ¶ã€‚</figcaption> </figure> <p><strong>æ³¨æ„ [é—¨æ§einsum]</strong>ï¼šä¸Šå›¾ä½¿ç”¨äº†ä¸€ç§â€œ<a href="https://arxiv.org/abs/2002.05202" rel="external nofollow noopener" target="_blank">é—¨æ§einsum</a>â€<d-cite key="glu"></d-cite>ï¼Œå…¶ä¸­æˆ‘ä»¬å°†ä¸ŠæŠ•å½±çŸ©é˜µåˆ†æˆä¸¤ä¸ªçŸ©é˜µï¼ˆä¸Šå›¾ä¸­çš„\(W_\text{In1}\)å’Œ\(W_\text{In2}\)ï¼‰ï¼Œå…¶è¾“å‡ºè¢«é€å…ƒç´ ç›¸ä¹˜ä»¥ä½œä¸ºä¸€ç§â€œé—¨æ§å‡½æ•°â€ã€‚å¹¶éæ‰€æœ‰LLMéƒ½ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæ‰€ä»¥ä½ æœ‰æ—¶ä¼šçœ‹åˆ°ä¸€ä¸ªå•ç‹¬çš„\(W_\text{In}\)çŸ©é˜µï¼Œæ€»MLPå‚æ•°æ•°é‡ä¸º2DFè€Œä¸æ˜¯3DFã€‚é€šå¸¸åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDå’ŒFä¼šè¢«æ”¾å¤§ä»¥ä¿æŒå‚æ•°æ•°é‡ä¸3çŸ©é˜µæƒ…å†µç›¸åŒã€‚è¯è™½å¦‚æ­¤ï¼ŒLLAMAã€DeepSeekå’Œè®¸å¤šå…¶ä»–æ¨¡å‹éƒ½ä½¿ç”¨äº†æŸç§å½¢å¼çš„é—¨æ§einsumã€‚</p> <p><strong>æ³¨æ„2 [MHAæ³¨æ„åŠ›]</strong>ï¼šå¯¹äºè‡ªæ³¨æ„åŠ›ï¼ŒTå’ŒSæ˜¯ç›¸åŒçš„ï¼Œä½†å¯¹äºäº¤å‰æ³¨æ„åŠ›ï¼Œå®ƒä»¬å¯èƒ½ä¸åŒã€‚å¯¹äºæ™®é€šçš„å¤šå¤´æ³¨æ„åŠ›ï¼ˆMHAï¼‰ï¼ŒNå’ŒKæ˜¯ç›¸åŒçš„ï¼Œè€Œå¯¹äº<a href="https://arxiv.org/abs/1911.02150" rel="external nofollow noopener" target="_blank">å¤šæŸ¥è¯¢æ³¨æ„åŠ›</a>ï¼ˆMQAï¼‰<d-cite key="mqa"></d-cite>ï¼ŒK=1ï¼Œå¯¹äº<a href="https://arxiv.org/abs/2305.13245" rel="external nofollow noopener" target="_blank">åˆ†ç»„MQA</a>ï¼ˆGMQAï¼‰<d-cite key="gmqa"></d-cite>ï¼ŒKåªéœ€èƒ½æ•´é™¤Nå³å¯ã€‚</p> <h2 id="global-flops-and-params-calculation">å…¨å±€FLOPså’Œå‚æ•°è®¡ç®—</h2> <p>ä¸ºäº†é¿å…åˆ°å¤„éƒ½å†™ä¸Š<strong>L</strong>å› å­ï¼Œä¸‹é¢æˆ‘ä»¬å°†è®¡ç®—æ¯å±‚çš„FLOPsã€‚</p> <h3 id="mlps">MLP</h3> <p>Transformerçš„MLPé€šå¸¸ç”±2ä¸ªè¾“å…¥çŸ©é˜µä¹˜æ³•ï¼ˆå…¶ç»“æœé€å…ƒç´ ç»„åˆï¼‰å’Œ1ä¸ªè¾“å‡ºçŸ©é˜µä¹˜æ³•ç»„æˆï¼š</p><span> \[\begin{array}{ccc} \textrm{æ“ä½œ} &amp; \textrm{è®­ç»ƒ FLOPs} &amp; \textrm{å‚æ•°} \\ \hline \\ A[B,T,\red{D}] \cdot W_{in1}[\red{D}, F] &amp; 6BTDF &amp; DF \\[10pt] A[B,T,\red{D}] \cdot W_{in2}[\red{D}, F] &amp; 6BTDF &amp; DF \\[10pt] \sigma\left(A_{in1}\right)[B,T, F] * A_{in2}[B,T, F] &amp; \gray{O(BTF)} \\[10pt] A[B,T,\red{F}] \cdot W_{out}[\red{F}, D] &amp; 6BTDF &amp; DF \\[10pt] \hline \\ &amp; \approx 18BTDF &amp; 3DF \end{array}\] </span><h3 id="attention">æ³¨æ„åŠ›</h3> <p>å¯¹äºå…·æœ‰ä¸åŒ<strong>Q</strong>å’Œ<strong>KV</strong>å¤´æ•°çš„é€šç”¨åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›æƒ…å†µï¼Œæˆ‘ä»¬å‡è®¾<strong>Q</strong>ã€<strong>K</strong>ã€<strong>V</strong>æŠ•å½±çš„å¤´ç»´åº¦Hç›¸ç­‰ï¼Œå¹¶ä¼°è®¡<strong>QKVO</strong>çŸ©é˜µä¹˜æ³•çš„æˆæœ¬ï¼š</p><span> \[\begin{array}{ccc} \textrm{æ“ä½œ} &amp; \textrm{è®­ç»ƒ FLOPs} &amp; \textrm{å‚æ•°} \\ \hline \\ A[B,T,\red{D}] \cdot W_{Q}[\red{D}, N, H] &amp; 6BTDNH &amp; DNH \\[10pt] A[B,T,\red{D}] \cdot W_{K}[\red{D}, K, H] &amp; 6BTDKH &amp; DKH \\[10pt] A[B,T,\red{D}] \cdot W_{V}[\red{D}, K, H] &amp; 6BTDKH &amp; DKH \\[10pt] A[B,T,\red{N}, \red{H}] \cdot W_{O}[\red{N}, \red{H}, D] &amp; 6BTDNH &amp; DNH \\[10pt] \hline \\ &amp; 12BTD(N+K)H &amp; 2D(N+K)H \end{array}\] </span><p>ç‚¹ç§¯æ³¨æ„åŠ›æ“ä½œæ›´ä¸ºç²¾ç»†ï¼Œå®é™…ä¸Šæ˜¯åœ¨\(B\)ã€\(K\)ç»´åº¦ä¸Šæ‰¹å¤„ç†çš„\(TH \cdot HS\)çŸ©é˜µä¹˜æ³•ï¼Œä¸€ä¸ªsoftmaxï¼Œä»¥åŠå†æ¬¡åœ¨\(B\)ã€\(K\)ç»´åº¦ä¸Šæ‰¹å¤„ç†çš„\(TS \cdot SH\)çŸ©é˜µä¹˜æ³•ã€‚æˆ‘ä»¬ç”¨è“è‰²çªå‡ºæ˜¾ç¤ºæ‰¹å¤„ç†ç»´åº¦ï¼š</p><span> \[\begin{array}{cc} \textrm{æ“ä½œ} &amp; \textrm{è®­ç»ƒ FLOPs} \\ \hline \\[3pt] Q[\blue{B}, T, \blue{K}, G, \red{H}] \cdot K[\blue{B}, S, \blue{K}, \red{H}] &amp; 6BTSKGH = 6BTSNH \\[3pt] \textrm{softmax}_S \;\; L[B, T, S, K, G] &amp; \gray{O(BTSKG) = O(BTSN)} \\[3pt] S[\blue{B}, T, \red{S}, \blue{K}, G] \cdot V[\blue{B}, \red{S}, \blue{K}, H] &amp; 6BTSKGH = 6BTSNH \\[3pt] \hline \\ &amp; \approx 12BTSNH = 12BT^2NH \\ \end{array}\] </span><h3 id="other-operations">å…¶ä»–æ“ä½œ</h3> <p>åœ¨Transformerä¸­è¿˜æœ‰å…¶ä»–å‡ ç§æ“ä½œã€‚å±‚å½’ä¸€åŒ–ï¼ˆLayernormï¼‰ç›¸å¯¹ä¾¿å®œï¼Œåœ¨ä¸€é˜¶æˆæœ¬ä¼°ç®—ä¸­å¯ä»¥å¿½ç•¥ã€‚è¿˜æœ‰ä¸€ä¸ªæœ€ç»ˆçš„å·¨å¤§ï¼ˆä½†ä¸æ˜¯æ¯å±‚éƒ½æœ‰ï¼‰çš„unembeddingçŸ©é˜µä¹˜æ³•ã€‚</p><span> \[\begin{array}{ccc} \textsf{æ“ä½œ} &amp; \textsf{è®­ç»ƒ FLOPs} &amp; \textsf{å‚æ•°} \\ \hline \\ \textrm{layernorm}_D \;\; A[B,T,\red{D}] &amp; \gray{O\left(BTD\right)} &amp; \gray{D} \\[10pt] A[B,T,\red{D}] \cdot W_{unembed}[\red{D}, V] &amp; 6BTDV &amp; DV \\ \end{array}\] </span><h3 id="general-rule-of-thumb-for-transformer-flops">Transformer FLOPsçš„é€šç”¨ç»éªŒæ³•åˆ™</h3> <p>å¦‚æœæˆ‘ä»¬å¿½ç•¥çŸ­ä¸Šä¸‹æ–‡è®­ç»ƒä¸­ç‚¹ç§¯æ³¨æ„åŠ›çš„æˆæœ¬ï¼Œé‚£ä¹ˆæ‰€æœ‰å±‚çš„æ€»FLOPsä¸º</p><span> \[\begin{align*} (18BTDF + 12BTD(N+K)H)L = 6 *BT * (3DF + 2D(N+K)H)L \\ = 6 * \textrm{tokenæ•°é‡} * \textrm{å‚æ•°æ•°é‡} \end{align*}\] </span><p>è¿™å°±å¾—å‡ºäº†ä¸€ä¸ªè‘—åçš„ç»éªŒæ³•åˆ™ï¼Œç”¨äºä¼°ç®—å¯†é›†Transformerçš„FLOPsæ•°é‡ï¼Œå¿½ç•¥äº†æ³¨æ„åŠ›çš„FLOPsã€‚ï¼ˆUnembeddingæ˜¯å¦ä¸€ä¸ªç®€å•çš„çŸ©é˜µä¹˜æ³•ï¼Œæœ‰<d-math>6BSDV</d-math> FLOPså’Œ<d-math>DV</d-math>å‚æ•°ï¼Œéµå¾ªç›¸åŒçš„ç»éªŒæ³•åˆ™ã€‚ï¼‰</p> <h3 id="fractional-cost-of-attention-with-context-length">æ³¨æ„åŠ›æˆæœ¬åœ¨ä¸Šä¸‹æ–‡é•¿åº¦ä¸­çš„å æ¯”</h3> <p>å¦‚æœæˆ‘ä»¬ç¡®å®è€ƒè™‘äº†ä¸Šé¢çš„ç‚¹ç§¯æ³¨æ„åŠ›ï¼Œå¹¶å‡è®¾\(F=4D\)ï¼Œ\(D=NH\)ï¼ˆé€šå¸¸å¦‚æ­¤ï¼‰å’Œ\(N=K\)ï¼š</p><span> \[\small{\frac{\textrm{æ³¨æ„åŠ› FLOPs}}{\textrm{çŸ©é˜µä¹˜æ³• FLOPs}} = \frac{12BT^2NH}{18BTDF + 24BTDNH} = \frac{12BT^2D}{4*18 BTD^2 + 24 BTD^2} = \frac{12BT^2D}{96 BTD^2} = \frac{T}{8D}}\] </span><p>å› æ­¤ï¼Œç»“è®ºæ˜¯<strong>ç‚¹ç§¯æ³¨æ„åŠ›çš„FLOPsä»…åœ¨è®­ç»ƒæœŸé—´T&gt;8Dæ—¶æ‰å ä¸»å¯¼åœ°ä½</strong>ã€‚å¯¹äºDçº¦ç­‰äº8kï¼Œè¿™å°†æ˜¯çº¦64Kä¸ªtokenã€‚è¿™åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯åˆç†çš„ï¼Œå› ä¸ºå®ƒæ„å‘³ç€éšç€MLPå¤§å°çš„å¢åŠ ï¼Œæ³¨æ„åŠ›çš„FLOPså˜å¾—ä¸é‚£ä¹ˆå…³é”®ã€‚å¯¹äºå¤§å‹æ¨¡å‹ï¼Œæ³¨æ„åŠ›çš„äºŒæ¬¡æˆæœ¬å®é™…ä¸Šå¹¶ä¸æ˜¯é•¿ä¸Šä¸‹æ–‡è®­ç»ƒçš„å·¨å¤§éšœç¢ã€‚ç„¶è€Œï¼Œå¯¹äºè¾ƒå°çš„æ¨¡å‹ï¼Œä¾‹å¦‚Gemma-27Bï¼ŒD=4608ï¼Œè¿™æ„å‘³ç€æ³¨æ„åŠ›åœ¨åºåˆ—é•¿åº¦çº¦32kæ—¶å¼€å§‹å ä¸»å¯¼åœ°ä½ã€‚Flash Attentionä¹Ÿæœ‰åŠ©äºå‡è½»é•¿ä¸Šä¸‹æ–‡çš„æˆæœ¬ï¼Œæˆ‘ä»¬å°†åœ¨<a href="#appendix-a-how-does-flash-attention-work">é™„å½•A</a>ä¸­ç®€è¦è®¨è®ºã€‚</p> <h2 id="miscellaneous-math">å…¶ä»–æ•°å­¦çŸ¥è¯†</h2> <h3 id="sparsity-and-mixture-of-experts">ç¨€ç–æ€§ä¸ä¸“å®¶æ··åˆæ¨¡å‹</h3> <p>æˆ‘ä»¬ä¸èƒ½ä¸ç®€è¦è®¨è®ºä¸€ä¸‹ä¸“å®¶æ··åˆï¼ˆMoEï¼‰æ¨¡å‹<d-cite key="moe"></d-cite>ï¼Œå®ƒç”¨ä¸€ç»„å¯ä»¥åŠ¨æ€è·¯ç”±çš„ç‹¬ç«‹MLPæ›¿æ¢äº†æ ‡å‡†Transformerä¸­çš„å•ä¸ªå¯†é›†MLPå—ã€‚åˆæ­¥è¿‘ä¼¼ï¼Œ<strong>ä¸€ä¸ªMoEæ¨¡å‹å°±æ˜¯ä¸€ä¸ªæ¯å±‚æœ‰Eä¸ªMLPå—çš„æ™®é€šå¯†é›†æ¨¡å‹</strong>ï¼Œè€Œä¸æ˜¯åªæœ‰ä¸€ä¸ªã€‚æ¯ä¸ªtokenæ¿€æ´»å…¶ä¸­\(k\)ä¸ªä¸“å®¶ï¼Œé€šå¸¸\(k=2\)ã€‚ä¸å¯†é›†ç‰ˆæœ¬ç›¸æ¯”ï¼Œè¿™å°†å‚æ•°æ•°é‡å¢åŠ äº†\(O(E)\)å€ï¼ŒåŒæ—¶å°†æ¯ä¸ªtokenæ¿€æ´»çš„æ€»å‚æ•°æ•°é‡ä¹˜ä»¥\(k\)å€ã€‚</p> <figure> <picture> <source class="responsive-img-srcset" sizes="95vw" srcset="https://jax-ml.github.io/scaling-book/assets/img/moe-480.webp 480w, https://jax-ml.github.io/scaling-book/assets/img/moe-800.webp 800w, https://jax-ml.github.io/scaling-book/assets/img/moe-1400.webp 1400w" type="image/webp"/> <img class="img-fluid img-small" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" src="https://jax-ml.github.io/scaling-book/assets/img/moe.png" width="100%"/> </picture> <figcaption class="caption"><b>å›¾ï¼š</b>ä¸€ä¸ªæœ‰\(n\)ä¸ªä¸“å®¶çš„MoEå±‚ç¤ºä¾‹ã€‚é—¨æ§ä¸“å®¶å°†æ¯ä¸ªtokenè·¯ç”±åˆ°å…¶ä¸­çš„\(k\)ä¸ªï¼Œè¿™\(k\)ä¸ªMLPçš„è¾“å‡ºè¢«æ±‚å’Œã€‚æˆ‘ä»¬çš„å‚æ•°æ•°é‡æ˜¯æ¯ä¸ªä¸“å®¶å¤§å°çš„\(n\)å€ï¼Œä½†æ¯ä¸ªtokenåªä½¿ç”¨\(k\)ä¸ªã€‚<a href="https://deepgram.com/learn/mixture-of-experts-ml-model-guide" rel="external nofollow noopener" target="_blank">æ¥æº</a>ã€‚</figcaption> </figure> <p>ä¸å¯†é›†æ¨¡å‹ç›¸æ¯”ï¼ŒMoEå¼•å…¥äº†æ–°çš„é€šä¿¡ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªAllToAllæ“ä½œï¼ˆä¸€ä¸ªåœ¨MoEå—ä¹‹å‰ï¼Œä¸€ä¸ªåœ¨ä¹‹åï¼‰ï¼Œç”¨äºå°†tokenè·¯ç”±åˆ°æ­£ç¡®çš„ä¸“å®¶ï¼Œå¹¶å°†å®ƒä»¬å¸¦å›å…¶å®¿ä¸»è®¾å¤‡ã€‚<d-footnote id="d-footnote-1">ä¸¥æ ¼æ¥è¯´ï¼Œè¿™åªåœ¨æˆ‘ä»¬æ²¿ä¸“å®¶æ‰€åœ¨çš„åŒä¸€è½´è¿›è¡Œæ•°æ®æˆ–åºåˆ—åˆ†ç‰‡æ—¶æ‰ä¼šå‘ç”Ÿã€‚</d-footnote>ç„¶è€Œï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­çœ‹åˆ°çš„ï¼Œæ¯ä¸ªAllToAllçš„æˆæœ¬ä»…ä¸ºæ²¿å•ä¸ªè½´ï¼ˆå¯¹äºåŒå‘ç¯ï¼‰çš„å¯æ¯”AllGatheræˆæœ¬çš„1/4ã€‚</p> <h3 id="gradient-checkpointing">æ¢¯åº¦æ£€æŸ¥ç‚¹</h3> <p>åå‘ä¼ æ’­ä½œä¸ºä¸€ç§ç®—æ³•ï¼Œæ˜¯ç”¨å†…å­˜æ¢å–è®¡ç®—ã€‚åå‘ä¼ æ’­ä¸å†éœ€è¦\(O(n_\text{layers}^2)\)çš„FLOPsï¼Œè€Œæ˜¯<strong>éœ€è¦\(O(n_\text{layers})\)çš„å†…å­˜</strong>ï¼Œä¿å­˜å‰å‘ä¼ æ’­æœŸé—´ç”Ÿæˆçš„æ‰€æœ‰ä¸­é—´æ¿€æ´»ã€‚è™½ç„¶è¿™æ¯”äºŒæ¬¡è®¡ç®—è¦å¥½ï¼Œä½†åœ¨å†…å­˜æ–¹é¢å´éå¸¸æ˜‚è´µï¼šä¸€ä¸ªæ‹¥æœ‰\(B * T=4M\)ï¼ˆæ¯æ‰¹æ¬¡æ€»å…±4Mä¸ªtokenï¼‰ã€L=64å’ŒD=8192çš„æ¨¡å‹ï¼Œå¦‚æœé¿å…æ‰€æœ‰ä¸å¿…è¦çš„åå‘ä¼ æ’­è®¡ç®—ï¼Œå°†ä¸å¾—ä¸ä»¥bfloat16æ ¼å¼ä¿å­˜å¤§çº¦\(2 * 20 * B * T * D * L = 84TB\)çš„æ¿€æ´»ã€‚è¿™é‡Œçš„20ï¼ˆå¤§è‡´ï¼‰æ¥è‡ªäºè®¡ç®—ä¸Šå›¾Transformerå›¾ä¸­çš„æ¯ä¸ªä¸­é—´èŠ‚ç‚¹ï¼Œå› ä¸ºä¾‹å¦‚</p><span> \[f(x) = \exp(g(x))\] \[\frac{df}{dx} = \exp(g(x)) \cdot \frac{dg}{dx}\] </span><p>å› æ­¤ä¸ºäº†é¿å…é‡æ–°è®¡ç®—ï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜å‰å‘ä¼ æ’­ä¸­çš„\(g(x)\)å’Œ\(\exp(g(x))\)ã€‚ä¸ºäº†é¿å…ä¿å­˜è¿™ä¹ˆå¤šå†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åªä¿å­˜ä¸€éƒ¨åˆ†ä¸­é—´æ¿€æ´»ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„å‡ ç§ç­–ç•¥ã€‚</p> <ul> <li> <strong>å—é‡è®¡ç®—ï¼ˆBlock rematï¼‰</strong>ï¼šåªä¿å­˜æ¯å±‚çš„è¾“å…¥ã€‚è¿™æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æœ€æ¿€è¿›çš„æ–¹æ³•ï¼Œæ¯å±‚åªä¿å­˜1ä¸ªæ£€æŸ¥ç‚¹ï¼Œè¿™æ„å‘³ç€åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬åªä¿å­˜4.2TBã€‚è¿™è¿«ä½¿æˆ‘ä»¬åœ¨åå‘ä¼ æ’­ä¸­é‡å¤å‡ ä¹æ‰€æœ‰çš„å‰å‘ä¼ æ’­FLOPsï¼Œæ„å‘³ç€æˆ‘ä»¬å°†FLOPsä»\(6ND\)å¢åŠ åˆ°å¤§çº¦\(8ND\)ã€‚</li> <li> <strong>ä»…é™å¤§çŸ©é˜µä¹˜æ³•ï¼š</strong> å¦ä¸€ä¸ªç®€å•çš„ç­–ç•¥æ˜¯åªä¿å­˜å¤§çŸ©é˜µä¹˜æ³•çš„è¾“å‡ºã€‚è¿™ä½¿æˆ‘ä»¬é¿å…åœ¨åå‘ä¼ æ’­æœŸé—´é‡æ–°è®¡ç®—ä»»ä½•å¤§çš„çŸ©é˜µä¹˜æ³•ï¼Œä½†ä»ç„¶éœ€è¦æˆ‘ä»¬é‡æ–°è®¡ç®—å…¶ä»–æ¿€æ´»å‡½æ•°å’Œæ³¨æ„åŠ›çš„éƒ¨åˆ†ã€‚è¿™å°†æ¯å±‚çš„20ä¸ªèŠ‚ç‚¹å‡å°‘åˆ°æ¥è¿‘æ¯å±‚7ä¸ªã€‚</li> </ul> <p>è¿™ç»ä¸æ˜¯å…¨é¢çš„ã€‚åœ¨ä½¿ç”¨JAXæ—¶ï¼Œè¿™äº›é€šå¸¸ç”±<code class="language-plaintext highlighter-rouge">jax.remat</code>/<code class="language-plaintext highlighter-rouge">jax.checkpoint</code>æ§åˆ¶ï¼ˆä½ å¯ä»¥åœ¨<a href="https://jax.readthedocs.io/en/latest/_autosummary/jax.checkpoint.html" rel="external nofollow noopener" target="_blank">è¿™é‡Œ</a>é˜…è¯»æ›´å¤šï¼‰ã€‚</p> <h3 id="key-value-kv-caching">é”®å€¼ï¼ˆKVï¼‰ç¼“å­˜</h3> <p>æ­£å¦‚æˆ‘ä»¬å°†åœ¨<a href="inference.html">ç¬¬7èŠ‚</a>ä¸­çœ‹åˆ°çš„ï¼ŒLLMæ¨ç†æœ‰ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ï¼Œé¢„å¡«å……ï¼ˆprefillï¼‰å’Œç”Ÿæˆï¼ˆgenerationï¼‰ã€‚</p> <ul> <li> <strong>é¢„å¡«å……ï¼ˆPrefillï¼‰</strong> å¤„ç†ä¸€ä¸ªé•¿æç¤ºï¼Œå¹¶å°†å…¶æ³¨æ„åŠ›æ¿€æ´»ä¿å­˜åœ¨é”®å€¼ç¼“å­˜ï¼ˆKV Cacheï¼‰ä¸­ï¼Œä»¥ä¾›ç”Ÿæˆæ—¶ä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨æ³¨æ„åŠ›å—ä¸­çš„é”®å€¼æŠ•å½±ã€‚</li> <li> <strong>ç”Ÿæˆï¼ˆGenerationï¼‰</strong> å°†å¤šä¸ªè¿™æ ·çš„KVç¼“å­˜æ‰¹å¤„ç†åœ¨ä¸€èµ·ï¼Œå¹¶ä»æ¯ä¸ªç¼“å­˜ä¸­é‡‡æ ·tokenã€‚</li> </ul> <p>æ¯ä¸ªKVç¼“å­˜å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¤§å°ä¸º<d-math>[2, S, L, K, H]</d-math>çš„æ•°ç»„ï¼Œå…¶ä¸­2ä»£è¡¨é”®å’Œå€¼ã€‚è¿™ç›¸å½“å¤§ï¼ä»¥int8æ ¼å¼å­˜å‚¨çš„é”®å€¼ç¼“å­˜æ€»å¤§å°ä¸º<d-math>2SLKH</d-math>ã€‚å¯¹äºä¸€ä¸ªä¸­ç­‰è§„æ¨¡çš„æ¨¡å‹ï¼Œä¸Šä¸‹æ–‡é•¿åº¦ä¸º8kï¼Œæœ‰64å±‚ï¼Œä¸”<d-math>KH = NH = D = 8192</d-math>ï¼Œè¿™å°†æ˜¯<d-math>2 \cdot 8192 \cdot 64 \cdot 8192 = 8\text{GiB}</d-math>ã€‚ä½ å¯ä»¥çœ‹åˆ°ä¸ºä»€ä¹ˆæˆ‘ä»¬æƒ³è¦ä½¿ç”¨GMQAï¼Œå…¶ä¸­<d-math>K \ll N</d-math>ã€‚</p> <h2 id="what-should-you-take-away-from-this-section">æœ¬èŠ‚è¦ç‚¹æ€»ç»“</h2> <ul> <li>Transformerçš„æ€»ä½“å‚æ•°å’ŒFLOPsç›¸å½“å®¹æ˜“è®¡ç®—ï¼Œæ€»ç»“å¦‚ä¸‹ï¼Œå‡è®¾ä¸ºMHAï¼ˆæ‰¹å¤§å°ä¸ºBï¼Œè¯æ±‡è¡¨å¤§å°ä¸ºVï¼Œåºåˆ—é•¿åº¦ä¸ºTï¼ŒD=d<sub>model</sub>ï¼ŒF=d<sub>ff</sub>ï¼‰ï¼š</li> </ul> <table class="table-hover" data-toggle="table"> <thead> <tr> <th style="text-align: left">ç»„ä»¶</th> <th style="text-align: left">æ¯å±‚å‚æ•°</th> <th style="text-align: left">æ¯å±‚è®­ç»ƒFLOPs</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><strong>MLP</strong></td> <td style="text-align: left">3DF</td> <td style="text-align: left">18BTDF</td> </tr> <tr> <td style="text-align: left"><strong>æ³¨æ„åŠ›</strong></td> <td style="text-align: left">4DNH</td> <td style="text-align: left">24BTDNH + 12BT<sup>2</sup>NH</td> </tr> <tr> <td style="text-align: left"><strong>å…¶ä»–</strong></td> <td style="text-align: left">D</td> <td style="text-align: left">BTD</td> </tr> <tr> <td style="text-align: left"><strong>è¯æ±‡è¡¨</strong></td> <td style="text-align: left">DVï¼ˆæ€»è®¡ï¼Œéæ¯å±‚ï¼‰</td> <td style="text-align: left">12BTDV</td> </tr> </tbody> </table> <ul> <li>MLPå—çš„å‚æ•°æ•°é‡åœ¨æ€»å‚æ•°æ•°é‡ä¸­å ä¸»å¯¼åœ°ä½ï¼Œå¹¶ä¸”åªè¦åºåˆ—é•¿åº¦<d-math>T &lt; 8D</d-math>ï¼ŒMLPå—ä¹Ÿä¸»å¯¼FLOPsé¢„ç®—ã€‚</li> <li>å¯¹äºåˆç†çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œè®­ç»ƒæœŸé—´çš„æ€»FLOPsé¢„ç®—å¯ä»¥å¾ˆå¥½åœ°ç”¨\(6 \cdot \text{num_params} \cdot \text{num_tokens}\)æ¥è¿‘ä¼¼ã€‚</li> <li>åœ¨æ¨ç†æœŸé—´ï¼Œæˆ‘ä»¬çš„KVç¼“å­˜å¤§çº¦æ˜¯æ¯ä¸ªç¼“å­˜\(2 \cdot S \cdot L \cdot N \cdot H\)ï¼Œå°½ç®¡æ¶æ„ä¸Šçš„ä¿®æ”¹é€šå¸¸å¯ä»¥å‡å°‘è¿™ä¸ªå€¼ã€‚</li> </ul> <h2 id="a-few-problems-to-work">å‡ ä¸ªç»ƒä¹ é¢˜</h2> <p><strong>é—®é¢˜1ï¼š</strong> ä¸€ä¸ªæ¨¡å‹ï¼Œå…¶<d-math>D=4096</d-math>ï¼Œ<d-math>F=4 \cdot D</d-math>ï¼Œ<d-math>V=32,000</d-math>ï¼Œ<d-math>L=64</d-math>ï¼Œæœ‰å¤šå°‘å‚æ•°ï¼Ÿå…¶ä¸­æ³¨æ„åŠ›å‚æ•°å å¤šå¤§æ¯”ä¾‹ï¼Ÿæ¯ä¸ªtokençš„KVç¼“å­˜æœ‰å¤šå¤§ï¼Ÿ<em>ä½ å¯ä»¥å‡è®¾<d-math>N\cdot H=D</d-math>å’Œå¤šå¤´æ³¨æ„åŠ›ï¼Œä½¿ç”¨int8 KVsã€‚</em></p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <ol> <li>æ€»å‚æ•°å¤§çº¦æ˜¯ \(L \cdot (3DF + 4DNH + D) + 2DV\)ã€‚å¯¹äºç»™å®šçš„æ•°å­—ï¼Œè¿™æ˜¯ \(64 \cdot (3 \cdot 4e3 \cdot 16e3 + 4 \cdot 4e3 \cdot 4e3 + 4e3) + 2 \cdot 4e3 \cdot 32e3 = 16e9\)ï¼Œå³16Bå‚æ•°ã€‚</li> <li>æ³¨æ„åŠ›å‚æ•°ä¸æ€»å‚æ•°çš„æ¯”ä¾‹é€šå¸¸æ˜¯ \(4DNH / (4DNH + 3DF) = 4D^2 / (4D^2 + 12D^2) = 1/4\)ã€‚è¿™å‘Šè¯‰æˆ‘ä»¬å¤§çº¦1/4çš„å‚æ•°ç”¨äºæ³¨æ„åŠ›ã€‚</li> <li>æ¯ä¸ªtokenï¼Œæˆ‘ä»¬çš„KVç¼“å­˜æ˜¯ \(2 \cdot L \cdot N \cdot H = 2 \cdot 64 \cdot 4096\)ï¼ˆint8æ ¼å¼ï¼‰ï¼Œå³<code class="language-plaintext highlighter-rouge">512kB / token</code>ã€‚</li> </ol> </details> <p><strong>é—®é¢˜2ï¼š</strong> åœ¨<code class="language-plaintext highlighter-rouge">{'X': 4, 'Y': 8, 'Z': 4}</code>ä¸Šæ‰§è¡Œ A[B<sub>X</sub>, D<sub>Y</sub>] *<sub>D</sub> W[D<sub>Y</sub>, F] éœ€è¦å¤šå°‘æ€»FLOPsï¼Ÿæ¯ä¸ªTPUæ‰§è¡Œå¤šå°‘FLOPsï¼Ÿ</p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>è¯¥æ“ä½œçš„æ€»â€œç†è®ºâ€FLOPsæ˜¯ \(2 \cdot B \cdot D \cdot F\)ã€‚ç„¶è€Œï¼Œå› ä¸ºè®¡ç®—æ²¡æœ‰åœ¨Zç»´åº¦ä¸Šåˆ†ç‰‡ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¤šåšäº†Zå€çš„FLOPsï¼Œæ„å‘³ç€æ€»FLOPsä¸º \(2 \cdot B \cdot D \cdot F \cdot Z\)ã€‚ç”±äºè®¡ç®—åœ¨å…¶ä»–ç»´åº¦ä¸Šæ˜¯åˆ†ç‰‡çš„ï¼Œæ¯ä¸ªè®¾å¤‡çš„æ€»FLOPså¤§çº¦æ˜¯ \(2 \cdot B \cdot D \cdot F / (X \cdot Y)\)ã€‚</p> </details> <p><strong>é—®é¢˜3ï¼š</strong> æ‰§è¡Œ<d-math>A[I,J,K,L] * B[I,J,M,N,O] \rightarrow C[K,L,M,N,O]</d-math>æ¶‰åŠå¤šå°‘FLOPsï¼Ÿ</p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>éµå¾ªä¸Šè¿°è§„åˆ™ï¼Œæˆ‘ä»¬æœ‰Iå’ŒJä½œä¸ºæ”¶ç¼©ç»´åº¦ï¼ŒKã€Lã€Mã€Nå’ŒOä½œä¸ºéæ”¶ç¼©ç»´åº¦ã€‚æˆ‘ä»¬æ²¡æœ‰â€œæ‰¹å¤„ç†ç»´åº¦â€ï¼Œæ‰€ä»¥è¿™åªæ˜¯ \(2 \cdot I \cdot J \cdot K \cdot L \cdot M \cdot N \cdot O\)ï¼Œå³æ‰€æœ‰è½´çš„ä¹˜ç§¯ä¹‹å’Œã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå…±äº«è½´ï¼Œå®ƒåªä¼šè¢«è®¡ç®—ä¸€æ¬¡ã€‚</p> </details> <p><strong>é—®é¢˜4ï¼š</strong> è‡ªæ³¨æ„åŠ›çš„ç®—æœ¯å¼ºåº¦æ˜¯å¤šå°‘ï¼ˆå¿½ç•¥Q/K/V/OæŠ•å½±ï¼‰ï¼Ÿ<em>ä»¥Qå’ŒKVé•¿åº¦Tå’ŒSçš„å‡½æ•°å½¢å¼ç»™å‡ºç­”æ¡ˆã€‚</em> åœ¨ä»€ä¹ˆä¸Šä¸‹æ–‡é•¿åº¦ä¸‹ï¼Œæ³¨æ„åŠ›æ˜¯FLOPså—é™çš„ï¼Ÿç»™å®šæˆ‘ä»¬TPUçš„HBMå¸¦å®½ï¼Œç»˜åˆ¶éšç€ä¸Šä¸‹æ–‡é•¿åº¦å¢é•¿ï¼Œæ³¨æ„åŠ›ä¸FFWå—çš„æœ‰æ•ˆç›¸å¯¹æˆæœ¬å›¾ã€‚</p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>è‡ªæ³¨æ„åŠ›éœ€è¦åŠ è½½\(Q\)ã€\(K\)å’Œ\(V\)æ¿€æ´»ï¼Œç„¶åè®¡ç®—\(\text{softmax}(Q \cdot K) \cdot V\)ï¼Œç„¶åå°†ç»“æœå†™å›HBMã€‚è¿™å°†ä½¿ç”¨Flash Attentionå®Œæˆï¼Œæ‰€ä»¥è¿™ä¸ªæ•°å­¦è®¡ç®—æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œä½†åŸºæœ¬ä¸Šåœ¨bf16ä¸­ï¼Œè‡ªæ³¨æ„åŠ›æ‰§è¡Œ</p> \[\text{Q[B,T,N,H]} \rightarrow_\text{reshape} \text{Q[B, T, K, G, H]} \cdot \text{K[B, S, K, H]} \rightarrow \text{O[B, T, S, K, G]}\] \[U=\text{softmax}_S(\text{O[B, T, S, K, G]}) \] \[\text{U[B, T, S, K, G]} \cdot \text{V[B, S, K, H]} \rightarrow \text{X[B, T, K, G, H]}\] <p>æ‰€ä»¥æˆ‘ä»¬çš„æ€»å­—èŠ‚æ•°æ˜¯ \(2 * \text{sizeof}(Q) + 2 * \text{sizeof(K or V)} = 4BTNH + 4BSKH = 4BHK * (TG + S)\)ï¼Œæ€»FLOPsæ˜¯ \(4BTSNH + O(BTSN)\)ï¼Œç®—æœ¯å¼ºåº¦æ˜¯ \(4BTSKGH / (4BHK * (TG + S))\)ã€‚</p> <p>æ‰€ä»¥åŸºæœ¬ä¸Šï¼Œåœ¨é¢„å¡«å……æœŸé—´ï¼Œæˆ‘ä»¬æœ‰\(S=T\)ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç®—æœ¯å¼ºåº¦æ˜¯\(4BT^2KGH / 4BHKT \cdot (G+1) = TG/(G + 1) = O(T)\)ã€‚åœ¨ç”ŸæˆæœŸé—´ï¼Œ\(T=1\)ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰\(4BSKGH / (4BHK \cdot (G + S)) = SG / (G + S) \rightarrow G\)ï¼Œå‡è®¾\(S\)éå¸¸å¤§ã€‚æ ¹æ®ä½ å¦‚ä½•è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œåœ¨é¢„å¡«å……æˆ–è®­ç»ƒæœŸé—´ï¼Œå‡è®¾æ²¡æœ‰åºåˆ—åˆ†ç‰‡ï¼Œè‡ªæ³¨æ„åŠ›åœ¨S=240æ—¶æ˜¯è®¡ç®—å—é™çš„ã€‚åœ¨ç”ŸæˆæœŸé—´ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šæ˜¯è®¡ç®—å—é™çš„ï¼Œå› ä¸º\(G\)å¾ˆå°ã€‚ç„¶è€Œï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œå¢åŠ \(G\)ä¼šä½¿æˆ‘ä»¬æ›´æ¥è¿‘è®¡ç®—å—é™ã€‚</p> </details> <p><strong>é—®é¢˜5ï¼š</strong> åœ¨ä»€ä¹ˆåºåˆ—é•¿åº¦ä¸‹ï¼Œè‡ªæ³¨æ„åŠ›çš„FLOPsç­‰äºQKVOæŠ•å½±çš„FLOPsï¼Ÿ</p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>è¿™çº¯ç²¹æ˜¯å…³äºä½•æ—¶\(24BTDNH == 12BT^2NH\)çš„é—®é¢˜ã€‚ç®€åŒ–åæˆ‘ä»¬å¾—åˆ°\(2D = T\)ï¼Œä¾‹å¦‚å¯¹äº\(D=4096\)ï¼Œè¿™æ˜¯\(8192\)ã€‚è¿™å‘Šè¯‰æˆ‘ä»¬ï¼Œå¯¹äºå¤§å¤šæ•°åˆç†çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼ŒçŸ©é˜µä¹˜æ³•çš„FLOPsæ›´å¤§ã€‚</p> </details> <p><strong>é—®é¢˜6ï¼š</strong> å‡è®¾æˆ‘ä»¬åœ¨å‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­åªä¿å­˜Transformerå±‚ä¸­7ä¸ªä¸»è¦çŸ©é˜µä¹˜æ³•ï¼ˆQ, K, V, O + ä¸‰ä¸ªFFWçŸ©é˜µï¼‰çš„è¾“å‡ºã€‚åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦â€œé‡æ–°ç‰©åŒ–â€å¤šå°‘é¢å¤–çš„FLOPsï¼Ÿ</p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>åªä¿å­˜ä¸ƒä¸ªçŸ©é˜µä¹˜æ³•çš„è¾“å‡ºï¼ˆQ, K, V, O, Wâ‚, Wâ‚‚, Wâ‚ƒï¼‰æ„å‘³ç€åå‘ä¼ æ’­å¿…é¡»é‡æ–°è®¡ç®—ä¸¤ä¸ªæ³¨æ„åŠ›çŸ©é˜µä¹˜æ³•</p> \[QK^{\top} \quad\text{å’Œ}\quad \operatorname{softmax}(QK^{\top})V.\] <p>æ¯ä¸ªéƒ½æ˜¯åœ¨\(B\)ä¸ªåºåˆ—å’Œ\(N\)ä¸ªå¤´ä¸Šæ‰¹å¤„ç†çš„\(T \times T\)çŸ©é˜µä¹˜æ³•ï¼Œæ‰€ä»¥é¢å¤–çš„FLOPsæ˜¯</p> \[4 \; B \, T^{2} \, N \, H.\] <p>æ‰€æœ‰å…¶ä»–é‡æ–°è®¡ç®—çš„æ“ä½œéƒ½åªæ˜¯\(O(BTD)\)ã€‚</p> </details> <p><strong>é—®é¢˜7ï¼š</strong> DeepSeek v3å£°ç§°å®ƒåœ¨14.8Tä¸ªtokenä¸Šè®­ç»ƒäº†279ä¸‡H800å°æ—¶ï¼ˆ<a href="https://arxiv.org/pdf/2412.19437v1" rel="external nofollow noopener" target="_blank">æ¥æº</a>ï¼‰ã€‚é‰´äºå®ƒæœ‰37Bä¸ªæ¿€æ´»å‚æ•°ï¼Œä»–ä»¬å¤§è‡´è¾¾åˆ°äº†ä»€ä¹ˆæ ·çš„ç¡¬ä»¶åˆ©ç”¨ç‡ï¼Ÿ<em>æç¤ºï¼šæ³¨æ„ä»–ä»¬ä½¿ç”¨äº†æ²¡æœ‰ç»“æ„åŒ–ç¨€ç–æ€§çš„FP8 FLOPsã€‚</em></p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>ä»è§„æ ¼è¡¨<a href="https://lenovopress.lenovo.com/lp1814.pdf" rel="external nofollow noopener" target="_blank">è¿™é‡Œ</a>ï¼Œæˆ‘ä»¬å‘ç°å¸¦ç¨€ç–æ€§çš„FP8æ€§èƒ½ä¸º3,026 TFLOPs/sï¼Œæˆ–è€…é€šå¸¸ä¸å¸¦ç¨€ç–æ€§æ—¶æ˜¯è¿™ä¸ªå€¼çš„ä¸€åŠï¼ˆ<code class="language-plaintext highlighter-rouge">1.513e15</code> FLOPs/sï¼‰ã€‚279ä¸‡H800å°æ—¶æ„å‘³ç€<code class="language-plaintext highlighter-rouge">2.79e6 * 1.513e15 * 60 * 60 = 1.52e25</code>æ€»FLOPsã€‚é‰´äºæ¿€æ´»å‚æ•°æ•°é‡ä¸º37Bï¼Œè¿™æ¬¡è®­ç»ƒè¿è¡Œåº”è¯¥ä½¿ç”¨äº†å¤§çº¦<code class="language-plaintext highlighter-rouge">6 * 37e9 * 14.8e12 = 3.3e24</code> FLOPsã€‚è¿™æ„å‘³ç€FLOPsåˆ©ç”¨ç‡å¤§çº¦æ˜¯<code class="language-plaintext highlighter-rouge">3.3e24 / 1.52e25 = 21.7%</code>ã€‚</p> </details> <p><strong>é—®é¢˜8ï¼š</strong> ä¸“å®¶æ··åˆï¼ˆMoEï¼‰æ¨¡å‹æœ‰\(E\)ä¸ªæ ‡å‡†å¯†é›†MLPå—çš„å‰¯æœ¬ï¼Œæ¯ä¸ªtokenæ¿€æ´»å…¶ä¸­\(k\)ä¸ªä¸“å®¶ã€‚åœ¨TPU v5eä¸Šï¼Œå¯¹äºæƒé‡ä¸ºint8çš„MoEï¼Œéœ€è¦å¤šå¤§çš„æ‰¹å¤§å°ï¼ˆä»¥tokenä¸ºå•ä½ï¼‰æ‰èƒ½è¾¾åˆ°è®¡ç®—å—é™ï¼Ÿå¯¹äºæœ‰256ä¸ªï¼ˆè·¯ç”±ï¼‰ä¸“å®¶ä¸”\(k=8\)çš„DeepSeekï¼Œè¿™ä¸ªæ•°å­—æ˜¯å¤šå°‘ï¼Ÿ</p> <details><summary>ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>å› ä¸ºæˆ‘ä»¬æœ‰\(E\)ä¸ªæ¯ä¸ªä¸“å®¶çš„å‰¯æœ¬ï¼Œåœ¨int8ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åŠ è½½\(E \cdot D \cdot F\)å­—èŠ‚ã€‚å› ä¸ºæ¯ä¸ªtokenæ¿€æ´»\(k\)ä¸ªä¸“å®¶ï¼Œæˆ‘ä»¬æœ‰\(2\cdot k \cdot B \cdot D \cdot F\) FLOPsã€‚è¦ä½¿ç”¨bfloat16 FLOPsè¾¾åˆ°è®¡ç®—å—é™ï¼Œæˆ‘ä»¬éœ€è¦ç®—æœ¯å¼ºåº¦è¶…è¿‡240ï¼Œè¿™å‘ç”Ÿåœ¨\((2\cdot k \cdot BDF) / EDF &gt; 240\)æˆ–\(k \cdot B / E &gt; 120\)æ—¶ã€‚</p> <p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦\(B &gt; 120 \cdot E / k\)æ‰èƒ½è¾¾åˆ°è®¡ç®—å—é™ã€‚å¯¹äºDeepSeekï¼Œè¿™ç»™æˆ‘ä»¬\(B &gt; 120 \cdot 256 / 8 = 3840\)ã€‚è¿™åœ¨ç”Ÿæˆæ—¶æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ‰¹å¤§å°ã€‚</p> </details> <h3 class="next-section">ç¬¬4éƒ¨åˆ†åˆ°æ­¤ç»“æŸï¼å…³äºç¬¬5éƒ¨åˆ†ï¼ˆæ‰©å±•Transformerè®­ç»ƒï¼‰ï¼Œ<a href="training.html">è¯·ç‚¹å‡»è¿™é‡Œ</a>ï¼</h3> <h2 id="appendix">é™„å½•</h2> <h3 id="appendix-a-how-does-flash-attention-work">é™„å½•Aï¼šFlash Attentionæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h3> <p>å°†Transformeræ‰©å±•åˆ°éå¸¸é•¿çš„ä¸Šä¸‹æ–‡çš„ä¼ ç»Ÿåå¯¹æ„è§æ˜¯ï¼Œæ³¨æ„åŠ›çš„FLOPså’Œå†…å­˜ä½¿ç”¨é‡éšä¸Šä¸‹æ–‡é•¿åº¦å‘ˆäºŒæ¬¡æ–¹å¢é•¿ã€‚è™½ç„¶æ³¨æ„åŠ›QKä¹˜ç§¯çš„å½¢çŠ¶ç¡®å®æ˜¯<d-math>[B, S, T, N]</d-math>ï¼ˆå…¶ä¸­Bæ˜¯æ‰¹å¤§å°ï¼ŒSå’ŒTæ˜¯Qå’ŒKçš„åºåˆ—ç»´åº¦ï¼ŒNæ˜¯å¤´çš„æ•°é‡ï¼‰ï¼Œä½†è¿™ä¸€è¯´æ³•å¸¦æœ‰ä¸€äº›é‡è¦çš„æ³¨æ„äº‹é¡¹ï¼š</p> <ol> <li>æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬4èŠ‚ä¸­æŒ‡å‡ºçš„ï¼Œå³ä½¿è¿™æ˜¯äºŒæ¬¡æ–¹çš„ï¼Œæ³¨æ„åŠ›çš„FLOPsä¹Ÿåªæœ‰åœ¨\(S &gt; 8 \cdot D\)æ—¶æ‰å ä¸»å¯¼åœ°ä½ï¼Œç‰¹åˆ«æ˜¯åœ¨è®­ç»ƒæœŸé—´ï¼Œå•ä¸ªæ³¨æ„åŠ›çŸ©é˜µçš„å†…å­˜ä¸å†…å­˜ä¸­å­˜åœ¨çš„æ‰€æœ‰æƒé‡å’Œæ¿€æ´»æ£€æŸ¥ç‚¹ç›¸æ¯”æ˜¯å¾ˆå°çš„ï¼Œå°¤å…¶æ˜¯åœ¨åˆ†ç‰‡çš„æƒ…å†µä¸‹ã€‚</li> <li>æˆ‘ä»¬ä¸éœ€è¦ä¸ºäº†è®¡ç®—æ³¨æ„åŠ›è€Œç‰©åŒ–æ•´ä¸ªæ³¨æ„åŠ›çŸ©é˜µï¼æˆ‘ä»¬å¯ä»¥è®¡ç®—å±€éƒ¨å’Œä¸æœ€å¤§å€¼ï¼Œä»è€Œé¿å…ç‰©åŒ–è¶…è¿‡ä¸€å°å—æ•°ç»„ã€‚è™½ç„¶æ€»FLOPsä»ç„¶æ˜¯äºŒæ¬¡æ–¹çš„ï¼Œä½†æˆ‘ä»¬å¤§å¤§å‡å°‘äº†å†…å­˜å‹åŠ›ã€‚</li> </ol> <p>è¿™ç¬¬äºŒä¸ªè§‚å¯Ÿé¦–å…ˆç”±<a href="https://arxiv.org/abs/2112.05682" rel="external nofollow noopener" target="_blank">Rabeç­‰äººäº2021å¹´</a>æå‡ºï¼Œåæ¥åœ¨<a href="https://arxiv.org/abs/2205.14135" rel="external nofollow noopener" target="_blank">Flash Attentionè®ºæ–‡</a>ï¼ˆDaoç­‰äººï¼Œ2022å¹´ï¼‰ä¸­å†æ¬¡æå‡ºã€‚åŸºæœ¬æ€æƒ³æ˜¯å°†K/Våˆ†å—è®¡ç®—æ³¨æ„åŠ›ï¼Œæˆ‘ä»¬è®¡ç®—å±€éƒ¨çš„softmaxå’Œä¸€äº›è¾…åŠ©ç»Ÿè®¡æ•°æ®ï¼Œç„¶åå°†å®ƒä»¬ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå—ï¼Œåè€…å°†å…¶ä¸è‡ªå·±çš„å±€éƒ¨åˆ†å—ç»“åˆèµ·æ¥ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬è®¡ç®—</p> <ol> <li> <strong>Mï¼š</strong> \(q \cdot k\)åœ¨åºåˆ—ç»´åº¦ä¸Šçš„è¿è¡Œæœ€å¤§å€¼</li> <li> <strong>Oï¼š</strong> åœ¨åºåˆ—ç»´åº¦ä¸Šçš„è¿è¡Œå®Œæ•´æ³¨æ„åŠ›softmax</li> <li> <strong>Lï¼š</strong> è¿è¡Œåˆ†æ¯\(\sum_i (q \cdot k_i - \text{running max})\)</li> </ol> <p>æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬åªéœ€æ’å®šçš„å†…å­˜é‡å°±å¯ä»¥è®¡ç®—å‡ºæ–°çš„æœ€å¤§å€¼ã€æ–°çš„è¿è¡Œæ€»å’Œå’Œæ–°çš„è¾“å‡ºã€‚ä¸ºäº†ç²—ç•¥åœ°æè¿°è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæ³¨æ„åŠ›å¤§è‡´æ˜¯è¿™ä¸ªæ“ä½œï¼š</p><span> \[\text{Attn}(Q, K, V) = \sum_i \frac{\exp(Q \cdot K_i - \max_j Q \cdot K_j) V_i}{\sum_l \exp(Q \cdot K_l - \max_j Q \cdot K_j)}\] </span><p>å‡å»æœ€å¤§å€¼æ˜¯ä¸ºäº†æ•°å€¼ç¨³å®šæ€§ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸å½±å“ç»“æœçš„æƒ…å†µä¸‹æ·»åŠ ï¼Œå› ä¸º\(\sum_i \exp(a_i + b) = \exp(b) \sum \exp(a)\)ã€‚åªçœ‹ä¸Šé¢çš„åˆ†æ¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è±¡æœ‰ä¸¤ä¸ªè¿ç»­çš„é”®å‘é‡å—ï¼Œ\(K^1\)å’Œ\(K^2\)ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸ºæ¯ä¸ªå—è®¡ç®—å±€éƒ¨softmaxå’Œ\(L^1\)å’Œ\(L^2\)</p><span> \[L^1 = \sum_i \exp(Q \cdot K_i^1 - \max_j Q \cdot K_j^1)\] \[L^2 = \sum_i \exp(Q \cdot K_i^2 - \max_j Q \cdot K_j^2)\] </span><p>ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ä»¥ä¸‹å…¬å¼å°†å®ƒä»¬ç»„åˆæˆè¿™ä¸¤ä¸ªå—çš„å®Œæ•´softmaxå’Œ</p><span> \[L^\text{combined} = \exp(M^1 - \max(M^1, M^2)) \cdot L^1 + \exp(M^2 - \max(M^1, M^2)) \cdot L^2\] </span><p>å…¶ä¸­</p><span> \[M^1 = \max_j Q \cdot K_j^1 \text{ and } M^2 = \max_j Q \cdot K_j^2\] </span><p>è¿™ä¹Ÿå¯ä»¥å¯¹æ•´ä¸ªsoftmaxè¿›è¡Œï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§ç´¯ç§¯ä»»æ„å¤§softmaxå’Œçš„æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯Flash Attentionè®ºæ–‡ä¸­çš„å®Œæ•´ç®—æ³•ã€‚</p> <figure> <picture> <source class="responsive-img-srcset" sizes="95vw" srcset="https://jax-ml.github.io/scaling-book/assets/img/flash-algo-480.webp 480w, https://jax-ml.github.io/scaling-book/assets/img/flash-algo-800.webp 800w, https://jax-ml.github.io/scaling-book/assets/img/flash-algo-1400.webp 1400w" type="image/webp"/> <img class="img-fluid" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" src="https://jax-ml.github.io/scaling-book/assets/img/flash-algo.png" width="100%"/> </picture> </figure> <p>ä»ç¡¬ä»¶çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†Qçš„å—æ”¾å…¥VMEMï¼ˆä¸Šè¿°ç®—æ³•ç§°ä¹‹ä¸ºç‰‡ä¸ŠSRAMï¼‰ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€åœ¨æ¯æ¬¡è¿­ä»£æ—¶åŠ è½½KVå—ï¼Œä»è€Œé™ä½äº†ç®—æœ¯å¼ºåº¦ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿è¡Œç»Ÿè®¡ä¿¡æ¯ä¿å­˜åœ¨VMEMä¸­ã€‚</p> <p>æœ€åä¸€ä¸ªå€¼å¾—å¼ºè°ƒçš„å¾®å¦™ç‚¹æ˜¯æ³¨æ„åŠ›softmaxçš„ä¸€ä¸ªå±æ€§ï¼Œå®ƒè¢«ç”¨æ¥ä½¿Flash VJPï¼ˆåå‘æ¨¡å¼å¯¼æ•°ï¼‰è®¡ç®—åœ¨è®­ç»ƒä¸­å˜å¾—å¯è¡Œã€‚å¦‚æœæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªä¸­é—´softmaxæ•°ç»„ä¸ºï¼š</p><span> \[S_{ij} = \frac{e^{\tau q_i \cdot k_j}}{\sum_k e^{\tau q_i \cdot k_j}}\] </span><p>åœ¨æ³¨æ„åŠ›ä¸­ï¼Œæˆ‘ä»¬ä»åå‘æ¨¡å¼çš„<em>dO</em>å’Œ<em>V</em>æ•°ç»„ä¸­è·å¾—<em>dS</em>ï¼š</p><span> \[dS_{ij} = dO_{id} \cdot_d V_{jd} = \sum_d dO_{id} V_{jd}\] </span><p>åœ¨å°†æ­¤æ¢¯åº¦åå‘ä¼ æ’­åˆ°Qå’ŒKçš„è¿‡ç¨‹ä¸­</p><span> \[d(q_i \cdot k_j) = (dS_{ij} - S_{ij} \cdot_j dS_{ij}) S_{ij}\] </span><p>æˆ‘ä»¬åˆ©ç”¨ä¸€ä¸ªæ’ç­‰å¼ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†æ²¿å¤§é”®<strong>é•¿åº¦</strong>ç»´åº¦çš„æ”¶ç¼©ä¸æ²¿ç‰¹å¾<strong>æ·±åº¦</strong>ç»´åº¦çš„å±€éƒ¨æ”¶ç¼©è¿›è¡Œäº¤æ¢ã€‚</p><span> \[\begin{align*} S_{ij} \cdot_j dS_{ij} &amp;= \sum_j \frac{e^{\tau q_i \cdot k_j}}{\sum_k e^{\tau q_i \cdot k_k}} \sum_d dO_{id} V_{jd} \\ &amp;= \sum_d dO_{id} \sum_j \frac{e^{\tau q_i \cdot k_j}}{\sum_k e^{\tau q_i \cdot k_k}} V_{jd} \\ &amp;= \sum_d dO_{id} O_{id} \\ &amp;= dO_{id} \cdot_d O_{id} \end{align*}\] </span><p>è¿™ç§æ›¿æ¢å¯¹äºèƒ½å¤Ÿä¸ºVJPå®ç°åºåˆ—å—<em>å±€éƒ¨</em>è®¡ç®—è‡³å…³é‡è¦ï¼Œå¹¶ä½¿å¾—æ›´æ™ºèƒ½çš„åˆ†ç‰‡æ–¹æ¡ˆï¼ˆå¦‚ç¯å½¢æ³¨æ„åŠ›ï¼‰æˆä¸ºå¯èƒ½ã€‚</p> </d-article> <d-appendix>
<style>

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

</style>
<d-footnote-list style="">
<style>

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}

</style>
<h3>è„šæ³¨</h3>
<ol><li id="d-footnote-1-listing">ä¸¥æ ¼æ¥è¯´ï¼Œè¿™åªåœ¨æˆ‘ä»¬æ²¿ä¸“å®¶æ‰€åœ¨çš„åŒä¸€è½´è¿›è¡Œæ•°æ®æˆ–åºåˆ—åˆ†ç‰‡æ—¶æ‰ä¼šå‘ç”Ÿã€‚<a class="footnote-backlink" href="#d-footnote-1">[â†©]</a></li></ol>
</d-footnote-list> <d-citation-list style=""><style>
d-citation-list {
  contain: style;
}

d-citation-list .references {
  grid-column: text;
}

d-citation-list .references .title {
  font-weight: 500;
}
</style><h3 id="references">å‚è€ƒæ–‡çŒ®</h3><ol class="references" id="references-list"><li id="glu"><span class="title">GLU Variants Improve Transformer</span> <br/>Shazeer, N., 2020. arXiv [cs.LG]. </li><li id="mqa"><span class="title">Fast Transformer decoding: One write-head is all you need</span> <br/>Noam, S., 2019. arXiv [cs.NE]. </li><li id="gmqa"><span class="title">GQA: Training generalized multi-query transformer models from multi-head checkpoints</span> <br/>Ainslie, J., Lee-Thorp, J., de Jong, M., Zemlyanskiy, Y., LebrÃ³n, F. and Sanghai, S., 2023. arXiv [cs.CL]. </li><li id="moe"><span class="title">Outrageously large neural networks: The Sparsely-Gated Mixture-of-experts layer</span> <br/>Shazeer, N., Mirhoseini, A., Maziarz, K., Davis, A., Le, Q., Hinton, G. and Dean, J., 2017. arXiv [cs.LG]. </li></ol></d-citation-list> <div class="base-grid appendix-entry"> <h3 style="grid-column: 0;">å…¶ä»–</h3> <p class="author-footnote" style="grid-column: text;"><sup>*</sup>åœ¨Google DeepMindå·¥ä½œï¼Œç°å°±èŒäºMatXã€‚</p> </div> <div class="base-grid appendix-entry"> <h3 style="grid-column: 0;">å¼•ç”¨</h3> <p class="author-footnote">åœ¨å­¦æœ¯èƒŒæ™¯ä¸‹å¼•ç”¨ï¼Œè¯·æŒ‰å¦‚ä¸‹æ–¹å¼å¼•ç”¨æœ¬ä½œå“ï¼š</p> <div class="author-footnote"> <div class="language-bibtex highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code>    <span class="c">Austin et al., "How to Scale Your Model", Google DeepMind, online, 2025.</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> </div> <p class="author-footnote">æˆ–ä½œä¸ºBibTeXæ¡ç›®ï¼š</p> <div class="author-footnote"> <div class="language-bibtex highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code>    <span class="nc">@article</span><span class="p">{</span><span class="nl">scaling-book</span><span class="p">,</span>
      <span class="na">title</span> <span class="p">=</span> <span class="s">{How to Scale Your Model}</span><span class="p">,</span>
      <span class="na">author</span> <span class="p">=</span> <span class="s">{Austin, Jacob and Douglas, Sholto and Frostig, Roy and Levskaya, Anselm and Chen, Charlie and Vikram, Sharad
      and Lebron, Federico and Choy, Peter and Ramasesh, Vinay and Webson, Albert and Pope, Reiner}</span><span class="p">,</span>
      <span class="na">publisher</span> <span class="p">=</span> <span class="s">{Google DeepMind}</span><span class="p">,</span>
      <span class="na">howpublished</span> <span class="p">=</span> <span class="s">{Online}</span><span class="p">,</span>
      <span class="na">note</span> <span class="p">=</span> <span class="s">{Retrieved from https://jax-ml.github.io/scaling-book/}</span><span class="p">,</span>
      <span class="na">year</span> <span class="p">=</span> <span class="s">{2025}</span>
    <span class="p">}</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> </div> </div> </d-appendix> <d-bibliography src="/scaling-book/assets/bibliography/main.bib"></d-bibliography> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>
      let giscusTheme = determineComputedTheme();
      let giscusAttributes = {
        src: 'https://giscus.app/client.js',
        'data-repo': 'jax-ml/scaling-book',
        'data-repo-id': '',
        'data-category': 'General',
        'data-category-id': '',
        'data-mapping': 'title',
        'data-strict': '0',
        'data-reactions-enabled': '1',
        'data-emit-metadata': '0',
        'data-input-position': 'bottom',
        'data-theme': giscusTheme,
        'data-loading': '1',
        'data-lang': 'en',
        crossorigin: 'anonymous',
        async: '',
      };

      let giscusScript = document.createElement('script');
      Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
      document.getElementById('giscus_thread').appendChild(giscusScript);
    </script><script async="" crossorigin="anonymous" data-category="General" data-category-id="" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-loading="1" data-mapping="title" data-reactions-enabled="1" data-repo="jax-ml/scaling-book" data-repo-id="" data-strict="0" data-theme="light" src="https://giscus.app/client.js"></script><div class="giscus"><iframe allow="clipboard-write" class="giscus-frame giscus-frame--loading" scrolling="no" src="https://giscus.app/en/widget?origin=https%3A%2F%2Fjax-ml.github.io%2Fscaling-book%2Ftransformers%2F&amp;session=&amp;theme=light&amp;reactionsEnabled=1&amp;emitMetadata=0&amp;inputPosition=bottom&amp;repo=jax-ml%2Fscaling-book&amp;repoId=&amp;category=General&amp;categoryId=&amp;strict=0&amp;description=Here+we%27ll+do+a+quick+review+of+the+Transformer+architecture%2C+specifically+how+to+calculate+FLOPs%2C+bytes%2C+and+other+quantities+of+interest.&amp;backLink=https%3A%2F%2Fjax-ml.github.io%2Fscaling-book%2Ftransformers%2F&amp;term=All+the+Transformer+Math+You+Need+to+Know+%7C+How+To+Scale+Your+Model" style="opacity: 0;" title="Comments"></iframe></div> <noscript>è¯·å¯ç”¨JavaScriptä»¥æŸ¥çœ‹ç”±giscusæ”¯æŒçš„<a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">è¯„è®ºã€‚</a> </noscript> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> Â© ç‰ˆæƒæ‰€æœ‰ 2025 . ç”± <a href="https://jekyllrb.com/" rel="external nofollow noopener" target="_blank">Jekyll</a> é©±åŠ¨ï¼Œä½¿ç”¨ <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> ä¸»é¢˜ã€‚ç”± <a href="https://pages.github.com/" rel="external nofollow noopener" target="_blank">GitHub Pages</a> æ‰˜ç®¡ã€‚ </div> </footer> <script crossorigin="anonymous" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/bootstrap.bundle.min.js"></script> <script crossorigin="anonymous" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js"></script> <script crossorigin="anonymous" defer="" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script crossorigin="anonymous" defer="" id="MathJax-script" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" type="text/javascript"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/mathjax-setup.js?70d799092f862ad98c7876aa47712e20"></script> <script crossorigin="anonymous" defer="" src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script><div class="hidden" id="back-to-top"><svg viewbox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div> <div class="hiddendiv common"></div></body>
</html>