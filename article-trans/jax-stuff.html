<!DOCTYPE html>

<html class="transition" data-theme="light" data-theme-setting="system" lang="zh-CN">
<head><link href="https://giscus.app/default.css" id="giscus-css" rel="stylesheet"/><style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:20px;margin:11px auto 0;width:20px}#back-to-top.hidden{bottom:-56px;opacity:0}</style> <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/> <meta charset="utf-8"/> <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/> <meta content="IE=edge" http-equiv="X-UA-Compatible"/> <title>JAX TPU ç¼–ç¨‹ï¼šå¦‚ä½•æ‰©å±•æ‚¨çš„æ¨¡å‹</title> <meta content=" " name="author"/> <meta content="äº†è§£å¦‚ä½•ä½¿ç”¨ JAX é«˜æ•ˆåœ°ä¸º TPU ç¼–ç¨‹ï¼æœ¬èŠ‚å¤§éƒ¨åˆ†å†…å®¹æ‘˜è‡ª&lt;a href='https://jax.readthedocs.io/en/latest/jep/14273-shard-map.html'&gt;æ­¤å¤„&lt;/a&gt;ã€‚æ‚¨å¯ä»¥åœ¨ &lt;a href='https://colab.sandbox.google.com/'&gt;Google Colab&lt;/a&gt; ä¸Šä½¿ç”¨å…è´¹çš„ TPU è¿è¡Œæœ¬èŠ‚ä¸­çš„ä»£ç ç¤ºä¾‹ã€‚" name="description"/> <meta content="scaling, jax, llms, transformers, tpus, google, deepmind, parallelism, pallas" name="keywords"/> <link href="https://jax-ml.github.io/scaling-book/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04" rel="stylesheet"/> <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" rel="stylesheet"/> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5" rel="stylesheet"/> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772" rel="stylesheet"/> <link defer="" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap" rel="stylesheet" type="text/css"/> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/jekyll-pygments-themes-vs.css?4ee1a2facd1a8a76347f4bd43a740500" id="highlight_theme_light" media="" rel="stylesheet"/> <link href="https://jax-ml.github.io/scaling-book/assets/img/favicon.png?fddbd8c2ec231ba2060e67c85de32a55" rel="shortcut icon"/> <link href="https://jax-ml.github.io/scaling-book/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e" rel="stylesheet"/> <link href="jax-stuff.html" rel="canonical"/> <style id="distill-prerendered-styles" type="text/css">/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

html {
  font-size: 14px;
	line-height: 1.6em;
  /* font-family: "Libre Franklin", "Helvetica Neue", sans-serif; */
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  /*, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";*/
  text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
}

@media(min-width: 768px) {
  html {
    font-size: 16px;
  }
}

body {
  margin: 0;
}

a {
  color: #004276;
}

figure {
  margin: 0;
}

table {
	border-collapse: collapse;
	border-spacing: 0;
}

table th {
	text-align: left;
}

table thead {
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

table thead th {
  padding-bottom: 0.5em;
}

table tbody :first-child td {
  padding-top: 0.5em;
}

pre {
  overflow: auto;
  max-width: 100%;
}

p {
  margin-top: 0;
  margin-bottom: 1em;
}

sup, sub {
  vertical-align: baseline;
  position: relative;
  top: -0.4em;
  line-height: 1em;
}

sub {
  top: 0.4em;
}

.kicker,
.marker {
  font-size: 15px;
  font-weight: 600;
  color: rgba(0, 0, 0, 0.5);
}


/* Headline */

@media(min-width: 1024px) {
  d-title h1 span {
    display: block;
  }
}

/* Figure */

figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

figcaption+figure {

}

figure img {
  width: 100%;
}

figure svg text,
figure svg tspan {
}

figcaption,
.figcaption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

@media(min-width: 1024px) {
figcaption,
.figcaption {
    font-size: 13px;
  }
}

figure.external img {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

figcaption a {
  color: rgba(0, 0, 0, 0.6);
}

figcaption b,
figcaption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

@supports not (display: grid) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    display: block;
    padding: 8px;
  }
}

.base-grid,
distill-header,
d-title,
d-abstract,
d-article,
d-appendix,
distill-appendix,
d-byline,
d-footnote-list,
d-citation-list,
distill-footer {
  display: grid;
  justify-items: stretch;
  grid-template-columns: [screen-start] 8px [page-start kicker-start text-start gutter-start middle-start] 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr [text-end page-end gutter-end kicker-end middle-end] 8px [screen-end];
  grid-column-gap: 8px;
}

.grid {
  display: grid;
  grid-column-gap: 8px;
}

@media(min-width: 768px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start middle-start text-start] 45px 45px 45px 45px 45px 45px 45px 45px [ kicker-end text-end gutter-start] 45px [middle-end] 45px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }
}

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 50px [middle-start] 50px [text-start kicker-end] 50px 50px 50px 50px 50px 50px 50px 50px [text-end gutter-start] 50px [middle-end] 50px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}




.base-grid {
  grid-column: screen;
}

/* .l-body,
d-article > *  {
  grid-column: text;
}

.l-page,
d-title > *,
d-figure {
  grid-column: page;
} */

.l-gutter {
  grid-column: gutter;
}

.l-text,
.l-body {
  grid-column: text;
}

.l-page {
  grid-column: page;
}

.l-body-outset {
  grid-column: middle;
}

.l-page-outset {
  grid-column: page;
}

.l-screen {
  grid-column: screen;
}

.l-screen-inset {
  grid-column: screen;
  padding-left: 16px;
  padding-left: 16px;
}


/* Aside */

d-article aside {
  grid-column: gutter;
  font-size: 12px;
  line-height: 1.6em;
  color: rgba(0, 0, 0, 0.6)
}

@media(min-width: 768px) {
  aside {
    grid-column: gutter;
  }

  .side {
    grid-column: gutter;
  }
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

d-title {
  padding: 2rem 0 1.5rem;
  contain: layout style;
  overflow-x: hidden;
}

@media(min-width: 768px) {
  d-title {
    padding: 4rem 0 1.5rem;
  }
}

d-title h1 {
  grid-column: text;
  font-size: 40px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

@media(min-width: 768px) {
  d-title h1 {
    font-size: 50px;
  }
}

d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  grid-column: text;
}

d-title .status {
  margin-top: 0px;
  font-size: 12px;
  color: #009688;
  opacity: 0.8;
  grid-column: kicker;
}

d-title .status span {
  line-height: 1;
  display: inline-block;
  padding: 6px 0;
  border-bottom: 1px solid #80cbc4;
  font-size: 11px;
  text-transform: uppercase;
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

d-byline {
  contain: style;
  overflow: hidden;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  font-size: 0.8rem;
  line-height: 1.8em;
  padding: 1.5rem 0;
  min-height: 1.8em;
}


d-byline .byline {
  grid-template-columns: 1fr 1fr;
  grid-column: text;
}

@media(min-width: 768px) {
  d-byline .byline {
    grid-template-columns: 1fr 1fr 1fr 1fr;
  }
}

d-byline .authors-affiliations {
  grid-column-end: span 3;
  grid-template-columns: 1fr 1fr 1fr;
  margin-bottom: 1em;
}

@media(min-width: 768px) {
  d-byline .authors-affiliations {
    margin-bottom: 0;
  }
}

d-byline h3 {
  font-size: 0.6rem;
  font-weight: 400;
  color: rgba(0, 0, 0, 0.5);
  margin: 0;
  text-transform: uppercase;
}

d-byline p {
  margin: 0;
}

d-byline a,
d-article d-byline a {
  color: rgba(0, 0, 0, 0.8);
  text-decoration: none;
  border-bottom: none;
}

d-article d-byline a:hover {
  text-decoration: underline;
  border-bottom: none;
}

d-byline p.author {
  font-weight: 500;
}

d-byline .affiliations {

}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

d-article {
  contain: layout style;
 border-top: 1px solid rgba(0, 0, 0, 0.1);
  padding-top: 2rem;
  color: rgba(0, 0, 0, 0.8);
}

d-article > * {
  grid-column: text;
}

@media(min-width: 768px) {
  d-article {
    font-size: 16px;
  }
}

@media(min-width: 1024px) {
  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
}


/* H2 */


d-article .marker {
  text-decoration: none;
  border: none;
  counter-reset: section;
  grid-column: kicker;
  line-height: 1.7em;
}

d-article .marker:hover {
  border: none;
}

d-article .marker span {
  padding: 0 3px 4px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  position: relative;
  top: 4px;
}

d-article .marker:hover span {
  color: rgba(0, 0, 0, 0.7);
  border-bottom: 1px solid rgba(0, 0, 0, 0.7);
}

d-article h2 {
  font-weight: 600;
  font-size: 24px;
  line-height: 1.25em;
  margin: 2rem 0 1.5rem 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding-bottom: 1rem;
}

@media(min-width: 1024px) {
  d-article h2 {
    font-size: 36px;
  }
}

/* H3 */

d-article h3 {
  font-weight: 700;
  font-size: 18px;
  line-height: 1.4em;
  margin-bottom: 1em;
  margin-top: 2em;
}

@media(min-width: 1024px) {
  d-article h3 {
    font-size: 20px;
  }
}

/* H4 */

d-article h4 {
  font-weight: 600;
  text-transform: uppercase;
  font-size: 14px;
  line-height: 1.4em;
}

d-article a {
  color: inherit;
}

d-article p,
d-article ul,
d-article ol,
d-article blockquote {
  margin-top: 0;
  margin-bottom: 1em;
  margin-left: 0;
  margin-right: 0;
}

d-article blockquote {
  border-left: 2px solid rgba(0, 0, 0, 0.2);
  padding-left: 2em;
  font-style: italic;
  color: rgba(0, 0, 0, 0.6);
}

d-article a {
  border-bottom: 1px solid var(--global-underline-color);
  text-decoration: none;
}

d-article a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.8);
}

d-article .link {
  text-decoration: underline;
  cursor: pointer;
}

d-article ul,
d-article ol {
  padding-left: 24px;
}

d-article li {
  margin-bottom: 1em;
  margin-left: 0;
  padding-left: 0;
}

d-article li:last-child {
  margin-bottom: 0;
}

d-article pre {
  font-size: 14px;
  margin-bottom: 20px;
}

d-article hr {
  grid-column: screen;
  width: 100%;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  margin-top: 60px;
  margin-bottom: 60px;
}

d-article section {
  margin-top: 60px;
  margin-bottom: 60px;
}

d-article span.equation-mimic {
  font-family: georgia;
  font-size: 115%;
  font-style: italic;
}

d-article > d-code,
d-article section > d-code  {
  display: block;
}

d-article > d-math[block],
d-article section > d-math[block]  {
  display: block;
}

@media (max-width: 768px) {
  d-article > d-code,
  d-article section > d-code,
  d-article > d-math[block],
  d-article section > d-math[block] {
      overflow-x: scroll;
      -ms-overflow-style: none;  // IE 10+
      overflow: -moz-scrollbars-none;  // Firefox
  }

  d-article > d-code::-webkit-scrollbar,
  d-article section > d-code::-webkit-scrollbar,
  d-article > d-math[block]::-webkit-scrollbar,
  d-article section > d-math[block]::-webkit-scrollbar {
    display: none;  // Safari and Chrome
  }
}

d-article .citation {
  color: #668;
  cursor: pointer;
}

d-include {
  width: auto;
  display: block;
}

d-figure {
  contain: layout style;
}

/* KaTeX */

.katex, .katex-prerendered {
  contain: style;
  display: inline-block;
}

/* Tables */

d-article table {
  border-collapse: collapse;
  margin-bottom: 1.5rem;
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
}

d-article table th {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
}

d-article table td {
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

d-article table tr:last-of-type td {
  border-bottom: none;
}

d-article table th,
d-article table td {
  font-size: 15px;
  padding: 2px 8px;
}

d-article table tbody :first-child td {
  padding-top: 2px;
}
/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

span.katex-display {
  text-align: left;
  padding: 8px 0 8px 0;
  margin: 0.5em 0 0.5em 1em;
}

span.katex {
  -webkit-font-smoothing: antialiased;
;
  font-size: 1.18em;
}

/*
 * Copyright 2018 The Distill Template Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

@media print {

  @page {
    size: 8in 11in;
    @bottom-right {
      content: counter(page) " of " counter(pages);
    }
  }

  html {
    /* no general margins -- CSS Grid takes care of those */
  }

  p, code {
    page-break-inside: avoid;
  }

  h2, h3 {
    page-break-after: avoid;
  }

  d-header {
    visibility: hidden;
  }

  d-footer {
    display: none!important;
  }

}
</style><script src="https://jax-ml.github.io/scaling-book/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer="" href="https://jax-ml.github.io/scaling-book/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" id="highlight_theme_dark" media="none" rel="stylesheet"/> <script>
    initTheme();
  </script> <script src="https://jax-ml.github.io/scaling-book/assets/js/distillpub/template.v2.js"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/distillpub/transforms.v2.js"></script> <style type="text/css">{{page._styles}}</style> <style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">.medium-zoom-overlay{position:fixed;top:0;right:0;bottom:0;left:0;opacity:0;transition:opacity .3s;will-change:opacity}.medium-zoom--opened .medium-zoom-overlay{cursor:pointer;cursor:zoom-out;opacity:1}.medium-zoom-image{cursor:pointer;cursor:zoom-in;transition:transform .3s cubic-bezier(.2,0,.2,1)!important}.medium-zoom-image--hidden{visibility:hidden}.medium-zoom-image--opened{position:relative;cursor:pointer;cursor:zoom-out;will-change:transform}</style><style type="text/css">.CtxtMenu_InfoClose {  top:.2em; right:.2em;}
.CtxtMenu_InfoContent {  overflow:auto; text-align:left; font-size:80%;  padding:.4em .6em; border:1px inset; margin:1em 0px;  max-height:20em; max-width:30em; background-color:#EEEEEE;  white-space:normal;}
.CtxtMenu_Info.CtxtMenu_MousePost {outline:none;}
.CtxtMenu_Info {  position:fixed; left:50%; width:auto; text-align:center;  border:3px outset; padding:1em 2em; background-color:#DDDDDD;  color:black;  cursor:default; font-family:message-box; font-size:120%;  font-style:normal; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 15px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius:15px;               /* Safari and Chrome */  -moz-border-radius:15px;                  /* Firefox */  -khtml-border-radius:15px;                /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */  filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color="gray", Positive="true"); /* IE */}
</style><style type="text/css">.CtxtMenu_MenuClose {  position:absolute;  cursor:pointer;  display:inline-block;  border:2px solid #AAA;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  font-family: "Courier New", Courier;  font-size:24px;  color:#F0F0F0}
.CtxtMenu_MenuClose span {  display:block; background-color:#AAA; border:1.5px solid;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  line-height:0;  padding:8px 0 6px     /* may need to be browser-specific */}
.CtxtMenu_MenuClose:hover {  color:white!important;  border:2px solid #CCC!important}
.CtxtMenu_MenuClose:hover span {  background-color:#CCC!important}
.CtxtMenu_MenuClose:hover:focus {  outline:none}
</style><style type="text/css">.CtxtMenu_Menu {  position:absolute;  background-color:white;  color:black;  width:auto; padding:5px 0px;  border:1px solid #CCCCCC; margin:0; cursor:default;  font: menu; text-align:left; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 5px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius: 5px;             /* Safari and Chrome */  -moz-border-radius: 5px;                /* Firefox */  -khtml-border-radius: 5px;              /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */}
.CtxtMenu_MenuItem {  padding: 1px 2em;  background:transparent;}
.CtxtMenu_MenuArrow {  position:absolute; right:.5em; padding-top:.25em; color:#666666;  font-family: null; font-size: .75em}
.CtxtMenu_MenuActive .CtxtMenu_MenuArrow {color:white}
.CtxtMenu_MenuArrow.CtxtMenu_RTL {left:.5em; right:auto}
.CtxtMenu_MenuCheck {  position:absolute; left:.7em;  font-family: null}
.CtxtMenu_MenuCheck.CtxtMenu_RTL { right:.7em; left:auto }
.CtxtMenu_MenuRadioCheck {  position:absolute; left: .7em;}
.CtxtMenu_MenuRadioCheck.CtxtMenu_RTL {  right: .7em; left:auto}
.CtxtMenu_MenuInputBox {  padding-left: 1em; right:.5em; color:#666666;  font-family: null;}
.CtxtMenu_MenuInputBox.CtxtMenu_RTL {  left: .1em;}
.CtxtMenu_MenuComboBox {  left:.1em; padding-bottom:.5em;}
.CtxtMenu_MenuSlider {  left: .1em;}
.CtxtMenu_SliderValue {  position:absolute; right:.1em; padding-top:.25em; color:#333333;  font-size: .75em}
.CtxtMenu_SliderBar {  outline: none; background: #d3d3d3}
.CtxtMenu_MenuLabel {  padding: 1px 2em 3px 1.33em;  font-style:italic}
.CtxtMenu_MenuRule {  border-top: 1px solid #DDDDDD;  margin: 4px 3px;}
.CtxtMenu_MenuDisabled {  color:GrayText}
.CtxtMenu_MenuActive {  background-color: #606872;  color: white;}
.CtxtMenu_MenuDisabled:focus {  background-color: #E8E8E8}
.CtxtMenu_MenuLabel:focus {  background-color: #E8E8E8}
.CtxtMenu_ContextMenu:focus {  outline:none}
.CtxtMenu_ContextMenu .CtxtMenu_MenuItem:focus {  outline:none}
.CtxtMenu_SelectionMenu {  position:relative; float:left;  border-bottom: none; -webkit-box-shadow:none; -webkit-border-radius:0px; }
.CtxtMenu_SelectionItem {  padding-right: 1em;}
.CtxtMenu_Selection {  right: 40%; width:50%; }
.CtxtMenu_SelectionBox {  padding: 0em; max-height:20em; max-width: none;  background-color:#FFFFFF;}
.CtxtMenu_SelectionDivider {  clear: both; border-top: 2px solid #000000;}
.CtxtMenu_Menu .CtxtMenu_MenuClose {  top:-10px; left:-10px}
</style><style id="MJX-CHTML-styles">
mjx-container[jax="CHTML"] {
  line-height: 0;
}

mjx-container [space="1"] {
  margin-left: .111em;
}

mjx-container [space="2"] {
  margin-left: .167em;
}

mjx-container [space="3"] {
  margin-left: .222em;
}

mjx-container [space="4"] {
  margin-left: .278em;
}

mjx-container [space="5"] {
  margin-left: .333em;
}

mjx-container [rspace="1"] {
  margin-right: .111em;
}

mjx-container [rspace="2"] {
  margin-right: .167em;
}

mjx-container [rspace="3"] {
  margin-right: .222em;
}

mjx-container [rspace="4"] {
  margin-right: .278em;
}

mjx-container [rspace="5"] {
  margin-right: .333em;
}

mjx-container [size="s"] {
  font-size: 70.7%;
}

mjx-container [size="ss"] {
  font-size: 50%;
}

mjx-container [size="Tn"] {
  font-size: 60%;
}

mjx-container [size="sm"] {
  font-size: 85%;
}

mjx-container [size="lg"] {
  font-size: 120%;
}

mjx-container [size="Lg"] {
  font-size: 144%;
}

mjx-container [size="LG"] {
  font-size: 173%;
}

mjx-container [size="hg"] {
  font-size: 207%;
}

mjx-container [size="HG"] {
  font-size: 249%;
}

mjx-container [width="full"] {
  width: 100%;
}

mjx-box {
  display: inline-block;
}

mjx-block {
  display: block;
}

mjx-itable {
  display: inline-table;
}

mjx-row {
  display: table-row;
}

mjx-row > * {
  display: table-cell;
}

mjx-mtext {
  display: inline-block;
}

mjx-mstyle {
  display: inline-block;
}

mjx-merror {
  display: inline-block;
  color: red;
  background-color: yellow;
}

mjx-mphantom {
  visibility: hidden;
}

_::-webkit-full-page-media, _:future, :root mjx-container {
  will-change: opacity;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-c::before {
  display: block;
  width: 0;
}

.MJX-TEX {
  font-family: MJXZERO, MJXTEX;
}

.TEX-B {
  font-family: MJXZERO, MJXTEX-B;
}

.TEX-I {
  font-family: MJXZERO, MJXTEX-I;
}

.TEX-MI {
  font-family: MJXZERO, MJXTEX-MI;
}

.TEX-BI {
  font-family: MJXZERO, MJXTEX-BI;
}

.TEX-S1 {
  font-family: MJXZERO, MJXTEX-S1;
}

.TEX-S2 {
  font-family: MJXZERO, MJXTEX-S2;
}

.TEX-S3 {
  font-family: MJXZERO, MJXTEX-S3;
}

.TEX-S4 {
  font-family: MJXZERO, MJXTEX-S4;
}

.TEX-A {
  font-family: MJXZERO, MJXTEX-A;
}

.TEX-C {
  font-family: MJXZERO, MJXTEX-C;
}

.TEX-CB {
  font-family: MJXZERO, MJXTEX-CB;
}

.TEX-FR {
  font-family: MJXZERO, MJXTEX-FR;
}

.TEX-FRB {
  font-family: MJXZERO, MJXTEX-FRB;
}

.TEX-SS {
  font-family: MJXZERO, MJXTEX-SS;
}

.TEX-SSB {
  font-family: MJXZERO, MJXTEX-SSB;
}

.TEX-SSI {
  font-family: MJXZERO, MJXTEX-SSI;
}

.TEX-SC {
  font-family: MJXZERO, MJXTEX-SC;
}

.TEX-T {
  font-family: MJXZERO, MJXTEX-T;
}

.TEX-V {
  font-family: MJXZERO, MJXTEX-V;
}

.TEX-VB {
  font-family: MJXZERO, MJXTEX-VB;
}

mjx-stretchy-v mjx-c, mjx-stretchy-h mjx-c {
  font-family: MJXZERO, MJXTEX-S1, MJXTEX-S4, MJXTEX, MJXTEX-A ! important;
}

@font-face /* 0 */ {
  font-family: MJXZERO;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Zero.woff") format("woff");
}

@font-face /* 1 */ {
  font-family: MJXTEX;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff") format("woff");
}

@font-face /* 2 */ {
  font-family: MJXTEX-B;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff") format("woff");
}

@font-face /* 3 */ {
  font-family: MJXTEX-I;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff") format("woff");
}

@font-face /* 4 */ {
  font-family: MJXTEX-MI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff") format("woff");
}

@font-face /* 5 */ {
  font-family: MJXTEX-BI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff") format("woff");
}

@font-face /* 6 */ {
  font-family: MJXTEX-S1;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff") format("woff");
}

@font-face /* 7 */ {
  font-family: MJXTEX-S2;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff") format("woff");
}

@font-face /* 8 */ {
  font-family: MJXTEX-S3;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff") format("woff");
}

@font-face /* 9 */ {
  font-family: MJXTEX-S4;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff") format("woff");
}

@font-face /* 10 */ {
  font-family: MJXTEX-A;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff") format("woff");
}

@font-face /* 11 */ {
  font-family: MJXTEX-C;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff") format("woff");
}

@font-face /* 12 */ {
  font-family: MJXTEX-CB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff") format("woff");
}

@font-face /* 13 */ {
  font-family: MJXTEX-FR;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff") format("woff");
}

@font-face /* 14 */ {
  font-family: MJXTEX-FRB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff") format("woff");
}

@font-face /* 15 */ {
  font-family: MJXTEX-SS;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff") format("woff");
}

@font-face /* 16 */ {
  font-family: MJXTEX-SSB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff") format("woff");
}

@font-face /* 17 */ {
  font-family: MJXTEX-SSI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff") format("woff");
}

@font-face /* 18 */ {
  font-family: MJXTEX-SC;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff") format("woff");
}

@font-face /* 19 */ {
  font-family: MJXTEX-T;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff") format("woff");
}

@font-face /* 20 */ {
  font-family: MJXTEX-V;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff") format("woff");
}

@font-face /* 21 */ {
  font-family: MJXTEX-VB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff") format("woff");
}
</style><link crossorigin="anonymous" href="https://distill.pub/third-party/katex/katex.min.css" rel="stylesheet"/><script async="" src="https://distill.pub/third-party/katex/katex.min.js"></script></head>
<body> <d-front-matter> <script async="" type="text/json">
      {
            "title": "åœ¨ JAX ä¸­ä¸º TPU ç¼–ç¨‹",
            "description": "å¦‚ä½•ä½¿ç”¨ JAX é«˜æ•ˆåœ°ä¸º TPU ç¼–ç¨‹ï¼æœ¬èŠ‚å¤§éƒ¨åˆ†å†…å®¹æ‘˜è‡ª<a href='https://jax.readthedocs.io/en/latest/jep/14273-shard-map.html'>æ­¤å¤„</a>ã€‚æ‚¨å¯ä»¥åœ¨ <a href='https://colab.sandbox.google.com/'>Google Colab</a> ä¸Šä½¿ç”¨å…è´¹çš„ TPU è¿è¡Œæœ¬èŠ‚ä¸­çš„ä»£ç ç¤ºä¾‹ã€‚",
            "published": "February 04, 2025",
            "authors": [

              {
                "author": "Jacob Austin",
                "authorURL": "https://www.jacobaustin.org/",
                "affiliations": [
                  {
                    "name": "Google DeepMind",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Sholto Douglas",
                "authorURL": "https://x.com/_sholtodouglas",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Roy Frostig",
                "authorURL": "https://cs.stanford.edu/~rfrostig/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Anselm Levskaya",
                "authorURL": "https://anselmlevskaya.com/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Charlie Chen",
                "authorURL": "https://x.com/charliexychen",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Sharad Vikram",
                "authorURL": "https://sharadvikram.com/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Federico Lebron",
                "authorURL": "https://fedelebron.com/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Peter Choy",
                "authorURL": "https://x.com/pchoy95",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Vinay Ramasesh",
                "authorURL": "https://x.com/vinayramasesh",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Albert Webson",
                "authorURL": "https://representation.ai/",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Yash Katariya",
                "authorURL": "https://x.com/yashk2810",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              },

              {
                "author": "Reiner Pope<sup>*</sup>",
                "authorURL": "https://x.com/reinerpope",
                "affiliations": [
                  {
                    "name": "",
                    "url": ""
                  }
                ]
              }

            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <script>
    function goToTop() {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    }

    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function() {scrollFunction()};

    function scrollFunction() {
      // Get the button:
      let mybutton = document.getElementById("top-button");

      if (document.body.scrollTop > 40 || document.documentElement.scrollTop > 40) {
        mybutton.style.display = "block";
      } else {
        mybutton.style.display = "none";
      }
  }
  </script> <nav class="navbar navbar-light navbar-expand-sm fixed-top" id="navbar" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="scaling-book.html"> å¦‚ä½•æ‰©å±•ä½ çš„æ¨¡å‹ </a> <button aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler collapsed ml-auto" data-target="#navbarNav" data-toggle="collapse" type="button"> <span class="sr-only">åˆ‡æ¢å¯¼èˆª</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="left-button section-button"><a href="profiling.html"><svg viewbox="-78.5 0 512 512"><path d="M257 64L291 98 128 262 291 426 257 460 61 262 257 64Z"></path></svg></a></div> <div class="right-button section-button"><a href="conclusion.html"><svg viewbox="-78.5 0 512 512"><path d="M98 460L64 426 227 262 64 98 98 64 294 262 98 460Z"></path></svg></a></div> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item"> <a class="nav-link" href="scaling-book.html"> </a> </li> <li class="nav-item nav-hidden"><a class="nav-link" id="top-button" onclick="goToTop()" style="display: none;">è¿”å›é¡¶éƒ¨</a></li> <li class="nav-item nav-hidden"><p class="nav-link"></p></li> <li class="nav-item nav-hidden"><a class="nav-link" href="profiling.html">ä¸Šä¸€éƒ¨åˆ†</a></li> <li class="nav-item nav-hidden"><a class="nav-link" href="conclusion.html">ä¸‹ä¸€éƒ¨åˆ†</a></li> <li class="nav-item nav-hidden"><p class="nav-link"></p></li> <li class="nav-item dropdown"> <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="navbarDropdown" role="button">ç« èŠ‚ </a> <div aria-labelledby="navbarDropdown" class="dropdown-menu dropdown-menu-right"> <a class="dropdown-item" href="https://jax-ml.github.io/scaling-book/index">ç¬¬0éƒ¨åˆ†. å¼•è¨€</a> <a class="dropdown-item" href="roofline.html">ç¬¬1éƒ¨åˆ†. å±‹é¡¶çº¿æ¨¡å‹ç®€ä»‹</a> <a class="dropdown-item" href="tpus.html">ç¬¬2éƒ¨åˆ†. TPU å…¨æ–¹ä½è§£æ</a> <a class="dropdown-item" href="sharding.html">ç¬¬3éƒ¨åˆ†. åˆ†ç‰‡çŸ©é˜µä¹˜æ³•</a> <a class="dropdown-item" href="transformers.html">ç¬¬4éƒ¨åˆ†. Transformer</a> <a class="dropdown-item" href="training.html">ç¬¬5éƒ¨åˆ†. è®­ç»ƒ</a> <a class="dropdown-item" href="applied-training.html">ç¬¬6éƒ¨åˆ†. è®­ç»ƒ LLaMA</a> <a class="dropdown-item" href="inference.html">ç¬¬7éƒ¨åˆ†. æ¨ç†</a> <a class="dropdown-item" href="applied-inference.html">ç¬¬8éƒ¨åˆ†. éƒ¨ç½² LLaMA</a> <a class="dropdown-item" href="profiling.html">ç¬¬9éƒ¨åˆ†. æ€§èƒ½åˆ†æ</a> <a class="dropdown-item" href="jax-stuff.html">ç¬¬10éƒ¨åˆ†. JAX å…¨æ–¹ä½è§£æ</a> <a class="dropdown-item" href="conclusion.html">ç¬¬11éƒ¨åˆ†. ç»“è®º</a> <a class="dropdown-item" href="gpus.html">ç¬¬12éƒ¨åˆ†. GPU</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"><div class="translation-info base-grid" style="margin-bottom: 20px;">
<div style="grid-column: text;
                       display: flex;
                       align-items: center;
                       justify-content: space-between;
                       padding: 16px 0;
                       border-bottom: 1px solid var(--global-text-color-light, rgba(0,0,0,0.15));
                       font-size: 16px;
                       line-height: 1.5;
                       color: var(--global-text-color, currentColor);">
<div style="display: flex;
                           flex-direction: column;
                           gap: 8px;">
<div>
<span style="font-weight: 600; color: var(--global-text-color, currentColor);">ğŸ”— è‹±æ–‡åŸæ–‡ï¼š</span>
<a href="https://jax-ml.github.io/scaling-book/jax-stuff/" onmouseout="this.style.textDecoration='none'" onmouseover="this.style.textDecoration='underline'" rel="noopener noreferrer" style="color: var(--global-theme-color, #004276);
                                  text-decoration: none;
                                  margin-left: 4px;" target="_blank">
                           https://jax-ml.github.io/scaling-book/jax-stuff/
                        </a>
</div>
<div>
<span style="font-weight: 600; color: var(--global-text-color, currentColor);">âœï¸ ç¿»è¯‘ï¼š</span>
<a href="https://github.com/skindhu/Build-A-Large-Language-Model-CN" target="_blank" style="margin-left: 4px; color: var(--global-theme-color, #004276); text-decoration: none;">åŒ—æçš„æ ‘</a>
</div>
</div>
<div style="flex-shrink: 0;
                           display: flex;
                           flex-direction: column;
                           align-items: center;
                           gap: 6px;
                           margin-left: 20px;">
<img alt="å¾®ä¿¡äºŒç»´ç " loading="lazy" src="https://wechat-account-1251781786.cos.ap-guangzhou.myqcloud.com/wechat_account.jpeg" style="width: 80px;
                                height: 80px;
                                border-radius: 6px;
                                opacity: 0.9;"/>
<span style="font-size: 12px;
                                 color: var(--global-text-color-light, currentColor);
                                 opacity: 0.8;
                                 text-align: center;">
                        å¾®ä¿¡å…¬ä¼—å·
                    </span>
</div>
</div>
</div> <d-title> <h1>åœ¨ JAX ä¸­ä¸º TPU ç¼–ç¨‹</h1> <p>ã€Š<a href="scaling-book.html">å¦‚ä½•æ‰©å±•ä½ çš„æ¨¡å‹</a>ã€‹ç¬¬10éƒ¨åˆ† (<a href="profiling.html">ç¬¬9éƒ¨åˆ†ï¼šæ€§èƒ½åˆ†æ</a> | <a href="conclusion.html">ç¬¬11éƒ¨åˆ†ï¼šç»“è®º</a>)</p> <p>å¦‚ä½•ä½¿ç”¨ JAX é«˜æ•ˆåœ°ä¸º TPU ç¼–ç¨‹ï¼æœ¬èŠ‚å¤§éƒ¨åˆ†å†…å®¹æ‘˜è‡ª<a href="https://jax.readthedocs.io/en/latest/jep/14273-shard-map.html" rel="external nofollow noopener" target="_blank">æ­¤å¤„</a>ã€‚æ‚¨å¯ä»¥åœ¨ <a href="https://colab.sandbox.google.com/" rel="external nofollow noopener" target="_blank">Google Colab</a> ä¸Šä½¿ç”¨å…è´¹çš„ TPU è¿è¡Œæœ¬èŠ‚ä¸­çš„ä»£ç ç¤ºä¾‹ã€‚</p> </d-title> <d-byline>
<div class="byline grid">
<div class="authors-affiliations grid">
<h3 style="grid-column: 1; grid-row: 1;">ä½œè€…</h3>
<h3></h3>
<h3>å•ä½</h3>
<p class="author" style="grid-column: 1; grid-row: 2;">
<a class="name" href="https://www.jacobaustin.org/">Jacob Austin</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 2;">
<span class="affiliation">Google DeepMind</span>
</p>
<p class="author" style="grid-column: 1; grid-row: 3;">
<a class="name" href="https://x.com/_sholtodouglas">Sholto Douglas</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 3;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 4;">
<a class="name" href="https://cs.stanford.edu/~rfrostig/">Roy Frostig</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 4;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 5;">
<a class="name" href="https://anselmlevskaya.com/">Anselm Levskaya</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 5;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 6;">
<a class="name" href="https://x.com/charliexychen">Charlie Chen</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 6;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 1; grid-row: 7;">
<a class="name" href="https://sharadvikram.com/">Sharad Vikram</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 7;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 2;">
<a class="name" href="https://fedelebron.com/">Federico Lebron</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 2;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 3;">
<a class="name" href="https://x.com/pchoy95">Peter Choy</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 3;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 4;">
<a class="name" href="https://x.com/vinayramasesh">Vinay Ramasesh</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 4;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 5;">
<a class="name" href="https://representation.ai/">Albert Webson</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 5;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 6;">
<a class="name" href="https://x.com/yashk2810">Yash Katariya</a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 6;">
<span class="affiliation"></span>
</p>
<p class="author" style="grid-column: 2; grid-row: 7;">
<a class="name" href="https://x.com/reinerpope">Reiner Pope<sup>*</sup></a>
</p>
<p class="affiliation" style="grid-column: 3; grid-row: 7;">
<span class="affiliation"></span>
</p>
</div>
<div>
<h3>å‘å¸ƒæ—¥æœŸ</h3>
<p>2025å¹´2æœˆ4æ—¥</p>
</div>
</div>
</d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>ç›®å½•</h3> <div> <a href="#how-does-parallelism-work-in-jax">JAX ä¸­çš„å¹¶è¡Œæ€§æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</a> </div> <div> <a href="#"></a> </div> <ul> <li> <a href="#auto-sharding-mode">è‡ªåŠ¨åˆ†ç‰‡æ¨¡å¼</a> </li> <li> <a href="#explicit-sharding-mode">â€œæ˜¾å¼åˆ†ç‰‡æ¨¡å¼â€</a> </li> <li> <a href="#manual-sharding-mode-via-shard-map">é€šè¿‡ shard_map å®ç°çš„æ‰‹åŠ¨åˆ†ç‰‡æ¨¡å¼</a> </li> </ul> <div> <a href="#worked-problems">å®è·µé—®é¢˜</a> </div> </nav> </d-contents> <h2 id="how-does-parallelism-work-in-jax">JAX ä¸­çš„å¹¶è¡Œæ€§æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h2> <p>JAX æ”¯æŒä¸‰ç§å¤šè®¾å¤‡ç¼–ç¨‹çš„æ€æƒ³æµæ´¾ï¼š</p> <ol> <li> <strong>ç¼–è¯‘å™¨ï¼Œä½ æ¥æŒèˆµï¼</strong> è®© XLA ç¼–è¯‘å™¨è‡ªåŠ¨å¯¹æ•°ç»„è¿›è¡Œåˆ†åŒºï¼Œå¹¶å†³å®šæ·»åŠ ä½•ç§é€šä¿¡æ¥æ”¯æŒç»™å®šçš„ç¨‹åºã€‚è¿™ä½¿ä½ èƒ½å¤Ÿå°†ä¸€ä¸ªåœ¨å•è®¾å¤‡ä¸Šè¿è¡Œçš„ç¨‹åºï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œå°±èƒ½è‡ªåŠ¨åœ°åœ¨æ•°åƒä¸ªè®¾å¤‡ä¸Šè¿è¡Œã€‚</li> <li> <strong>JAXï¼Œä½ æ¥æŒèˆµï¼</strong> è‡ªåŠ¨å¹¶è¡Œæ€§å¾ˆæ£’ï¼Œä½†æœ‰æ—¶ç¼–è¯‘å™¨ä¼šåšå‡ºä¸€äº›ç–¯ç‹‚çš„ä¸¾åŠ¨ã€‚æ˜¾å¼åˆ†ç‰‡å…è®¸ä½ åƒå¾€å¸¸ä¸€æ ·ç¼–å†™å•è®¾å¤‡ä»£ç ï¼Œä½†ç”± JAX æ¥å¤„ç†åˆ†ç‰‡ä¼ æ’­ï¼ˆè€Œä¸æ˜¯ç¼–è¯‘å™¨ï¼‰ã€‚è¿™æ„å‘³ç€å½“ JAX ä¸æ¸…æ¥šä½ çš„æ„å›¾æ—¶ï¼Œå®ƒå¯ä»¥è¯·æ±‚ä½ è¿›è¡Œæ¾„æ¸…ã€‚</li> <li> <strong>è¯¥æ­»ï¼Œå°±è®©æˆ‘å†™æˆ‘æƒ³å†™çš„ï¼</strong> è™½ç„¶ç¼–è¯‘å™¨å¾ˆå¥½ç”¨ï¼Œä½†å®ƒä»¬æœ‰æ—¶ä¼šåšé”™äº‹ï¼Œæ·»åŠ ä¸€äº›ä½ å¹¶ä¸æ‰“ç®—ä½¿ç”¨çš„é€šä¿¡ã€‚æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›æ˜ç¡®æŒ‡å®šè¦è¿è¡Œçš„ç¡®åˆ‡é€šä¿¡ã€‚</li> </ol> <table class="table-hover" data-toggle="table"> <thead> <tr> <th style="text-align: center">æ¨¡å¼</th> <th style="text-align: center">è§†å›¾ï¼Ÿ</th> <th style="text-align: center">æ˜¾å¼åˆ†ç‰‡ï¼Ÿ</th> <th style="text-align: center">æ˜¾å¼é›†åˆæ“ä½œï¼Ÿ</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">è‡ªåŠ¨</td> <td style="text-align: center">å…¨å±€</td> <td style="text-align: center">âŒ</td> <td style="text-align: center">âŒ</td> </tr> <tr> <td style="text-align: center">æ˜¾å¼</td> <td style="text-align: center">å…¨å±€</td> <td style="text-align: center">âœ…</td> <td style="text-align: center">âŒ</td> </tr> <tr> <td style="text-align: center">æ‰‹åŠ¨</td> <td style="text-align: center">æ¯è®¾å¤‡</td> <td style="text-align: center">âœ…</td> <td style="text-align: center">âœ…</td> </tr> </tbody> </table> <p>ç›¸åº”åœ°ï¼ŒJAX ä¸ºæ¯ç§æ¨¡å¼éƒ½æä¾›äº† APIï¼š</p> <ol> <li> <code class="language-plaintext highlighter-rouge">jax.jit</code> (ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Auto</code> ç½‘æ ¼è½´) å…è®¸ä½ ä½¿ç”¨ä»»ä½•ç°æœ‰çš„ JAX å‡½æ•°ï¼Œå¹¶ç”¨åˆ†ç‰‡çš„è¾“å…¥æ¥è°ƒç”¨å®ƒã€‚ç„¶åï¼ŒJAX ä¼šä½¿ç”¨ XLA çš„ <a href="https://openxla.org/shardy" rel="external nofollow noopener" target="_blank">Shardy</a> ç¼–è¯‘å™¨æ¥è‡ªåŠ¨å¹¶è¡ŒåŒ–ç¨‹åºã€‚å½“éœ€è¦æ”¯æŒç°æœ‰æ“ä½œæ—¶ï¼ŒXLA ä¼šä¸ºä½ æ·»åŠ é€šä¿¡æ“ä½œï¼ˆAllGathersã€ReduceScattersã€AllReduces ç­‰ï¼‰ã€‚è™½ç„¶å®ƒå¹¶ä¸å®Œç¾ï¼Œä½†é€šå¸¸èƒ½åœ¨æ— éœ€ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¾ˆå¥½åœ°å°†ä½ çš„ç¨‹åºè‡ªåŠ¨æ‰©å±•åˆ°ä»»æ„æ•°é‡çš„èŠ¯ç‰‡ä¸Šã€‚</li> <li> <code class="language-plaintext highlighter-rouge">jax.jit</code> ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Explicit</code> ç½‘æ ¼è½´çœ‹èµ·æ¥ä¸ï¼ˆ1ï¼‰ç±»ä¼¼ï¼Œä½†å®ƒè®© JAX è€Œä¸æ˜¯ XLA æ¥å¤„ç†åˆ†ç‰‡ä¼ æ’­ã€‚è¿™æ„å‘³ç€æ•°ç»„çš„åˆ†ç‰‡å®é™…ä¸Šæ˜¯ JAX ç±»å‹ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå½“ JAX æ£€æµ‹åˆ°æ¨¡ç³Šçš„é€šä¿¡æ—¶ä¼šæŠ¥é”™ï¼Œå¹¶è®©ç”¨æˆ·æ¥è§£å†³ã€‚</li> <li> <code class="language-plaintext highlighter-rouge">jax.shard_map</code> æ˜¯æ›´æ‰‹åŠ¨çš„å¯¹åº”æ–¹æ¡ˆã€‚ä½ è·å¾—çš„æ˜¯ç¨‹åºçš„è®¾å¤‡æœ¬åœ°è§†å›¾ï¼Œå¹¶ä¸”å¿…é¡»æ˜¾å¼åœ°ç¼–å†™ä»»ä½•ä½ æƒ³è¦çš„é€šä¿¡ã€‚æœ‰ä¸€ä¸ªåˆ†ç‰‡æ•°ç»„ï¼Œå¹¶å¸Œæœ›æ¯ä¸ªè®¾å¤‡ä¸Šéƒ½æœ‰å®Œæ•´çš„æ•°æ®ï¼Ÿæ·»åŠ ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">jax.lax.all_gather</code>ã€‚æƒ³åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šå¯¹ä¸€ä¸ªæ•°ç»„æ±‚å’Œï¼Ÿæ·»åŠ ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">jax.lax.psum</code> (ä¸€ä¸ª AllReduce)ã€‚ç¼–ç¨‹æ›´éš¾ï¼Œä½†åšé”™äº‹çš„å¯èƒ½æ€§è¦å°å¾—å¤šã€‚</li> </ol> <h3 id="auto-sharding-mode">è‡ªåŠ¨åˆ†ç‰‡æ¨¡å¼</h3> <p>jax.jit åœ¨ JAX å†…éƒ¨æ‰®æ¼”ä¸¤ä¸ªè§’è‰²ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒä¼šâ€œå³æ—¶â€å°†ä¸€ä¸ªå‡½æ•°ä» Python ç¼–è¯‘æˆå­—èŠ‚ç ï¼ˆé€šè¿‡ XLA/HLO/LLOï¼‰ï¼Œä½¿å…¶è¿è¡Œå¾—æ›´å¿«ã€‚ä½†å¦‚æœè¾“å…¥æ˜¯åˆ†ç‰‡çš„ï¼Œæˆ–è€…ç”¨æˆ·æŒ‡å®šäº† <code class="language-plaintext highlighter-rouge">in_sharding</code> æˆ– <code class="language-plaintext highlighter-rouge">out_sharding</code>ï¼Œå®ƒè¿˜ä¼šè®© XLA å°†è®¡ç®—åˆ†å¸ƒåˆ°å¤šä¸ªè®¾å¤‡ä¸Šï¼Œå¹¶æ ¹æ®éœ€è¦æ·»åŠ é€šä¿¡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ jax.jit ç¼–å†™ä¸€ä¸ªåˆ†ç‰‡çŸ©é˜µä¹˜æ³•ï¼š</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="kn">import</span> <span class="n">jax</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>

<span class="c1"># åœ¨ä¸€ä¸ª TPU v5e 4x2 ä¸Šè¿è¡Œã€‚è¿™ä¸ºç¡¬ä»¶çš„ä¸¤ä¸ªç‰©ç†è½´åˆ†é…äº†åç§°ã€‚
</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">make_mesh</span><span class="p">(</span><span class="n">axis_shapes</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis_names</span><span class="o">=</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>

<span class="c1"># è¿™å‘Šè¯‰ JAX å¯¹æ‰€æœ‰æ“ä½œéƒ½ä½¿ç”¨è¿™ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥ä½ åªéœ€æŒ‡å®š PartitionSpec P å³å¯ã€‚
</span><span class="n">jax</span><span class="p">.</span><span class="nf">set_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

<span class="c1"># æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçŸ©é˜µ W å’Œè¾“å…¥æ¿€æ´» Inï¼Œå®ƒä»¬è¢«åˆ†ç‰‡åˆ°æˆ‘ä»¬çš„è®¾å¤‡ä¸Šã€‚
</span><span class="n">In</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2048</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">NamedSharding</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)))</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">8192</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">NamedSharding</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">matmul_square</span><span class="p">(</span><span class="n">In</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">einsum</span><span class="p">(</span><span class="sh">'</span><span class="s">bd,df-&gt;bf</span><span class="sh">'</span><span class="p">,</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">square</span><span class="p">(</span><span class="n">In</span><span class="p">),</span> <span class="n">W</span><span class="p">)</span>

<span class="c1"># æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ˜¾å¼ç¼–è¯‘åˆ†ç‰‡çš„çŸ©é˜µä¹˜æ³•å‡½æ•°ã€‚è¿™ä¼šæ·»åŠ æ‰€æœ‰
# å¿…è¦çš„é€šä¿¡ï¼ˆä¾‹å¦‚ï¼Œåœ¨çŸ©é˜µä¹˜æ³•ä¹‹åè¿›è¡Œ AllReduceï¼‰ã€‚
</span><span class="n">jit_matmul</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">jit</span><span class="p">(</span><span class="n">matmul_square</span><span class="p">,</span> <span class="n">out_shardings</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)).</span><span class="nf">lower</span><span class="p">(</span><span class="n">In</span><span class="p">,</span> <span class="n">W</span><span class="p">).</span><span class="nf">compile</span><span class="p">()</span>

<span class="n">out</span> <span class="o">=</span> <span class="nf">jit_matmul</span><span class="p">(</span><span class="n">In</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>è¿™å°†åœ¨ä»»ä½•åˆ†ç‰‡ç­–ç•¥ä¸‹è‡ªåŠ¨è¿è¡Œï¼Œå¹¶å°†è®¡ç®—åˆ†åŒºåˆ°æˆ‘ä»¬çš„è®¾å¤‡ä¸Šã€‚<strong>ä½†æ˜¯åœ¨ç¡¬ä»¶å±‚é¢åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p> <ol> <li>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨è®¾å¤‡ä¸Šåˆ›å»ºåˆ†ç‰‡çš„ In å’Œ W<d-footnote id="d-footnote-1">æ³¨æ„æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ã€‚è¿™æ˜¯ä¸€ç§åˆ›å»ºå…·æœ‰ç‰¹å®šåˆ†ç‰‡æ•°ç»„çš„æ–¹æ³•ï¼ˆå³é€šè¿‡å‘åˆ›å»ºå‡½æ•°æ·»åŠ  device å‚æ•°ï¼‰ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ `jnp.array(....)` æ­£å¸¸åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œç„¶åæ‰§è¡Œä¾‹å¦‚ `jax.device_put(..., P('x', 'y'))`ã€‚è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºä½ æƒ³è¦çš„æ•°ç»„ï¼Œç„¶åä½¿ç”¨ä½ æƒ³è¦çš„ `out_shardings` å¯¹å…¶è¿›è¡Œ jit ç¼–è¯‘ã€‚</d-footnote>ã€‚W æ²¿ç€æ”¶ç¼©ç»´åº¦è¿›è¡Œ 2 è·¯åˆ†ç‰‡ï¼Œè€Œ In åˆ™è¿›è¡Œ 4 è·¯åˆ†ç‰‡ï¼ˆåŒæ—¶æ²¿ç€æ”¶ç¼©ç»´åº¦å’Œè¾“å‡ºç»´åº¦ï¼‰ã€‚è¿™å¯¹åº”äº W[D<sub>X</sub>, F] å’Œ In[B<sub>X</sub>, D<sub>Y</sub>] çš„åˆ†ç‰‡ï¼Œä¹Ÿå°±æ˜¯ä¸€ç§æ¨¡å‹å’Œæ•°æ®å¹¶è¡Œæ€§ã€‚</li> <li>å¦‚æœæˆ‘ä»¬åœ¨æœ¬åœ°ï¼ˆå³å•ä¸ªè®¾å¤‡ä¸Šï¼‰è¿è¡Œï¼Œ<code class="language-plaintext highlighter-rouge">matmul_square</code> ä¼šç®€å•åœ°å¯¹è¾“å…¥è¿›è¡Œå¹³æ–¹è¿ç®—å¹¶æ‰§è¡Œä¸€ä¸ªç®€å•çš„çŸ©é˜µä¹˜æ³•ã€‚ä½†å› ä¸ºæˆ‘ä»¬å°† <code class="language-plaintext highlighter-rouge">out_shardings</code> æŒ‡å®šä¸º <code class="language-plaintext highlighter-rouge">P('X', None)</code>ï¼Œè¾“å‡ºå°†æ²¿ç€æ‰¹æ¬¡ç»´åº¦åˆ†ç‰‡ï¼Œä½†åœ¨æ¨¡å‹ç»´åº¦ä¸Šæ˜¯å¤åˆ¶çš„ï¼Œå¹¶ä¸”éœ€è¦ä¸€ä¸ª AllReduce æ¥è®¡ç®—ã€‚</li> </ol> <p>ä½¿ç”¨æˆ‘ä»¬å‰é¢ç« èŠ‚çš„è¡¨ç¤ºæ³•ï¼Œè¿™å¯èƒ½ä¼šæ‰§è¡Œç±»ä¼¼ä»¥ä¸‹çš„æ“ä½œ</p> <ol> <li>Out[B<sub>X</sub>, F] { U<sub>Y</sub> } = In[B<sub>X</sub>, D<sub>Y</sub>] *<sub>D</sub> W[D<sub>Y</sub>, F]</li> <li>Out[B<sub>X</sub>, F] = <strong>AllReduce</strong>(Out[B<sub>X</sub>, F] { U<sub>Y</sub> })</li> </ol> <p><code class="language-plaintext highlighter-rouge">jax.jit</code> ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬æ·»åŠ è¿™ä¸ªï¼æˆ‘ä»¬å®é™…ä¸Šå¯ä»¥ç”¨ <code class="language-plaintext highlighter-rouge">jit_matmul.as_text()</code> æ‰“å°å‡º HLOï¼Œå¹¶çœ‹åˆ°ä»¥ä¸‹ HLOï¼ˆç»è¿‡å¤§å¹…ç¼©å†™ï¼‰ï¼š</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="c1"># è¿™ä¸ªèåˆæ“ä½œæ˜¯åˆ†ç‰‡è¾“å…¥å’ŒçŸ©é˜µçš„å®é™…çŸ©é˜µä¹˜æ³•
</span><span class="o">%</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">bf16</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">8192</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nc">T</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">128</span><span class="p">)(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="nc">S</span><span class="p">(</span><span class="mi">1</span><span class="p">)}</span> <span class="nf">fusion</span><span class="p">(</span><span class="n">bf16</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1024</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nc">T</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">128</span><span class="p">)(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span> <span class="o">%</span><span class="n">param</span><span class="p">,</span> <span class="n">bf16</span><span class="p">[</span><span class="mi">8192</span><span class="p">,</span><span class="mi">1024</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nc">T</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">128</span><span class="p">)(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="nc">S</span><span class="p">(</span><span class="mi">1</span><span class="p">)}</span> <span class="o">%</span><span class="n">copy</span><span class="o">-</span><span class="n">done</span><span class="p">)</span>

<span class="c1"># æˆ‘ä»¬åœ¨è®¾å¤‡é—´å¯¹éƒ¨åˆ†æ±‚å’Œçš„ç»“æœè¿›è¡Œå½’çº¦
</span><span class="n">ROOT</span> <span class="o">%</span><span class="n">AllReduce</span> <span class="o">=</span> <span class="n">bf16</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">8192</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nc">T</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">128</span><span class="p">)(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span> <span class="nc">AllReduce</span><span class="p">(</span><span class="n">bf16</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">8192</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nc">T</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">128</span><span class="p">)(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="nc">S</span><span class="p">(</span><span class="mi">1</span><span class="p">)}</span> <span class="o">%</span><span class="n">fusion</span><span class="p">)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„çŸ©é˜µä¹˜æ³•ï¼ˆèåˆæ“ä½œï¼‰å’Œ AllReduceã€‚è¯·ç‰¹åˆ«æ³¨æ„å½¢çŠ¶ã€‚<code class="language-plaintext highlighter-rouge">bf16[2, 1024]</code> æ˜¯æ¿€æ´»çš„æœ¬åœ°è§†å›¾ï¼Œå› ä¸ºæˆ‘ä»¬çš„ <code class="language-plaintext highlighter-rouge">batch_size=8</code> è¢«åˆ†å‰²åˆ° 4 ä¸ªè®¾å¤‡ä¸Šï¼Œè€Œæˆ‘ä»¬çš„ <code class="language-plaintext highlighter-rouge">d_model=2048</code> åŒæ ·è¢«åˆ†å‰²æˆ 2 è·¯ã€‚</p> <p><strong>è¿™ç®€ç›´å¤ªç¥å¥‡äº†ï¼</strong> æ— è®ºæˆ‘ä»¬çš„ç¨‹åºå¤šä¹ˆå¤æ‚ï¼Œ<a href="https://jax-ml.github.io/scaling-book/jax-stuff/(https:/openxla.org/shardy)">Shardy</a> å’Œ jit éƒ½ä¼šå°è¯•ä¸ºæ‰€æœ‰ä¸­é—´æ¿€æ´»æ‰¾åˆ°åˆ†ç‰‡æ–¹å¼ï¼Œå¹¶æ ¹æ®éœ€è¦æ·»åŠ é€šä¿¡ã€‚è¯è™½å¦‚æ­¤ï¼ŒShardy ä¹Ÿæœ‰å…¶ç¼ºé™·ã€‚å®ƒå¯èƒ½ä¼šçŠ¯é”™ã€‚æœ‰æ—¶ä½ ä¼šæŸ¥çœ‹æ€§èƒ½å‰–æï¼Œå‘ç°å‡ºäº†é—®é¢˜ã€‚ä¸€ä¸ªå·¨å¤§çš„ AllGather å ç”¨äº† 80% çš„æ—¶é—´ï¼Œè€Œè¿™æœ¬æ˜¯ä¸å¿…è¦çš„ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é€šè¿‡ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">jax.lax.with_sharding_constraint</code> æ˜¾å¼åœ°æ³¨é‡Šä¸­é—´å¼ é‡æ¥çº æ­£ç¼–è¯‘å™¨ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸¤ä¸ªçŸ©é˜µä¹˜æ³•ï¼Œæˆ‘å¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼å¼ºåˆ¶ä¸­é—´æ¿€æ´»æ²¿ç€ <code class="language-plaintext highlighter-rouge">y</code> ç»´åº¦è¿›è¡Œåˆ†ç‰‡ï¼ˆä½†è¿™ä¸ä¸€å®šæ˜¯ä¸ªå¥½ä¸»æ„ï¼‰ï¼š</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="kn">import</span> <span class="n">jax</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">make_mesh</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Win</span><span class="p">,</span> <span class="n">Wout</span><span class="p">):</span>
  <span class="n">hidden</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">einsum</span><span class="p">(</span><span class="sh">'</span><span class="s">bd,df-&gt;bf</span><span class="sh">'</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Win</span><span class="p">)</span>
  <span class="n">hidden</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">with_sharding_constraint</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">einsum</span><span class="p">(</span><span class="sh">'</span><span class="s">bf,df-&gt;bd</span><span class="sh">'</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">Wout</span><span class="p">)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>åœ¨è‡ªåŠ¨åˆ†åŒºä¸–ç•Œé‡Œï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">jax.lax.with_sharding_constraint</code> æ§åˆ¶ä¸­é—´åˆ†ç‰‡æ„æˆäº†å¤§çº¦ 60% çš„ JAX å¹¶è¡Œç¼–ç¨‹ã€‚ä½†â€œæŒ‘é€—ç¼–è¯‘å™¨â€æ˜¯å‡ºäº†åçš„ä¸å¥½ç©çš„ç¼–ç¨‹æ¨¡å‹ã€‚ä½ å¯èƒ½æ³¨é‡Šäº†æ¯ä¸ªä¸­é—´å˜é‡ï¼Œä½†ä»ç„¶ä¸çŸ¥é“æ˜¯å¦ä¼šå¾—åˆ°æ­£ç¡®çš„ç»“æœã€‚é‚£ä¹ˆï¼Œå¦‚æœ JAX æœ¬èº«èƒ½å¤Ÿå¤„ç†å’Œæ§åˆ¶åˆ†ç‰‡ä¼ æ’­å‘¢ï¼Ÿ</p> <h3 id="explicit-sharding-mode">æ˜¾å¼åˆ†ç‰‡æ¨¡å¼</h3> <p>æ˜¾å¼åˆ†ç‰‡ï¼ˆæˆ–â€œç±»å‹ä¸­çš„åˆ†ç‰‡â€ï¼‰çœ‹èµ·æ¥å¾ˆåƒè‡ªåŠ¨åˆ†ç‰‡ï¼Œä½†åˆ†ç‰‡ä¼ æ’­å‘ç”Ÿåœ¨ JAX å±‚é¢ï¼æ¯ä¸ª JAX æ“ä½œéƒ½æœ‰ä¸€ä¸ªåˆ†ç‰‡è§„åˆ™ï¼Œå®ƒæ¥æ”¶æ“ä½œå‚æ•°çš„åˆ†ç‰‡æ–¹å¼ï¼Œå¹¶ä¸ºæ“ä½œç»“æœç”Ÿæˆä¸€ä¸ªåˆ†ç‰‡æ–¹å¼ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">jax.typeof</code> æŸ¥çœ‹ç»“æœçš„åˆ†ç‰‡ï¼š</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="kn">import</span> <span class="n">jax</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>
<span class="kn">import</span> <span class="n">jax.sharding</span> <span class="k">as</span> <span class="n">shd</span>

<span class="c1"># åœ¨ä¸€ä¸ª TPU v5e 2x2 ä¸Šè¿è¡Œã€‚è¿™ä¸ºç¡¬ä»¶çš„ä¸¤ä¸ªç‰©ç†è½´åˆ†é…äº†åç§°ã€‚
</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">make_mesh</span><span class="p">(</span><span class="n">axis_shapes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis_names</span><span class="o">=</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">),</span>
                                       <span class="n">axis_types</span><span class="o">=</span><span class="p">(</span><span class="n">shd</span><span class="p">.</span><span class="n">AxisType</span><span class="p">.</span><span class="n">Explicit</span><span class="p">,</span> <span class="n">shd</span><span class="p">.</span><span class="n">AxisType</span><span class="p">.</span><span class="n">Explicit</span><span class="p">))</span>

<span class="c1"># è¿™å‘Šè¯‰ JAX å¯¹æ‰€æœ‰æ“ä½œéƒ½ä½¿ç”¨è¿™ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥ä½ åªéœ€æŒ‡å®š PartitionSpec P å³å¯ã€‚
</span><span class="n">jax</span><span class="p">.</span><span class="nf">set_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">device_put</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>

<span class="nd">@jax.jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nf">print</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="nf">typeof</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c1"># bfloat16[8@X,2@Y]
</span>  <span class="n">out</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
  <span class="nf">print</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="nf">typeof</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>  <span class="c1"># bfloat16[8@X,2@Y]
</span>  <span class="k">return</span> <span class="n">out</span>

<span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>å¦‚ä½ æ‰€è§ï¼ŒJAX å°†åˆ†ç‰‡ä»è¾“å…¥ (<code class="language-plaintext highlighter-rouge">x</code>) ä¼ æ’­åˆ°äº†è¾“å‡º (<code class="language-plaintext highlighter-rouge">x</code>)ï¼Œè¿™å¯ä»¥åœ¨è¿½è¸ªæ—¶é€šè¿‡ <code class="language-plaintext highlighter-rouge">jax.typeof</code> è¿›è¡Œæ£€æŸ¥ã€‚å¯¹äºå¤§å¤šæ•°æ“ä½œï¼Œè¿™äº›è§„åˆ™ç®€å•æ˜äº†ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªåˆç†çš„é€‰æ‹©ï¼ˆä¾‹å¦‚ï¼Œé€å…ƒç´ æ“ä½œä¿æŒç›¸åŒçš„åˆ†ç‰‡ï¼‰ã€‚ä½†å¯¹äºæŸäº›æ“ä½œï¼Œå¦‚ä½•å¯¹ç»“æœè¿›è¡Œåˆ†ç‰‡æ˜¯æ¨¡ç³Šçš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJAX ä¼šæŠ›å‡ºä¸€ä¸ªè¿½è¸ªæ—¶é”™è¯¯ï¼Œå¹¶è¦æ±‚ç¨‹åºå‘˜æ˜¾å¼åœ°æä¾›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">out_sharding</code> å‚æ•°ï¼ˆä¾‹å¦‚ jnp.einsumã€jnp.reshape ç­‰ï¼‰ã€‚è®©æˆ‘ä»¬çœ‹å¦ä¸€ä¸ªæœ‰å†²çªçš„ä¾‹å­ï¼š</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="c1"># æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçŸ©é˜µ W å’Œè¾“å…¥æ¿€æ´» Inï¼Œå®ƒä»¬è¢«åˆ†ç‰‡åˆ°æˆ‘ä»¬çš„è®¾å¤‡ä¸Šã€‚
</span><span class="n">In</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2048</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="n">out_sharding</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">8192</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="n">out_sharding</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

<span class="nd">@jax.jit</span>
<span class="k">def</span> <span class="nf">matmul_square</span><span class="p">(</span><span class="n">In</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
  <span class="nf">print</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="nf">typeof</span><span class="p">(</span><span class="n">In</span><span class="p">))</span>  <span class="c1"># bfloat16[8@X, 2048@Y]
</span>  <span class="nf">print</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="nf">typeof</span><span class="p">(</span><span class="n">W</span><span class="p">))</span>  <span class="c1"># bfloat16[2048@Y, 8192]
</span>  <span class="k">return</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">einsum</span><span class="p">(</span><span class="sh">'</span><span class="s">bd,df-&gt;bf</span><span class="sh">'</span><span class="p">,</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">square</span><span class="p">(</span><span class="n">In</span><span class="p">),</span> <span class="n">W</span><span class="p">)</span>

<span class="nf">matmul_square</span><span class="p">(</span><span class="n">In</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>  <span class="c1"># è¿™ä¼šæŠ¥é”™
</span></code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>è¿™æ®µä»£ç ä¼šæŠ¥é”™ <code class="language-plaintext highlighter-rouge">Contracting dimensions are sharded and it is ambiguous how the output should be sharded. Please specify the output sharding via the </code>out_sharding<code class="language-plaintext highlighter-rouge"> parameter. Got lhs_contracting_spec=('Y',) and rhs_contracting_spec=('Y',)</code></p> <p>è¿™å¤ªæ£’äº†ï¼Œå› ä¸º einsum çš„è¾“å‡ºåº”è¯¥å¦‚ä½•åˆ†ç‰‡æ˜¯æ¨¡ç³Šçš„ã€‚è¾“å‡ºåˆ†ç‰‡å¯ä»¥æ˜¯ï¼š</p> <ul> <li>P(â€˜Xâ€™, â€˜Yâ€™) è¿™å°†å¯¼è‡´ä¸€ä¸ª reduce-scatterï¼Œæˆ–è€…</li> <li>P(â€˜Xâ€™, None) è¿™å°†å¯¼è‡´ä¸€ä¸ª all-reduce</li> </ul> <p>ä¸è‡ªåŠ¨æ¨¡å¼ä¸åŒï¼Œæ˜¾å¼æ¨¡å¼åœ¨æ£€æµ‹åˆ°æ¨¡ç³Šçš„é€šä¿¡æ—¶ä¼šæŠ¥é”™ï¼Œå¹¶è¦æ±‚ç”¨æˆ·è§£å†³å®ƒã€‚æ‰€ä»¥åœ¨è¿™é‡Œä½ å¯ä»¥è¿™æ ·åšï¼š</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="nd">@jax.jit</span>
<span class="k">def</span> <span class="nf">matmul_square</span><span class="p">(</span><span class="n">In</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">einsum</span><span class="p">(</span><span class="sh">'</span><span class="s">bd,df-&gt;bf</span><span class="sh">'</span><span class="p">,</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">square</span><span class="p">(</span><span class="n">In</span><span class="p">),</span> <span class="n">W</span><span class="p">,</span> <span class="n">out_sharding</span><span class="o">=</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>

<span class="n">out</span> <span class="o">=</span> <span class="nf">matmul_square</span><span class="p">(</span><span class="n">In</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="nf">typeof</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>  <span class="c1"># bfloat16[8@X,8192@Y]
</span></code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>è‡ªåŠ¨æ¨¡å¼å’Œæ˜¾å¼æ¨¡å¼å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">jax.sharding.auto_axes</code> å’Œ <code class="language-plaintext highlighter-rouge">jax.sharding.explicit_axes</code> API ç»„åˆä½¿ç”¨ã€‚æƒ³äº†è§£æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡<a href="https://docs.jax.dev/en/latest/notebooks/explicit-sharding.html" rel="external nofollow noopener" target="_blank">å¾ˆæ£’çš„æ–‡æ¡£</a>ã€‚</p> <h3 id="manual-sharding-mode-via-shard_map">shard_map: å¯¹ç¨‹åºçš„æ˜¾å¼å¹¶è¡Œæ€§æ§åˆ¶</h3> <p>å¦‚æœè¯´ Shardy æ˜¯â€œç¼–è¯‘å™¨æŒèˆµâ€æ¨¡å¼ï¼Œé‚£ä¹ˆ jax <a href="https://jax.readthedocs.io/en/latest/jep/14273-shard-map.html" rel="external nofollow noopener" target="_blank">shard_map</a> åˆ™å°†ä¸€åˆ‡éƒ½äº¤åˆ°ä½ æ‰‹ä¸­ã€‚ä½ åƒåœ¨ jax.jit ä¸­ä¸€æ ·æŒ‡å®šè¾“å…¥çš„åˆ†ç‰‡ï¼Œä½†ä¹‹åä½ éœ€è¦æ˜¾å¼åœ°ç¼–å†™æ‰€æœ‰é€šä¿¡ã€‚jax.jit ç»™ä½ ç•™ä¸‹çš„æ˜¯ç¨‹åºçš„å…¨å±€è·¨è®¾å¤‡è§†å›¾ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">shard_map</code> ç»™ä½ çš„æ˜¯ä¸€ä¸ªæœ¬åœ°çš„æ¯è®¾å¤‡è§†å›¾ã€‚</p> <p>è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­ã€‚è¯•ç€æ¨æ–­ä¸€ä¸‹è¿™ä¸ªå‡½æ•°æ˜¯åšä»€ä¹ˆçš„ï¼š<d-footnote id="d-footnote-2">å¦‚æœä½ æƒ³åœ¨ colab ä¸­é€šè¿‡æ¨¡æ‹Ÿç½‘æ ¼æ¥è‡ªå·±å°è¯•ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å•å…ƒæ ¼ `import jax; jax.config.update('jax_num_cpu_devices', 8)`</d-footnote></p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="kn">import</span> <span class="n">jax</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>
<span class="kn">import</span> <span class="n">jax.sharding</span> <span class="k">as</span> <span class="n">shd</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">make_mesh</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="n">shd</span><span class="p">.</span><span class="n">AxisType</span><span class="p">.</span><span class="n">Explicit</span><span class="p">,</span> <span class="n">shd</span><span class="p">.</span><span class="n">AxisType</span><span class="p">.</span><span class="n">Explicit</span><span class="p">))</span>
<span class="n">jax</span><span class="p">.</span><span class="nf">set_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">out_sharding</span><span class="o">=</span><span class="nc">P</span><span class="p">((</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">)))</span>

<span class="c1"># è¿™ä¸ªå‡½æ•°å°†å¯¹æ•°ç»„çš„ 1/8 è¿›è¡Œæ“ä½œã€‚
</span><span class="nd">@jax.shard_map</span><span class="p">(</span><span class="n">in_specs</span><span class="o">=</span><span class="nc">P</span><span class="p">((</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="nc">P</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">slice_and_average</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">assert</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">512</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,)</span>
  <span class="k">return</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">pmean</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">axis_name</span><span class="o">=</span><span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">))</span>

<span class="n">out</span> <span class="o">=</span> <span class="nf">slice_and_average</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">out</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p><strong>è¿™æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</strong> <code class="language-plaintext highlighter-rouge">slice_and_average</code> åœ¨æ¯ä¸ª TPU ä¸Šè¿è¡Œï¼Œå¤„ç†æ•°ç»„çš„ 1/8ï¼Œæˆ‘ä»¬ä»ä¸­åˆ‡ç‰‡å‰ 4 ä¸ªå…ƒç´ ï¼Œå¹¶åœ¨æ•´ä¸ªç½‘æ ¼ä¸Šå¯¹å®ƒä»¬æ±‚å¹³å‡å€¼ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å®é™…ä¸Šåœ¨åš <code class="language-plaintext highlighter-rouge">mean(x[:4], x[64:68], x[128:132], â€¦)</code>ã€‚è¿™éå¸¸é…·ï¼Œå› ä¸ºåœ¨ JAX ä¸­ç”¨å…¶ä»–æ–¹å¼è¡¨è¾¾è¿™ä¸ªæ“ä½œå¹¶ä¸å®¹æ˜“ã€‚</p> <p><strong>ä¸ºä»€ä¹ˆè¦è¿™æ ·åšè€Œä¸æ˜¯ç”¨ jax.jitï¼Ÿ</strong> å¦‚æœæˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">jax.jit</code>ï¼Œ<code class="language-plaintext highlighter-rouge">slice_and_average</code> å°†ä¼šçœ‹åˆ°æ•°ç»„çš„å…¨å±€è§†å›¾ï¼ˆå®Œæ•´çš„ <code class="language-plaintext highlighter-rouge">[512,]</code> æ•°ç»„ï¼‰ã€‚æˆ‘ä»¬å°†ä¸å¾—ä¸åˆ‡å‡ºè¿™ä¸ªéå‡åŒ€çš„åˆ‡ç‰‡ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªå¹³å‡æ“ä½œï¼Œè€Œ XLA å¿…é¡»æ­£ç¡®åœ°è§£é‡Šå®ƒã€‚XLA å¯èƒ½ä¼šæ·»åŠ é”™è¯¯çš„é€šä¿¡æˆ–æ„Ÿåˆ°å›°æƒ‘ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°çš„æ˜¯æœ¬åœ°è§†å›¾ï¼Œå¹¶ä¸”åªç¼–å†™æˆ‘ä»¬éœ€è¦çš„é€šä¿¡ã€‚</p> <p><strong>ç¤ºä¾‹ [é›†åˆçŸ©é˜µä¹˜æ³•]ï¼š</strong> ä¸¾ä¸€ä¸ªæ›´ç°å®çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦å®ç°æ¨¡å‹å¹¶è¡Œæ€§ï¼Œå…¶ä¸­æ¿€æ´»æœ€åˆæ˜¯æŒ‰æ¨¡å‹åˆ†ç‰‡çš„ï¼Œå³ A[B<sub>X</sub>, D<sub>Y</sub>] * W[D, F<sub>Y</sub>] -&gt; Out[B<sub>X</sub>, F<sub>Y</sub>]ã€‚å¤©çœŸåœ°ï¼Œæˆ‘ä»¬ä¼šå…ˆå¯¹ A è¿›è¡Œ AllGatherï¼Œç„¶åè¿›è¡Œä¸€ä¸ªæœ¬åœ°çŸ©é˜µä¹˜æ³•ï¼š</p> <ol> <li>A[B<sub>X</sub>, D] = <strong>AllGather</strong><sub>Y</sub>(A[B<sub>X</sub>, D<sub>Y</sub>])</li> <li>Out[B<sub>X</sub>, F<sub>Y</sub>] = A[B<sub>X</sub>, D] *<sub>D</sub> W[D, F<sub>Y</sub>]</li> </ol> <p>å¯æƒœï¼Œè¿™æ ·åšä¸å¥½ï¼Œå› ä¸ºå®ƒä¸å…è®¸æˆ‘ä»¬å°†é€šä¿¡ä¸è®¡ç®—é‡å ã€‚å¦‚ <a href="https://dl.acm.org/doi/pdf/10.1145/3567955.3567959" rel="external nofollow noopener" target="_blank">Wang et al. 2023</a> ä¸­æ‰€è¿°ï¼Œå¯ä»¥é€šè¿‡â€œé›†åˆçŸ©é˜µä¹˜æ³•â€æ¥å®ç°é‡å ã€‚ç®—æ³•åŸºæœ¬å¦‚ä¸‹ï¼š</p> <ul> <li>å¯¹äºæ¯ä¸ª Y åˆ†ç‰‡ï¼Œå°† A çš„æœ¬åœ°å—ä¸ W çš„æœ¬åœ°å—è¿›è¡ŒçŸ©é˜µä¹˜æ³•ï¼Œäº§ç”Ÿå½¢çŠ¶ä¸º <code class="language-plaintext highlighter-rouge">[B / X, F / Y]</code> çš„ç»“æœã€‚åŒæ—¶ï¼Œå¯¹ A è¿›è¡Œç½®æ¢ï¼Œä»¥ä¾¿åœ¨æœ¬åœ°è·å¾—ä¸‹ä¸€ä¸ªå—ï¼Œæ‰§è¡ŒçŸ©é˜µä¹˜æ³•ï¼Œå¹¶å°†ç»“æœç›¸åŠ ã€‚</li> </ul> <p>æˆ‘ä»¬å¯ä»¥ç”¨ shard_map ç›¸å½“å®¹æ˜“åœ°å®ç°è¿™ä¸€ç‚¹ï¼š</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="kn">import</span> <span class="n">functools</span>

<span class="kn">import</span> <span class="n">jax</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>
<span class="kn">import</span> <span class="n">jax.sharding</span> <span class="k">as</span> <span class="n">shd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">make_mesh</span><span class="p">(</span><span class="n">axis_shapes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">axis_names</span><span class="o">=</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">),</span>
                                       <span class="n">axis_types</span><span class="o">=</span><span class="p">(</span><span class="n">shd</span><span class="p">.</span><span class="n">AxisType</span><span class="p">.</span><span class="n">Explicit</span><span class="p">,</span> <span class="n">shd</span><span class="p">.</span><span class="n">AxisType</span><span class="p">.</span><span class="n">Explicit</span><span class="p">))</span>
<span class="n">jax</span><span class="p">.</span><span class="nf">set_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

<span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">8192</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">prod</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">))).</span><span class="nf">reshape</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">prod</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">F</span><span class="p">))).</span><span class="nf">reshape</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">device_put</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">device_put</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>

<span class="nd">@functools.partial</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">out_shardings</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">matmul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">lhs</span> <span class="o">@</span> <span class="n">rhs</span>

<span class="k">def</span> <span class="nf">collective_matmul_allgather_lhs_contracting</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
  <span class="c1"># lhs æ˜¯å¾ªç¯æ“ä½œæ•°ï¼›rhs æ˜¯æœ¬åœ°æ“ä½œæ•°
</span>  <span class="n">axis_size</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">axis_size</span><span class="p">(</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># åœ¨è¿™ä¸ªä¾‹å­ä¸­ axis_size = 4
</span>  <span class="n">idx</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">axis_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)</span>

  <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">assert</span> <span class="n">rhs</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">chunk_size</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">carrys</span><span class="p">):</span>
    <span class="n">accum</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">carrys</span>
    <span class="n">rhs_chunk</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">dynamic_slice_in_dim</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">axis_size</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
    <span class="c1"># å¯¹ä¸€ä¸ªå—è¿›è¡ŒçŸ©é˜µä¹˜æ³•
</span>    <span class="n">update</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">@</span> <span class="n">rhs_chunk</span>
    <span class="c1"># å‘å·¦å¾ªç¯ç§»ä½
</span>    <span class="n">lhs</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">ppermute</span><span class="p">(
        </span><span class="n">lhs</span><span class="p">,</span>
        <span class="n">axis_name</span><span class="o">=</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">perm</span><span class="o">=</span><span class="p">[(</span><span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">axis_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">axis_size</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">accum</span> <span class="o">+</span> <span class="n">update</span><span class="p">,</span> <span class="n">lhs</span>

  <span class="n">accum</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">lhs</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rhs</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">lhs</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="n">accum</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">pvary</span><span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>
  <span class="n">accum</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">lhs</span><span class="p">),</span> <span class="n">unroll</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="c1"># åœ¨æœ€åä¸€æ¬¡ç½®æ¢åè®¡ç®—æœ€åä¸€ä¸ªå—ï¼Œä»¥ä½¿ lhs æ¢å¤åˆ°æˆ‘ä»¬æ‰¾åˆ°å®ƒæ—¶çš„çŠ¶æ€
</span>  <span class="n">i</span> <span class="o">=</span> <span class="n">axis_size</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">rhs_chunk</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">lax</span><span class="p">.</span><span class="nf">dynamic_slice_in_dim</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">axis_size</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
  <span class="n">update</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">@</span> <span class="n">rhs_chunk</span>
  <span class="k">return</span> <span class="n">accum</span> <span class="o">+</span> <span class="n">update</span>

<span class="n">jit_sharded_f</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">jit</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="nf">shard_map</span><span class="p">(
  </span><span class="n">collective_matmul_allgather_lhs_contracting</span><span class="p">,</span>
  <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">),</span> <span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)))</span>

<span class="n">shmapped_out</span> <span class="o">=</span> <span class="nf">jit_sharded_f</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<span class="n">expected_out</span> <span class="o">=</span> <span class="nf">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>

<span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">shmapped_out</span><span class="p">,</span> <span class="n">expected_out</span><span class="p">)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>è¿™éå¸¸å·§å¦™ï¼æˆ‘ä»¬å¯ä»¥å¯¹æ­¤è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå‘ç°å®ƒä¹Ÿå¿«å¾—å¤šï¼<a href="https://imgur.com/a/e9I6SrM" rel="external nofollow noopener" target="_blank">è¿™é‡Œæ˜¯</a>é»˜è®¤ jit çŸ©é˜µä¹˜æ³•çš„æ€§èƒ½å‰–æï¼Œå®ƒè€—æ—¶ 311usï¼Œå¹¶ä¸”åœ¨å¼€å§‹æ—¶æœ‰ä¸€ä¸ªå¤§çš„é˜»å¡å¼ AllGatherï¼š</p> <figure> <picture> <source class="responsive-img-srcset" sizes="95vw" srcset="https://jax-ml.github.io/scaling-book/assets/img/not-overlapped-480.webp 480w, https://jax-ml.github.io/scaling-book/assets/img/not-overlapped-800.webp 800w, https://jax-ml.github.io/scaling-book/assets/img/not-overlapped-1400.webp 1400w" type="image/webp"/> <img class="img-fluid" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" src="https://jax-ml.github.io/scaling-book/assets/img/not-overlapped.png" width="100%"/> </picture> </figure> <p><a href="https://imgur.com/a/21iy0Sv" rel="external nofollow noopener" target="_blank">è¿™é‡Œæ˜¯</a>ä¸Šé¢é‚£ä¸ªç‰ˆæœ¬çš„å‰–æï¼Œè€—æ—¶ 244 usã€‚ä½ å¯ä»¥çœ‹åˆ°å‰–æä¸­æ²¡æœ‰ AllGatherã€‚å…¨éƒ½æ˜¯æœ‰æ•ˆçš„å·¥ä½œï¼æˆ‘ä»¬çš„ FLOPs åˆ©ç”¨ç‡ä¹Ÿé«˜å¾—å¤šã€‚</p> <figure> <picture> <source class="responsive-img-srcset" sizes="95vw" srcset="https://jax-ml.github.io/scaling-book/assets/img/overlapped-480.webp 480w, https://jax-ml.github.io/scaling-book/assets/img/overlapped-800.webp 800w, https://jax-ml.github.io/scaling-book/assets/img/overlapped-1400.webp 1400w" type="image/webp"/> <img class="img-fluid" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();" src="https://jax-ml.github.io/scaling-book/assets/img/overlapped.png" width="100%"/> </picture> </figure> <p>è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ”¶ç¼©ç»´åº¦ä¸Šæ²¡æœ‰åˆ†ç‰‡æ—¶çš„çŸ©é˜µä¹˜æ³•æ—¶é—´æ˜¯ <a href="https://imgur.com/a/i3gNKfq" rel="external nofollow noopener" target="_blank">224us</a>ï¼Œæ‰€ä»¥æˆ‘ä»¬éå¸¸æ¥è¿‘æœªåˆ†ç‰‡çš„åŸºçº¿ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œè¯´æ˜äº†ä½ å¯èƒ½éœ€è¦è¿›è¡Œä½•ç§æ€§èƒ½å·¥ç¨‹æ¥æé«˜ TPU çš„åˆ©ç”¨ç‡ã€‚è¦äº†è§£æ›´å¤š <code class="language-plaintext highlighter-rouge">shard_map</code> ç¤ºä¾‹ï¼Œ<a href="https://jax.readthedocs.io/en/latest/notebooks/shard_map.html#example-1-all-gather-on-one-side" rel="external nofollow noopener" target="_blank">è¿™ç¯‡ç¬”è®°å¾ˆæ£’</a>ã€‚</p> <p>ç°åœ¨è¿™é‡Œæœ‰å‡ ä¸ªæœ‰ç”¨çš„å®è·µé—®é¢˜ï¼Œå¯ä»¥å°è¯•ç”¨ <code class="language-plaintext highlighter-rouge">jax.jit</code> æˆ– <code class="language-plaintext highlighter-rouge">shard_map</code> æ¥å®ç°ï¼</p> <h2 id="worked-problems">å®è·µé—®é¢˜</h2> <p>è¿™é‡Œæœ‰ä¸€äº›éšæœºçš„ JAX ç›¸å…³é—®é¢˜ã€‚æˆ‘ç¨åä¼šæ·»åŠ æ›´å¤šã€‚å¯¹äºæ‰€æœ‰è¿™äº›é—®é¢˜ï¼Œä½ éƒ½éœ€è¦åœ¨ Colab ä¸­æœ‰ä¸€å®šæ•°é‡çš„ TPUã€‚ä½ å¯ä»¥ä½¿ç”¨å¸¦æœ‰ TPUv2-8 çš„å…¬å…± Colabã€‚ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬å‡è®¾ä½ æœ‰ N ä¸ªå¯ç”¨è®¾å¤‡ã€‚</p> <p><strong>é—®é¢˜1ï¼š</strong>è®¾ <strong>A</strong> æ˜¯ä¸€ä¸ªæ¿€æ´»æ•°ç»„ï¼Œå½¢çŠ¶ä¸º float32[S<sub>X</sub>, D<sub>Y</sub>]ï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">X * Y = N</code>ã€‚è¯·å®Œæˆä»¥ä¸‹æ“ä½œï¼š</p> <ol> <li> <p>åœ¨ JAX ä¸­ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—æ¯ä¸ª <code class="language-plaintext highlighter-rouge">(X, Y)</code> åˆ†ç‰‡å†…çš„å¹³å‡å€¼ï¼Œå³è¿”å›ä¸€ä¸ªå¤§å°ä¸º [X, Y] çš„æ•°ç»„ï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">arr[i, j]</code> æ˜¯åˆ†ç‰‡ <code class="language-plaintext highlighter-rouge">(i, j)</code> ä¸Šçš„å¹³å‡å€¼ã€‚åˆ†åˆ«ç”¨ <code class="language-plaintext highlighter-rouge">jax.jit</code> å’Œ <code class="language-plaintext highlighter-rouge">shard_map</code> å®ç°ã€‚å¯¹æ¯ä¸ªå®ç°è¿›è¡Œæ€§èƒ½åˆ†æï¼Œçœ‹çœ‹å®ƒä»¬è€—æ—¶å¤šä¹…ã€‚æ˜¯å¦æ·»åŠ äº†ä»»ä½•é€šä¿¡ï¼Ÿ<em>æç¤ºï¼šä¸åº”è¯¥æœ‰ï¼Œä½†æœ‰æ—¶ XLA è¿˜æ˜¯ä¼šæ·»åŠ ã€‚</em></p> </li> <li> <p>åœ¨ JAX ä¸­ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œå¯¹äºæ¯ä¸ªåˆ†ç‰‡ X å†…éƒ¨çš„æŸä¸ªä½ç§»ï¼Œè¿”å› roll(x, shift, axis=0) - xã€‚æˆ‘è¿˜æ²¡é‚£ä¹ˆè‡ªè™ï¼Œä¸ä¼šè®©ä½ ç”¨ jax.jit æ¥åšè¿™ä¸ªï¼Œæ‰€ä»¥åªç”¨ <code class="language-plaintext highlighter-rouge">shard_map</code> å®ç°å³å¯ã€‚</p> </li> </ol> <details><summary>ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹ç­”æ¡ˆã€‚</summary> <p>ç¬¬1éƒ¨åˆ†ï¼šè¿™æ˜¯ç¬¬1éƒ¨åˆ†çš„è§£ç­”ã€‚è¯·æ³¨æ„ï¼Œå¯¹äº <code class="language-plaintext highlighter-rouge">jax.jit</code> çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¿…é¡»è¿›è¡Œç›¸å½“å¤æ‚çš„é‡å¡‘æ“ä½œã€‚</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="kn">import</span> <span class="n">jax</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">sharding</span><span class="p">.</span><span class="n">PartitionSpec</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">make_mesh</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>

<span class="n">average_shmap</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">shard_map</span><span class="p">(
    </span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
    <span class="n">in_specs</span><span class="o">=</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">axis_sizes</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">Y</span><span class="p">).</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">average_jit</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">jit</span><span class="p">(</span><span class="n">average</span><span class="p">,</span> <span class="n">out_shardings</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">NamedSharding</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)))</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="n">int32</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">device_put</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">jax</span><span class="p">.</span><span class="nc">NamedSharding</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)))</span>

<span class="n">y1</span> <span class="o">=</span> <span class="nf">average_shmap</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="nf">average_jit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> <p>ç¬¬2éƒ¨åˆ†ï¼šè¿™æ˜¯ç¬¬2éƒ¨åˆ†çš„ç±»ä¼¼è§£ç­”ã€‚</p> <div class="language-py highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="kn">import</span> <span class="n">jax</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>

<span class="kn">import</span> <span class="n">functools</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="n">sharding</span><span class="p">.</span><span class="n">PartitionSpec</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">make_mesh</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">shift_shmap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
  <span class="n">shmapped</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">shard_map</span><span class="p">(
      </span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">roll</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
      <span class="n">in_specs</span><span class="o">=</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="nf">shmapped</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nd">@functools.partial</span><span class="p">(</span><span class="n">jax</span><span class="p">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">shift</span><span class="sh">'</span><span class="p">],</span> <span class="n">out_shardings</span><span class="o">=</span><span class="n">jax</span><span class="p">.</span><span class="nc">NamedSharding</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">shift_jit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
  <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">axis_sizes</span>
  <span class="n">reshaped</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">roll</span><span class="p">(</span><span class="n">reshaped</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="n">int32</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="p">.</span><span class="nf">device_put</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">jax</span><span class="p">.</span><span class="nc">NamedSharding</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="nc">P</span><span class="p">(</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">)))</span>

<span class="n">y1</span> <span class="o">=</span> <span class="nf">shift_shmap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="nf">shift_jit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">np</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="nf">assert_array_equal</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> </details> <p><strong>é—®é¢˜2ï¼š</strong>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä¸€èµ·æ„å»ºä¸€ä¸ªåŸºæœ¬çš„â€œä¸“å®¶æ··åˆâ€ï¼ˆMoEï¼‰æ¨¡å‹ã€‚è®¾ <strong>W</strong>: float32[E<sub>X</sub>, D, F<sub>Y</sub>] æ˜¯ä¸€ç»„ E ä¸ªâ€œä¸“å®¶â€çŸ©é˜µã€‚è®¾ <strong>A</strong>: float32[S<sub>X</sub>, D<sub>Y</sub>]ï¼ˆæˆ‘ä»¬çš„æ¿€æ´»ï¼‰å¹¶ä¸”è®¾ <strong>B</strong> æ˜¯ä¸€ç»„â€œè·¯ç”±åˆ†é…â€ï¼Œå…¶ä¸­ B[i] æ˜¯èŒƒå›´ <code class="language-plaintext highlighter-rouge">[0, E)</code> å†…çš„ä¸€ä¸ªæ•´æ•°ï¼Œå‘Šè¯‰æˆ‘ä»¬å¸Œæœ›ç”¨å“ªä¸ªçŸ©é˜µæ¥å¤„ç†è¯¥æ¿€æ´»ã€‚æˆ‘ä»¬æƒ³åœ¨ JAX ä¸­ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å› <code class="language-plaintext highlighter-rouge">Out[i] = W[B[i]] @ A[i]</code>ã€‚</p> <ol> <li> <p>è®©æˆ‘ä»¬å…ˆå®Œå…¨å¿½ç•¥åˆ†ç‰‡ã€‚å°†æ‰€æœ‰è¿™äº›å¼ é‡åšå¾—è¶³å¤Ÿå°ï¼Œä»¥ä¾¿å®ƒä»¬èƒ½æ”¾å…¥ä¸€ä¸ªè®¾å¤‡ä¸­ã€‚ç¼–å†™è¿™ä¸ªå‡½æ•°çš„æœ¬åœ°å®ç°ã€‚<em>ç¡®ä¿ä½ ä¸è¦ç‰©åŒ–ä¸€ä¸ªå½¢çŠ¶ä¸º <code class="language-plaintext highlighter-rouge">[S, D, F]</code> çš„æ•°ç»„ï¼æç¤ºï¼šå°è¯•å°†ä»¤ç‰Œæ’åºåˆ°ä¸€ä¸ªå½¢çŠ¶ä¸º <code class="language-plaintext highlighter-rouge">[E, S, D]</code> çš„æ–°ç¼“å†²åŒºä¸­ï¼Œå¹¶æ³¨æ„æ©ç ï¼ˆä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ç¬¬äºŒä¸ªç»´åº¦çš„å¤§å°ä¸º Sï¼Ÿï¼‰ã€‚</em></p> </li> <li> <p>å¦‚æœä½ åªæ˜¯å¯¹ä¸Šè¿°æ–¹æ³•ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">jax.jit</code>ï¼Œä¼šå‘ç”Ÿä¸€äº›äº‹æƒ…ã€‚å¯¹æ­¤è¿›è¡Œæ€§èƒ½åˆ†æï¼Œçœ‹çœ‹å®ƒå†³å®šè¿›è¡Œä½•ç§é€šä¿¡ã€‚å®ƒéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ</p> </li> <li> <p>ä½ ä¼šæ³¨æ„åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä¸Šè¿°æ–¹æ³•å¾ˆå¯èƒ½ä¼šåœ¨æœ¬åœ°æ”¶é›†å®Œæ•´çš„æ¿€æ´»é›† <strong>A</strong>ï¼Œå³ AllGather<sub>X</sub>([S<sub>X</sub>, D<sub>Y</sub>])ã€‚è¿™ä¸ä»…åœ¨é€šä¿¡æ–¹é¢æˆæœ¬é«˜æ˜‚ï¼Œè€Œä¸”å¦‚æœæˆ‘ä»¬æ— æ³•åœ¨æœ¬åœ°å®¹çº³å®Œæ•´çš„æ¿€æ´»é›†ï¼Œåœ¨å†…å­˜æ–¹é¢ä¹Ÿæ˜¯æå…¶æ˜‚è´µçš„ã€‚ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">shard_map</code> å’Œæ˜¾å¼é€šä¿¡æ¥å®ç°ä¸Šè¿°åŠŸèƒ½ã€‚</p> <ol> <li> <p>ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæœ€ç®€å•çš„æ–¹æ³•å¯èƒ½æ˜¯ä½¿ç”¨ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">jax.lax.all_gather</code> å¹¶åƒï¼ˆaï¼‰ä¸­é‚£æ ·é‡æ–°æ’åºã€‚</p> </li> <li> <p>ä½œä¸ºç¬¬äºŒæ­¥ï¼Œå°è¯•é¿å…ç‰©åŒ–ä»»ä½•å¤§å°ä¸º <code class="language-plaintext highlighter-rouge">[E, S, D]</code> çš„æ•°ç»„ï¼Œå³å°è¯•åœ¨ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">jax.lax.while_loop</code> å†…éƒ¨ä½¿ç”¨ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">jax.lax.all_to_all</code> ä»¥ä¸è§„åˆ™çš„æ–¹å¼æ‰§è¡Œè®¡ç®—ã€‚è¿™æ ·ï¼Œä½ å¯ä»¥é¿å…ç‰©åŒ–å®Œæ•´çš„æ¿€æ´»å¹¶æµªè´¹è®¡ç®—åœ¨å¡«å……ä¸Šã€‚è¿™æ¯”ä½ æœ€åˆçš„å®ç°å¿«å¤šå°‘ï¼Ÿ</p> </li> </ol> </li> <li> <p>å¤§å¤šæ•° MoE æ¨¡å‹ä¼šå°†è¾“å…¥è·¯ç”±åˆ°å¤šä¸ªï¼ˆk ä¸ªï¼‰ä¸“å®¶ï¼Œç„¶åå¯¹ç»“æœè¿›è¡Œå¹³å‡ã€‚é‡æ„ä¸Šè¿°ä»£ç ä»¥å®ç°è¿™ä¸€ç‚¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè®¾ <strong>B</strong>: int32[S, k] ç”¨äºè·¯ç”±åˆ° k ä¸ªä¸“å®¶ã€‚</p> </li> </ol> <p><strong>é—®é¢˜3ï¼š</strong>ä¸Šé¢é‚£ä¸ªé›†åˆçŸ©é˜µä¹˜æ³•çš„ä¾‹å­å®é™…ä¸Šä¸çœŸå®çš„ LLM éå¸¸ç›¸å…³ã€‚è®©æˆ‘ä»¬è°ƒæ•´è¿™ä¸ªä¾‹å­æ¥å®Œæˆæ•´ä¸ª Transformer æ ˆã€‚</p> <ol> <li> <p>ä½œä¸ºä¸€ä¸ªç»ƒä¹ ï¼Œè®©æˆ‘ä»¬ä»å®ç°ä¸€ä¸ª AllReduce é›†åˆçŸ©é˜µä¹˜æ³•å¼€å§‹ï¼Œå³ A[B<sub>X</sub>, D<sub>Y</sub>] *<sub>D</sub> W[D<sub>Y</sub>, F] -&gt; Out[B<sub>X</sub>, F]ã€‚æ³¨æ„è¾“å‡ºä¸æ˜¯å¤åˆ¶çš„ã€‚ä¸Šé¢è®¨è®ºäº†æœ´ç´ ç®—æ³•ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªæœ¬åœ°çŸ©é˜µä¹˜æ³•åè·Ÿä¸€ä¸ª AllReduceã€‚å°è¯•åˆ¶ä½œä¸€ä¸ªé€šä¿¡é‡å çš„â€œé›†åˆâ€ç‰ˆæœ¬çš„æ­¤æ“ä½œã€‚<em>æç¤ºï¼šåœ¨è¾“å‡ºç»´åº¦ä¸Šè¿›è¡Œåˆ†å—ï¼Œå¹¶å¯ä»¥éšæ„ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">jax.lax.psum</code>ï¼ˆå³ AllReduceï¼‰ã€‚</em> <em>æ³¨æ„ï¼šç”±äº XLA å¤„ç†æ­¤é—®é¢˜çš„æ–¹å¼ï¼Œå®ƒå®é™…ä¸Šå¯èƒ½ä¸ä¼šæ¯”åŸºçº¿æ›´å¿«ã€‚</em></p> </li> <li> <p>ä¸Šé¢ AllReduce é›†åˆçŸ©é˜µä¹˜æ³•çš„è¡¥å……æ˜¯ ReduceScatter é›†åˆçŸ©é˜µä¹˜æ³•ï¼Œå¦‚ Tmp[B<sub>X</sub>, F<sub>Y</sub>] *<sub>F</sub> W2[F<sub>Y</sub>, D] -&gt; Out[B<sub>X</sub>, D<sub>Y</sub>]ã€‚è¿™å‘ç”Ÿåœ¨ Transformer ä¸­çš„ä¸‹æŠ•å½±çŸ©é˜µä¸­ã€‚åœ¨ JAX ä¸­å®ç°ä¸€ä¸ªé›†åˆçš„ã€é‡å çš„ç‰ˆæœ¬ã€‚æ³¨æ„åªä¼ é€’æ‰€éœ€çš„æœ€å°‘é‡æ•°æ®ã€‚<em>æç¤ºï¼šå°è¯•åœ¨ç´¯åŠ ç»“æœæ—¶å¯¹å…¶è¿›è¡Œç½®æ¢ã€‚</em></p> </li> <li> <p>å°†è¿™ä¸¤è€…ç»„åˆæˆä¸€ä¸ªç«¯åˆ°ç«¯çš„ Transformer å—ï¼Œè¯¥å—æ‰§è¡Œ In[B<sub>X</sub>, D<sub>Y</sub>] *<sub>D</sub> W<sub>in</sub>[D, F<sub>Y</sub>] *<sub>F</sub> W<sub>out</sub>[F<sub>Y</sub>, D] -&gt; Out[B<sub>X</sub>, D<sub>Y</sub>] å¹¶å¸¦æœ‰é‡å çš„é€šä¿¡ã€‚<d-footnote id="d-footnote-3">å’Œä¹‹å‰ä¸€æ ·ï¼Œç”±äºæˆ‘ä»¬åœ¨æ­¤çœç•¥äº†ä¸€ä¸ªéçº¿æ€§æ“ä½œï¼Œæˆ‘ä»¬ä¸èƒ½å…ˆè®¡ç®— <d-math>W_{in} \cdot W_{out}</d-math>ã€‚</d-footnote> è¿™æ¯” <code class="language-plaintext highlighter-rouge">jax.jit</code> å®ç°å¿«å¤šå°‘ï¼Ÿ</p> </li> </ol> <p><strong>é—®é¢˜4ï¼š</strong>ä¸Šé¢å®ç°çš„æ‰€æœ‰é›†åˆçŸ©é˜µä¹˜æ³•éƒ½æ˜¯å•å‘çš„ï¼šå®ƒä»¬åªåœ¨ä¸€ä¸ªæ–¹å‘ä¸Šè¿›è¡Œç½®æ¢ã€‚é‡å†™é›†åˆ AllReduce çŸ©é˜µä¹˜æ³•å’Œé›†åˆ ReduceScatter çŸ©é˜µä¹˜æ³•ï¼Œä»¥ä½¿ç”¨åŒå‘é€šä¿¡ã€‚å®ƒä»¬å¿«äº†å¤šå°‘ï¼Ÿ</p> <h3 id="thats-all-for-part-10-thats-basically-it-for-final-conclusions-and-further-reading-click-here">ç¬¬10éƒ¨åˆ†åˆ°æ­¤ç»“æŸã€‚åŸºæœ¬ä¸Šå°±æ˜¯è¿™æ ·äº†ï¼è¦æŸ¥çœ‹æœ€ç»ˆç»“è®ºå’Œè¿›ä¸€æ­¥é˜…è¯»ï¼Œè¯·ç‚¹å‡»<a href="conclusion.html">æ­¤å¤„</a>ã€‚</h3> </d-article> <d-appendix>
<style>

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

</style>
<d-footnote-list style="">
<style>

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}

</style>
<h3>è„šæ³¨</h3>
<ol><li id="d-footnote-1-listing">æ³¨æ„æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ã€‚è¿™æ˜¯ä¸€ç§åˆ›å»ºå…·æœ‰ç‰¹å®šåˆ†ç‰‡æ•°ç»„çš„æ–¹æ³•ï¼ˆå³é€šè¿‡å‘åˆ›å»ºå‡½æ•°æ·»åŠ  device å‚æ•°ï¼‰ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ `jnp.array(....)` æ­£å¸¸åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œç„¶åæ‰§è¡Œä¾‹å¦‚ `jax.device_put(..., P('x', 'y'))`ã€‚è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºä½ æƒ³è¦çš„æ•°ç»„ï¼Œç„¶åä½¿ç”¨ä½ æƒ³è¦çš„ `out_shardings` å¯¹å…¶è¿›è¡Œ jit ç¼–è¯‘ã€‚<a class="footnote-backlink" href="#d-footnote-1">[â†©]</a></li><li id="d-footnote-2-listing">å¦‚æœä½ æƒ³åœ¨ colab ä¸­é€šè¿‡æ¨¡æ‹Ÿç½‘æ ¼æ¥è‡ªå·±å°è¯•ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å•å…ƒæ ¼ `import jax; jax.config.update('jax_num_cpu_devices', 8)`<a class="footnote-backlink" href="#d-footnote-2">[â†©]</a></li><li id="d-footnote-3-listing">å’Œä¹‹å‰ä¸€æ ·ï¼Œç”±äºæˆ‘ä»¬åœ¨æ­¤çœç•¥äº†ä¸€ä¸ªéçº¿æ€§æ“ä½œï¼Œæˆ‘ä»¬ä¸èƒ½å…ˆè®¡ç®— <d-math>W_{in} \cdot W_{out}</d-math>ã€‚<a class="footnote-backlink" href="#d-footnote-3">[â†©]</a></li></ol>
</d-footnote-list> <d-citation-list style="display: none;"></d-citation-list> <div class="base-grid appendix-entry"> <h3 style="grid-column: 0;">æ‚é¡¹</h3> <p class="author-footnote" style="grid-column: text;"><sup>*</sup>å·¥ä½œäº Google DeepMind å®Œæˆï¼Œç°å°±èŒäº MatXã€‚</p> </div> <div class="base-grid appendix-entry"> <h3 style="grid-column: 0;">å¼•ç”¨</h3> <p class="author-footnote">åœ¨å­¦æœ¯åœºåˆä¸­å¼•ç”¨ï¼Œè¯·æŒ‰ä»¥ä¸‹æ ¼å¼å¼•ç”¨æ­¤ä½œå“ï¼š</p> <div class="author-footnote"> <div class="language-bibtex highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code>    <span class="c">Austin et al., "How to Scale Your Model", Google DeepMind, online, 2025.</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> </div> <p class="author-footnote">æˆ–ä½¿ç”¨ BibTeX æ¡ç›®ï¼š</p> <div class="author-footnote"> <div class="language-bibtex highlighter-rouge"><div class="highlight"><div class="code-display-wrapper"><pre class="highlight"><code>    <span class="nc">@article</span><span class="p">{</span><span class="nl">scaling-book</span><span class="p">,</span>
      <span class="na">title</span> <span class="p">=</span> <span class="s">{How to Scale Your Model}</span><span class="p">,</span>
      <span class="na">author</span> <span class="p">=</span> <span class="s">{Austin, Jacob and Douglas, Sholto and Frostig, Roy and Levskaya, Anselm and Chen, Charlie and Vikram, Sharad
      and Lebron, Federico and Choy, Peter and Ramasesh, Vinay and Webson, Albert and Pope, Reiner}</span><span class="p">,</span>
      <span class="na">publisher</span> <span class="p">=</span> <span class="s">{Google DeepMind}</span><span class="p">,</span>
      <span class="na">howpublished</span> <span class="p">=</span> <span class="s">{Online}</span><span class="p">,</span>
      <span class="na">note</span> <span class="p">=</span> <span class="s">{Retrieved from https://jax-ml.github.io/scaling-book/}</span><span class="p">,</span>
      <span class="na">year</span> <span class="p">=</span> <span class="s">{2025}</span>
    <span class="p">}</span>
</code></pre><button aria-label="Copy code to clipboard" class="copy" type="button"><i class="fa-solid fa-clipboard"></i></button></div></div></div> </div> </div> </d-appendix> <d-bibliography src="/scaling-book/assets/bibliography/"></d-bibliography> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>
      let giscusTheme = determineComputedTheme();
      let giscusAttributes = {
        src: 'https://giscus.app/client.js',
        'data-repo': 'jax-ml/scaling-book',
        'data-repo-id': '',
        'data-category': 'General',
        'data-category-id': '',
        'data-mapping': 'title',
        'data-strict': '0',
        'data-reactions-enabled': '1',
        'data-emit-metadata': '0',
        'data-input-position': 'bottom',
        'data-theme': giscusTheme,
        'data-loading': '1',
        'data-lang': 'en',
        crossorigin: 'anonymous',
        async: '',
      };

      let giscusScript = document.createElement('script');
      Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
      document.getElementById('giscus_thread').appendChild(giscusScript);
    </script><script async="" crossorigin="anonymous" data-category="General" data-category-id="" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-loading="1" data-mapping="title" data-reactions-enabled="1" data-repo="jax-ml/scaling-book" data-repo-id="" data-strict="0" data-theme="light" src="https://giscus.app/client.js"></script><div class="giscus"><iframe allow="clipboard-write" class="giscus-frame giscus-frame--loading" scrolling="no" src="https://giscus.app/en/widget?origin=https%3A%2F%2Fjax-ml.github.io%2Fscaling-book%2Fjax-stuff%2F&amp;session=&amp;theme=light&amp;reactionsEnabled=1&amp;emitMetadata=0&amp;inputPosition=bottom&amp;repo=jax-ml%2Fscaling-book&amp;repoId=&amp;category=General&amp;categoryId=&amp;strict=0&amp;description=How+to+use+JAX+to+program+TPUs+efficiently%21+Much+of+this+section+is+taken+from+%3Ca+href%3D%27https%3A%2F%2Fjax.readthedocs.io%2Fen%2Flatest%2Fjep%2F14273-shard-map.html%27%3Ehere%3C%2Fa%3E.+You+can+run+the+code+examples+in+this+section+with+free+TPUs+on+%3Ca+href%3D%27https%3A%2F%2Fcolab.sandbox.google.com%2F%27%3EGoogle+Colab%3C%2Fa%3E.&amp;backLink=https%3A%2F%2Fjax-ml.github.io%2Fscaling-book%2Fjax-stuff%2F&amp;term=Programming+TPUs+in+JAX+%7C+How+To+Scale+Your+Model" style="opacity: 0;" title="Comments"></iframe></div> <noscript>è¯·å¯ç”¨ JavaScript ä»¥æŸ¥çœ‹ç”± giscus é©±åŠ¨çš„<a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">è¯„è®º</a>ã€‚ </noscript> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> Â© ç‰ˆæƒæ‰€æœ‰ 2025ã€‚ç”± <a href="https://jekyllrb.com/" rel="external nofollow noopener" target="_blank">Jekyll</a> å¼ºåŠ›é©±åŠ¨ï¼Œä½¿ç”¨ <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> ä¸»é¢˜ã€‚æ‰˜ç®¡äº <a href="https://pages.github.com/" rel="external nofollow noopener" target="_blank">GitHub Pages</a>ã€‚ </div> </footer> <script crossorigin="anonymous" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/bootstrap.bundle.min.js"></script> <script crossorigin="anonymous" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js"></script> <script crossorigin="anonymous" defer="" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script crossorigin="anonymous" defer="" id="MathJax-script" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" type="text/javascript"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/mathjax-setup.js?70d799092f862ad98c7876aa47712e20"></script> <script crossorigin="anonymous" defer="" src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script defer="" src="https://jax-ml.github.io/scaling-book/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="https://jax-ml.github.io/scaling-book/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script><div class="hidden" id="back-to-top"><svg viewbox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div> <div class="hiddendiv common"></div></body>
</html>